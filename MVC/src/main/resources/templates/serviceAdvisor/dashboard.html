<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Advisor Dashboard | Albany Service</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Styles */
        :root {
            /* Primary Colors */
            --primary-color: #722F37;
            --primary-light: #8A3A43;
            --primary-dark: #5A2329;
            --secondary-color: #EFFFBB;
            --secondary-light: #F1FF92;
            --secondary-dark: #C6D880;

            /* Neutral Colors */
            --white: #ffffff;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --gray: #6c757d;
            --dark-gray: #343a40;
            --black: #212529;

            /* Status Colors */
            --success: #38b000;
            --warning: #ffaa00;
            --danger: #d90429;
            --info: #4cc9f0;

            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 15px 25px rgba(0, 0, 0, 0.15);

            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
            --radius-xl: 24px;

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 48px;

            /* Transitions */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Baloo Bhaijaan 2', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: var(--dark-gray);
            background-color: var(--secondary-color);
            height: 100vh;
            overflow-x: hidden;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* App Container */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: linear-gradient(145deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: var(--spacing-lg) 0;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            box-shadow: var(--shadow-xl);
            transition: all var(--transition-normal);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--secondary-color);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-md) var(--spacing-lg);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-right: var(--spacing-md);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .user-info h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .user-info p {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .sidebar-nav {
            flex: 1;
            padding: 0 var(--spacing-md);
        }

        .nav-section {
            margin-bottom: var(--spacing-md);
        }

        .nav-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: var(--spacing-md) var(--spacing-lg);
            color: rgba(255, 255, 255, 0.6);
        }

        .sidebar-nav ul {
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: var(--spacing-xs);
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            color: var(--white);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }

        .sidebar-nav a:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-nav li.active a {
            background: var(--secondary-color);
            color: var(--primary-dark);
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar-nav i {
            margin-right: var(--spacing-md);
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: var(--spacing-lg);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-btn {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            color: var(--white);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .logout-btn i {
            margin-right: var(--spacing-md);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: var(--spacing-xl);
            transition: all var(--transition-normal);
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
        }

        .header-title h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }

        .header-subtitle {
            color: var(--gray);
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .date-display {
            background: var(--white);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            color: var(--gray);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-display i {
            color: var(--primary-color);
        }

        /* Dashboard Content */
        .dashboard-content {
            padding: 0;
        }

        /* Card Styles */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
            border: none;
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
        }

        .card-header {
            background: var(--white);
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .card-title i {
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .card-body {
            padding: var(--spacing-xl);
        }

        /* Search and Filter */
        .search-filter {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 1px solid var(--medium-gray);
            border-radius: 30px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all var(--transition-fast);
            color: var(--dark-gray);
            box-shadow: var(--shadow-sm);
            background-color: var(--white);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(114, 47, 55, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            cursor: pointer;
            transition: color var(--transition-fast);
        }

        .search-icon:hover {
            color: var(--primary-color);
        }

        .filter-dropdown {
            position: relative;
        }

        .filter-button {
            padding: 12px 20px;
            border: 1px solid var(--medium-gray);
            background: var(--white);
            border-radius: 30px;
            font-family: inherit;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--gray);
            box-shadow: var(--shadow-sm);
        }

        .filter-button:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .filter-button.active {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        .filter-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            width: 200px;
            z-index: 10;
            overflow: hidden;
            visibility: hidden;
            opacity: 0;
            transform: translateY(10px);
            transition: all var(--transition-fast);
        }

        .filter-menu.show {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        .filter-option {
            padding: 12px 20px;
            transition: all var(--transition-fast);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-option:hover {
            background: rgba(114, 47, 55, 0.05);
        }

        .filter-option.active {
            background: rgba(114, 47, 55, 0.1);
            color: var(--primary-color);
            font-weight: 500;
        }

        .filter-option i {
            font-size: 0.9rem;
            width: 20px;
            text-align: center;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin: 0 -1px;
            background-color: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .vehicles-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: var(--spacing-lg);
        }

        .vehicles-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--gray);
            background-color: rgba(248, 249, 250, 0.7);
            border-bottom: 2px solid var(--medium-gray);
            position: sticky;
            top: 0;
            z-index: 5;
            transition: all var(--transition-fast);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .vehicles-table th:first-child {
            border-top-left-radius: var(--radius-md);
        }

        .vehicles-table th:last-child {
            border-top-right-radius: var(--radius-md);
        }

        .vehicles-table tbody tr {
            transition: all var(--transition-fast);
            cursor: pointer;
            border-radius: var(--radius-md);
        }

        .vehicles-table tbody tr:hover {
            background-color: rgba(114, 47, 55, 0.03);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .vehicles-table td {
            padding: 16px;
            vertical-align: middle;
            border-bottom: 1px solid var(--medium-gray);
            transition: all var(--transition-fast);
        }

        .vehicles-table tbody tr:last-child td {
            border-bottom: none;
        }

        .vehicles-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: var(--radius-md);
        }

        .vehicles-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: var(--radius-md);
        }

        /* Vehicle and Customer Details */
        .vehicle-details, .customer-details {
            display: flex;
            flex-direction: column;
        }

        .vehicle-model {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--primary-dark);
            font-size: 1rem;
        }

        .vehicle-info, .customer-info {
            font-size: 0.9rem;
            color: var(--gray);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }

        .status-badge.new {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--info);
            border: 1px solid rgba(76, 201, 240, 0.2);
        }

        .status-badge.in-progress {
            background-color: rgba(255, 170, 0, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 170, 0, 0.2);
        }

        .status-badge.completed {
            background-color: rgba(56, 176, 0, 0.1);
            color: var(--success);
            border: 1px solid rgba(56, 176, 0, 0.2);
        }

        .status-badge i {
            font-size: 0.75rem;
        }

        /* Actions Column */
        .action-cell {
            text-align: center;
        }

        .action-btn {
            padding: 8px 12px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 30px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }

        .action-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .action-btn i {
            font-size: 0.8rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xxl) var(--spacing-xl);
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            color: var(--medium-gray);
        }

        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: var(--spacing-sm);
            color: var(--dark-gray);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: var(--spacing-xl);
        }

        .page-item {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-link {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--white);
            color: var(--dark-gray);
            border: 1px solid var(--medium-gray);
            transition: all var(--transition-fast);
            font-size: 0.9rem;
            text-decoration: none;
            box-shadow: var(--shadow-sm);
        }

        .page-link:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .page-item.active .page-link {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        .page-item.disabled .page-link {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
            overflow-y: auto;
            padding: var(--spacing-md);
        }

        .modal-backdrop.show {
            display: flex;
            animation: fadeIn 0.3s ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 85%;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
            color: var(--white);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: var(--spacing-xl);
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: var(--spacing-md) var(--spacing-xl);
            border-top: 1px solid var(--medium-gray);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            background: rgba(248, 249, 250, 0.7);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--medium-gray);
            margin-bottom: var(--spacing-xl);
            background-color: var(--white);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .tab {
            padding: var(--spacing-md) var(--spacing-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            border-bottom: 3px solid transparent;
            color: var(--gray);
            font-weight: 500;
            position: relative;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Two-column layout for service modal */
        .service-columns {
            display: flex;
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
        }

        .service-column {
            flex: 1;
        }

        .left-column {
            flex: 3;
        }

        .right-column {
            flex: 2;
            background-color: rgba(114, 47, 55, 0.08);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: var(--spacing-lg);
            align-self: flex-start;
            max-height: calc(90vh - 200px);
            overflow-y: auto;
            border: 1px solid rgba(114, 47, 55, 0.2);
        }

        /* Service Items */
        .vehicle-summary {
            background: var(--white);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vehicle-info-summary h4 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--primary-dark);
        }

        .vehicle-info-summary p {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .status-display {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--medium-gray);
        }

        .add-service-form {
            margin-bottom: var(--spacing-lg);
            background-color: var(--white);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-gray);
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all var(--transition-fast);
            background-color: var(--white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(114, 47, 55, 0.1);
        }

        .form-row {
            display: flex;
            gap: var(--spacing-md);
        }

        .form-col {
            flex: 1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
            box-shadow: 0 4px 10px rgba(114, 47, 55, 0.2);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(114, 47, 55, 0.3);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--dark-gray);
            border: 1px solid var(--medium-gray);
        }

        .btn-secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
            box-shadow: 0 4px 10px rgba(56, 176, 0, 0.2);
        }

        .btn-success:hover {
            background: #2d9000;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(56, 176, 0, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
            box-shadow: 0 4px 10px rgba(217, 4, 41, 0.2);
        }

        .btn-danger:hover {
            background: #b50020;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(217, 4, 41, 0.3);
        }

        /* Service Item List */
        .service-items-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: var(--spacing-lg);
            background-color: var(--white);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .service-items-table th {
            padding: 14px 16px;
            font-weight: 500;
            color: var(--gray);
            background: rgba(114, 47, 55, 0.05);
            text-align: left;
            font-size: 0.9rem;
            border-top: 1px solid var(--medium-gray);
            border-bottom: 1px solid var(--medium-gray);
        }

        .service-items-table th:first-child {
            border-left: 1px solid var(--medium-gray);
            border-top-left-radius: var(--radius-md);
        }

        .service-items-table th:last-child {
            border-right: 1px solid var(--medium-gray);
            border-top-right-radius: var(--radius-md);
        }

        .service-items-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--medium-gray);
            font-size: 0.95rem;
            vertical-align: middle;
        }

        .service-items-table tr:last-child td {
            border-bottom: 1px solid var(--medium-gray);
        }

        .service-items-table tr:last-child td:first-child {
            border-bottom-left-radius: var(--radius-md);
            border-left: 1px solid var(--medium-gray);
        }

        .service-items-table tr:last-child td:last-child {
            border-bottom-right-radius: var(--radius-md);
            border-right: 1px solid var(--medium-gray);
        }

        .service-items-table td:first-child {
            border-left: 1px solid var(--medium-gray);
        }

        .service-items-table td:last-child {
            border-right: 1px solid var(--medium-gray);
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light-gray);
            border: 1px solid var(--medium-gray);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .quantity-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .quantity-input {
            width: 40px;
            padding: 4px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 0.9rem;
        }

        .btn-remove {
            color: var(--danger);
            background: none;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            padding: 5px;
            border-radius: 50%;
        }

        .btn-remove:hover {
            background: rgba(217, 4, 41, 0.1);
        }

        /* Bill Summary */
        .bill-summary {
            background: rgba(255, 255, 255, 0.8);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(114, 47, 55, 0.15);
        }

        .bill-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .bill-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--medium-gray);
        }

        /* Labor Charge Section */
        .labor-section {
            background-color: var(--white);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
        }

        .labor-form {
            display: flex;
            gap: var(--spacing-md);
            align-items: flex-end;
        }

        .labor-list {
            margin-top: var(--spacing-md);
        }

        .labor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--medium-gray);
        }

        .labor-item:last-child {
            border-bottom: none;
        }

        .labor-details {
            flex: 1;
        }

        .labor-title {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .labor-subtitle {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .labor-price {
            font-weight: 500;
        }

        .labor-actions {
            margin-left: var(--spacing-md);
        }

        /* Success Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--radius-md);
            color: white;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1100;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.info {
            background: var(--info);
        }

        /* Vehicle Details Card */
        .detail-card {
            background: var(--white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
        }

        .detail-card-header {
            padding: 14px 20px;
            background: rgba(114, 47, 55, 0.05);
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 1rem;
            border-bottom: 1px solid var(--medium-gray);
        }

        .detail-card-body {
            padding: 20px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 10px;
        }

        .detail-label {
            width: 150px;
            font-weight: 500;
            color: var(--gray);
        }

        .detail-value {
            flex: 1;
        }

        /* Bill Generation Modal */
        .bill-preview {
            background: var(--white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            margin-top: var(--spacing-lg);
            overflow: hidden;
        }

        .bill-header {
            background: var(--primary-color);
            color: var(--white);
            padding: var(--spacing-lg);
            text-align: center;
        }

        .bill-company {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .bill-title {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .bill-info {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--medium-gray);
        }

        .bill-customer, .bill-service {
            flex: 1;
        }

        .bill-section-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-dark);
        }

        .bill-detail {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .bill-detail span {
            font-weight: 500;
        }

        .bill-items {
            padding: var(--spacing-lg);
        }

        .bill-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
        }

        .bill-table th {
            background-color: rgba(114, 47, 55, 0.05);
            padding: 10px;
            text-align: left;
            font-weight: 500;
        }

        .bill-table td {
            padding: 10px;
            border-bottom: 1px solid var(--medium-gray);
        }

        .bill-table tr:last-child td {
            border-bottom: none;
        }

        .bill-totals {
            padding: 0 var(--spacing-lg) var(--spacing-lg);
        }

        .bill-subtotal, .bill-tax {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .bill-grand-total {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 1.1rem;
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--medium-gray);
        }

        .bill-footer {
            padding: var(--spacing-lg);
            text-align: center;
            background-color: rgba(114, 47, 55, 0.05);
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* Responsive Styles */
        @media (max-width: 1200px) {
            .main-content {
                padding: var(--spacing-lg);
            }

            .modal-content {
                max-width: 95%;
            }

            .service-columns {
                flex-direction: column;
            }

            .right-column {
                position: relative;
                max-height: none;
                margin-top: var(--spacing-lg);
                width: 100%;
                align-self: stretch;
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
                padding: var(--spacing-md) 0;
            }

            .logo, .sidebar-header h2, .user-info, .sidebar-nav span, .logout-btn span, .nav-section-title {
                display: none;
            }

            .sidebar-user {
                justify-content: center;
                padding: var(--spacing-sm);
            }

            .user-avatar {
                margin-right: 0;
            }

            .sidebar-nav a {
                justify-content: center;
                padding: var(--spacing-md);
            }

            .sidebar-nav i {
                margin-right: 0;
                font-size: 1.3rem;
            }

            .sidebar-footer {
                padding: var(--spacing-md);
                display: flex;
                justify-content: center;
            }

            .logout-btn {
                justify-content: center;
                padding: var(--spacing-md);
            }

            .logout-btn i {
                margin-right: 0;
            }

            .main-content {
                margin-left: 80px;
            }

            .form-row {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
        }

        @media (max-width: 768px) {
            .main-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-md);
            }

            .search-filter {
                flex-direction: column;
                width: 100%;
            }

            .card-header {
                flex-direction: column;
                gap: var(--spacing-sm);
                align-items: flex-start;
            }

            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 5px;
            }

            .tab {
                padding: var(--spacing-sm) var(--spacing-md);
            }

            .labor-form {
                flex-direction: column;
                gap: var(--spacing-sm);
            }

            .bill-summary {
                margin-bottom: var(--spacing-lg);
            }
        }

        @media (max-width: 576px) {
            .main-content {
                padding: var(--spacing-md);
            }

            .card-body {
                padding: var(--spacing-md);
            }

            .modal-header, .modal-body, .modal-footer {
                padding: var(--spacing-md);
            }

            .vehicle-summary {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-md);
            }

            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .detail-row {
                flex-direction: column;
            }

            .detail-label {
                width: 100%;
                margin-bottom: 5px;
            }

            .bill-info {
                flex-direction: column;
                gap: var(--spacing-md);
            }
        }
    </style>
</head>
<body>
<div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">Albany</div>
        </div>

        <div class="sidebar-user">
            <div class="user-avatar">
                <span th:text="${#strings.substring(userName, 0, 1)}">J</span>
            </div>
            <div class="user-info">
                <h3 th:text="${userName}">John Smith</h3>
                <p>Service Advisor</p>
            </div>
        </div>

        <div class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <ul>
                    <li class="active"><a href="/serviceAdvisor/dashboard"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                </ul>
            </div>


        </div>

        <div class="sidebar-footer">
            <a href="/serviceAdvisor/logout" class="logout-btn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <header class="main-header">
            <div>
                <h1 class="header-title">Service Dashboard</h1>
                <p class="header-subtitle">Manage vehicle service assignments and service records</p>
            </div>
            <div class="header-actions">
                <div class="date-display">
                    <i class="far fa-calendar-alt"></i>
                    <span th:text="${#dates.format(#dates.createNow(), 'EEEE, MMMM d, yyyy')}">Wednesday, May 7, 2025</span>
                </div>
            </div>
        </header>

        <div class="dashboard-content">
            <!-- Vehicle Assignments Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-car"></i> Assigned Vehicles
                    </h2>
                    <div class="card-actions">
                        <button class="filter-button" id="filterButton">
                            <i class="fas fa-filter"></i> Filter
                            <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
                        </button>
                        <div class="filter-menu" id="filterMenu">
                            <div class="filter-option active" data-filter="all">
                                <i class="fas fa-list-ul"></i> All Vehicles
                            </div>
                            <div class="filter-option" data-filter="new">
                                <i class="fas fa-bolt"></i> New Assignments
                            </div>
                            <div class="filter-option" data-filter="in-progress">
                                <i class="fas fa-sync-alt"></i> In Progress
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="search-filter">
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Search vehicles, customers, or registration..." id="searchInput">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="vehicles-table">
                            <thead>
                            <tr>
                                <th>Vehicle</th>
                                <th>Customer</th>
                                <th>Service Type</th>
                                <th>Requested</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody id="vehiclesTableBody">
                            <!-- Example row 1 -->
                            <tr onclick="openVehicleDetails(1)">
                                <td>
                                    <div class="vehicle-details">
                                        <div class="vehicle-model">Honda Civic (2020)</div>
                                        <div class="vehicle-info">Registration: ABC-1234</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="customer-details">
                                        <div class="customer-name">John Smith</div>
                                        <div class="customer-info">john.smith@example.com</div>
                                    </div>
                                </td>
                                <td>General Service</td>
                                <td>May 5, 2025</td>
                                <td>
                                    <span class="status-badge new">
                                        <i class="fas fa-circle"></i> New
                                    </span>
                                </td>
                                <td class="action-cell">
                                    <button class="action-btn" onclick="openVehicleDetails(1); event.stopPropagation();">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                            </tr>

                            <!-- Example row 2 -->
                            <tr onclick="openVehicleDetails(2)">
                                <td>
                                    <div class="vehicle-details">
                                        <div class="vehicle-model">Toyota Camry (2019)</div>
                                        <div class="vehicle-info">Registration: XYZ-5678</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="customer-details">
                                        <div class="customer-name">Sarah Johnson</div>
                                        <div class="customer-info">sarah.j@example.com</div>
                                    </div>
                                </td>
                                <td>Oil Change, Wheel Alignment</td>
                                <td>May 3, 2025</td>
                                <td>
                                    <span class="status-badge in-progress">
                                        <i class="fas fa-circle"></i> In Progress
                                    </span>
                                </td>
                                <td class="action-cell">
                                    <button class="action-btn" onclick="openVehicleDetails(2); event.stopPropagation();">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                            </tr>

                            <!-- Example row 3 -->
                            <tr onclick="openVehicleDetails(3)">
                                <td>
                                    <div class="vehicle-details">
                                        <div class="vehicle-model">Ford Mustang (2018)</div>
                                        <div class="vehicle-info">Registration: DEF-9012</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="customer-details">
                                        <div class="customer-name">Michael Brown</div>
                                        <div class="customer-info">michael.b@example.com</div>
                                    </div>
                                </td>
                                <td>Engine Check, Brake Service</td>
                                <td>May 1, 2025</td>
                                <td>
                                    <span class="status-badge in-progress">
                                        <i class="fas fa-circle"></i> In Progress
                                    </span>
                                </td>
                                <td class="action-cell">
                                    <button class="action-btn" onclick="openVehicleDetails(3); event.stopPropagation();">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination">
                        <div class="page-item disabled">
                            <a class="page-link" href="#" aria-label="Previous">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </div>
                        <div class="page-item active"><a class="page-link" href="#">1</a></div>
                        <div class="page-item"><a class="page-link" href="#">2</a></div>
                        <div class="page-item"><a class="page-link" href="#">3</a></div>
                        <div class="page-item">
                            <a class="page-link" href="#" aria-label="Next">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Vehicle Details Modal -->
<div class="modal-backdrop" id="vehicleDetailsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-car"></i> Vehicle Service Details</h3>
            <button class="modal-close" id="closeVehicleDetailsModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="tabs">
                <div class="tab active" data-tab="details">Vehicle Details</div>
                <div class="tab" data-tab="service-items">Service Items</div>
                <div class="tab" data-tab="update-status">Update Status</div>
                <div class="tab" data-tab="generate-bill">Generate Bill</div>
            </div>

            <!-- Vehicle Details Tab -->
            <div class="tab-content active" id="details-tab">
                <div class="row">
                    <div class="detail-card">
                        <div class="detail-card-header">
                            Vehicle Information
                        </div>
                        <div class="detail-card-body">
                            <div class="detail-row">
                                <div class="detail-label">Make/Model:</div>
                                <div class="detail-value">Honda Civic</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Registration:</div>
                                <div class="detail-value">ABC-1234</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Year:</div>
                                <div class="detail-value">2020</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Type:</div>
                                <div class="detail-value">Sedan</div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <div class="detail-card-header">
                            Customer Information
                        </div>
                        <div class="detail-card-body">
                            <div class="detail-row">
                                <div class="detail-label">Name:</div>
                                <div class="detail-value">John Smith</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Email:</div>
                                <div class="detail-value">john.smith@example.com</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Phone:</div>
                                <div class="detail-value">(555) 123-4567</div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-card">
                        <div class="detail-card-header">
                            Service Request Details
                        </div>
                        <div class="detail-card-body">
                            <div class="detail-row">
                                <div class="detail-label">Service Type:</div>
                                <div class="detail-value">General Service</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Request Date:</div>
                                <div class="detail-value">May 5, 2025</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Status:</div>
                                <div class="detail-value">
                                    <span class="status-badge new">
                                        <i class="fas fa-circle"></i> New
                                    </span>
                                </div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Description:</div>
                                <div class="detail-value">Customer requested regular maintenance service. Vehicle is making a slight noise when braking.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Items Tab -->
            <div class="tab-content" id="service-items-tab">
                <div class="vehicle-summary">
                    <div class="vehicle-info-summary">
                        <h4>Honda Civic (ABC-1234)</h4>
                        <p>Customer: John Smith</p>
                    </div>
                    <div class="status-display">
                        <span class="status-badge new">
                            <i class="fas fa-circle"></i> New
                        </span>
                    </div>
                </div>

                <div class="service-columns">
                    <div class="service-column left-column">
                        <!-- Inventory Items Section -->
                        <div class="add-service-form">
                            <h4 class="section-title">Add Inventory Items</h4>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="inventoryItemSelect">Select Inventory Item:</label>
                                        <select class="form-control" id="inventoryItemSelect">
                                            <option value="">-- Select an item --</option>
                                            <option value="oil-filter">Oil Filter</option>
                                            <option value="air-filter">Air Filter</option>
                                            <option value="brake-pads">Brake Pads</option>
                                            <option value="engine-oil">Engine Oil (1L)</option>
                                            <option value="wiper-blades">Wiper Blades</option>
                                            <option value="spark-plugs">Spark Plugs</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col" style="max-width: 120px;">
                                    <div class="form-group">
                                        <label class="form-label" for="itemQuantity">Quantity:</label>
                                        <input type="number" class="form-control" id="itemQuantity" value="1" min="1">
                                    </div>
                                </div>
                                <div class="form-col" style="max-width: 120px; display: flex; align-items: flex-end;">
                                    <button class="btn btn-primary" id="addItemBtn" style="width: 100%;">
                                        <i class="fas fa-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Service Items List -->
                        <div id="inventoryItemsContainer">
                            <h4 class="section-title">Inventory Items</h4>
                            <table class="service-items-table" id="inventoryItemsTable">
                                <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Unit Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody id="inventoryItemsList">
                                <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Labor Charges Section -->
                        <div class="labor-section">
                            <h4 class="section-title">Labor Charges</h4>
                            <div class="labor-form">
                                <div class="form-group" style="flex: 2;">
                                    <label class="form-label" for="laborDescription">Description:</label>
                                    <input type="text" class="form-control" id="laborDescription" placeholder="E.g., Oil Change Labor">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label" for="laborHours">Hours:</label>
                                    <input type="number" class="form-control" id="laborHours" value="1" min="0.5" step="0.5">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label" for="laborRate">Rate ($/hr):</label>
                                    <input type="number" class="form-control" id="laborRate" value="65" min="1">
                                </div>
                                <button class="btn btn-primary" id="addLaborBtn">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div class="labor-list" id="laborChargesList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <div class="service-column right-column">
                        <h4 class="section-title">Service Bill Summary</h4>
                        <div class="bill-summary">
                            <div class="bill-row">
                                <span>Parts Subtotal:</span>
                                <span id="partsSubtotal">$0.00</span>
                            </div>
                            <div class="bill-row">
                                <span>Labor Subtotal:</span>
                                <span id="laborSubtotal">$0.00</span>
                            </div>
                            <div class="bill-row">
                                <span>Subtotal:</span>
                                <span id="subtotalAmount">$0.00</span>
                            </div>
                            <div class="bill-row">
                                <span>Tax (7%):</span>
                                <span id="taxAmount">$0.00</span>
                            </div>
                            <div class="bill-total">
                                <span>Total:</span>
                                <span id="totalAmount">$0.00</span>
                            </div>
                        </div>

                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn btn-success" style="flex: 1;" id="saveBillBtn">
                                <i class="fas fa-save"></i> Save Bill
                            </button>
                            <button class="btn btn-primary" style="flex: 1;" id="previewBillBtn">
                                <i class="fas fa-file-invoice"></i> Preview Bill
                            </button>
                        </div>

                        <div style="margin-top: 30px;">
                            <h4 class="section-title">Additional Notes</h4>
                            <div class="form-group">
                                <textarea class="form-control" id="serviceNotes" rows="4" placeholder="Add any additional notes about the service..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Update Tab -->
            <div class="tab-content" id="update-status-tab">
                <div class="vehicle-summary">
                    <div class="vehicle-info-summary">
                        <h4>Honda Civic (ABC-1234)</h4>
                        <p>Customer: John Smith</p>
                    </div>
                    <div class="status-display">
                        <span class="status-badge new" id="currentStatusBadge">
                            <i class="fas fa-circle"></i> New
                        </span>
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-card-header">
                        Update Service Status
                    </div>
                    <div class="detail-card-body">
                        <div class="form-group">
                            <label class="form-label" for="statusSelect">New Status:</label>
                            <select class="form-control" id="statusSelect">
                                <option value="Diagnosis">Diagnosis</option>
                                <option value="repair">Repair</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="statusNotes">Status Notes:</label>
                            <textarea class="form-control" id="statusNotes" rows="4" placeholder="Enter details about this status change..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="notifyCustomer">Notification:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notifyCustomer" checked>
                                <label class="form-check-label" for="notifyCustomer">
                                    Send status update notification to customer
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Status History:</label>
                            <div class="status-history">
                                <div class="status-history-item">
                                    <div class="status-history-badge new">New</div>
                                    <div class="status-history-details">
                                        <div class="status-history-date">May 5, 2025 - 10:23 AM</div>
                                        <div class="status-history-user">Created by: System</div>
                                        <div class="status-history-notes">Service request created</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-primary" id="updateStatusBtn">
                                <i class="fas fa-save"></i> Update Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generate Bill Tab -->
            <div class="tab-content" id="generate-bill-tab">
                <div class="bill-preview">
                    <div class="bill-header">
                        <div class="bill-company">Albany Automotive Services</div>
                        <div class="bill-title">Service Invoice</div>
                    </div>

                    <div class="bill-info">
                        <div class="bill-customer">
                            <div class="bill-section-title">Customer Information</div>
                            <div class="bill-detail"><span>Name:</span> John Smith</div>
                            <div class="bill-detail"><span>Email:</span> john.smith@example.com</div>
                            <div class="bill-detail"><span>Phone:</span> (555) 123-4567</div>
                        </div>

                        <div class="bill-service">
                            <div class="bill-section-title">Service Information</div>
                            <div class="bill-detail"><span>Vehicle:</span> Honda Civic (2020)</div>
                            <div class="bill-detail"><span>Registration:</span> ABC-1234</div>
                            <div class="bill-detail"><span>Invoice Date:</span> May 7, 2025</div>
                            <div class="bill-detail"><span>Invoice #:</span> INV-2025-0034</div>
                        </div>
                    </div>

                    <div class="bill-items">
                        <div class="bill-section-title">Service Items</div>
                        <table class="bill-table">
                            <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Amount</th>
                            </tr>
                            </thead>
                            <tbody id="billItemsList">
                            <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div class="bill-totals">
                        <div class="bill-subtotal">
                            <span>Subtotal:</span>
                            <span id="billSubtotal">$0.00</span>
                        </div>
                        <div class="bill-tax">
                            <span>Tax (7%):</span>
                            <span id="billTax">$0.00</span>
                        </div>
                        <div class="bill-grand-total">
                            <span>Total:</span>
                            <span id="billTotal">$0.00</span>
                        </div>
                    </div>

                    <div class="bill-footer">
                        Thank you for choosing Albany Automotive Services for your vehicle maintenance needs.
                    </div>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" id="downloadPdfBtn">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                    <button class="btn btn-success" id="sendToAdminBtn">
                        <i class="fas fa-user-tie"></i> Send to Admin
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="closeDetailsBtn">Close</button>
            <button class="btn btn-primary" id="saveServiceItemsBtn">Save</button>
            <button class="btn btn-success" id="markCompleteBtn">Mark as Complete</button>
        </div>
    </div>
</div>

<!-- Success Notification -->
<div class="notification success" id="successNotification">
    <i class="fas fa-check-circle"></i>
    <span id="notificationMessage">Operation completed successfully!</span>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize data structures
        window.inventoryPrices = {};
        window.inventoryItems = [];
        window.laborCharges = [];
        window.currentRequestId = null;

        // Set up token persistence
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        if (token) {
            sessionStorage.setItem('jwt-token', token);
            console.log('Token stored in session storage');
        }

        // Add auto-refresh button to header
        addRefreshButton();

        // Load initial data from server
        fetchAssignedVehicles();

        // Set up refresh interval (every 5 minutes)
        const refreshInterval = setInterval(fetchAssignedVehicles, 300000);

        // Initialize event listeners
        initializeEventListeners();

        // Initialize status update events
        initializeStatusEvents();

        // Show the appropriate buttons based on active tab
        updateModalFooterButtons();

        // Add connection status indicator
        addConnectionIndicator();
    });

    // Add refresh button to header
    function addRefreshButton() {
        const headerActions = document.querySelector('.header-actions');
        if (headerActions) {
            const refreshButton = document.createElement('button');
            refreshButton.className = 'btn btn-primary';
            refreshButton.innerHTML = '<i class="fas fa-sync"></i> Refresh';
            refreshButton.style.marginLeft = '10px';
            refreshButton.addEventListener('click', function() {
                fetchAssignedVehicles();
                showNotification('Refreshing vehicle data...', 'info');
            });
            headerActions.appendChild(refreshButton);
        }
    }

    // Add connection status indicator
    function addConnectionIndicator() {
        const header = document.querySelector('.main-header');
        if (header) {
            const statusIndicator = document.createElement('div');
            statusIndicator.id = 'connection-status';
            statusIndicator.style.display = 'flex';
            statusIndicator.style.alignItems = 'center';
            statusIndicator.style.marginLeft = 'auto';
            statusIndicator.style.gap = '5px';
            statusIndicator.innerHTML = `
            <span id="status-icon" class="status-indicator" style="width: 10px; height: 10px; border-radius: 50%; background-color: #ccc;"></span>
            <span id="status-text" style="font-size: 0.8rem; color: #666;">Checking connection...</span>
        `;

            const headerTitle = header.querySelector('.header-title');
            if (headerTitle) {
                header.insertBefore(statusIndicator, headerTitle.nextSibling);
            } else {
                header.appendChild(statusIndicator);
            }

            // Initial check
            checkApiConnection();

            // Check every 30 seconds
            setInterval(checkApiConnection, 30000);
        }
    }

    // Check API connection
    function checkApiConnection() {
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');

        if (!statusIcon || !statusText) return;

        const token = sessionStorage.getItem('jwt-token');
        const headers = {};
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        fetch('/serviceAdvisor/api/assigned-vehicles', {
            method: 'HEAD',
            headers: headers
        })
            .then(response => {
                if (response.ok) {
                    statusIcon.style.backgroundColor = '#38b000'; // Green
                    statusText.textContent = 'Connected';
                    statusText.style.color = '#38b000';
                } else {
                    statusIcon.style.backgroundColor = '#ffaa00'; // Yellow
                    statusText.textContent = 'Connected (Error: ' + response.status + ')';
                    statusText.style.color = '#ffaa00';
                }
            })
            .catch(error => {
                statusIcon.style.backgroundColor = '#d90429'; // Red
                statusText.textContent = 'Disconnected';
                statusText.style.color = '#d90429';
            });
    }

    // Initialize all event listeners
    function initializeEventListeners() {
        // Filter dropdown toggle
        const filterButton = document.getElementById('filterButton');
        const filterMenu = document.getElementById('filterMenu');

        if (filterButton && filterMenu) {
            filterButton.addEventListener('click', function() {
                filterMenu.classList.toggle('show');
            });

            // Hide filter menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!filterButton.contains(event.target) && !filterMenu.contains(event.target)) {
                    filterMenu.classList.remove('show');
                }
            });

            // Filter options
            const filterOptions = document.querySelectorAll('.filter-option');
            filterOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Update active class
                    filterOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');

                    // Apply filter
                    filterVehicles(this.getAttribute('data-filter'));

                    // Close menu
                    filterMenu.classList.remove('show');
                });
            });
        }

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterVehiclesBySearch(searchTerm);
            });
        }

        // Modal close buttons
        const closeVehicleDetailsModal = document.getElementById('closeVehicleDetailsModal');
        const closeDetailsBtn = document.getElementById('closeDetailsBtn');
        const vehicleDetailsModal = document.getElementById('vehicleDetailsModal');

        if (closeVehicleDetailsModal && vehicleDetailsModal) {
            closeVehicleDetailsModal.addEventListener('click', function() {
                vehicleDetailsModal.classList.remove('show');
            });
        }

        if (closeDetailsBtn && vehicleDetailsModal) {
            closeDetailsBtn.addEventListener('click', function() {
                vehicleDetailsModal.classList.remove('show');
            });
        }

        // Tab switching
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Show corresponding content
                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(content => content.classList.remove('active'));

                const tabName = this.getAttribute('data-tab');
                document.getElementById(`${tabName}-tab`).classList.add('active');

                // Update footer buttons
                updateModalFooterButtons();

                // If switching to generate-bill tab, update the bill preview
                if (tabName === 'generate-bill') {
                    updateBillPreview();
                }
            });
        });

        // Add inventory item button
        const addItemBtn = document.getElementById('addItemBtn');
        if (addItemBtn) {
            addItemBtn.addEventListener('click', function() {
                const inventoryItemSelect = document.getElementById('inventoryItemSelect');
                const itemQuantity = document.getElementById('itemQuantity');

                if (inventoryItemSelect.value) {
                    addInventoryItem(inventoryItemSelect.value, parseInt(itemQuantity.value) || 1);
                    inventoryItemSelect.value = ''; // Reset select
                    itemQuantity.value = '1'; // Reset quantity
                }
            });
        }

        // Add labor charge button
        const addLaborBtn = document.getElementById('addLaborBtn');
        if (addLaborBtn) {
            addLaborBtn.addEventListener('click', function() {
                const description = document.getElementById('laborDescription').value;
                const hours = parseFloat(document.getElementById('laborHours').value) || 0;
                const rate = parseFloat(document.getElementById('laborRate').value) || 0;

                if (description && hours > 0 && rate > 0) {
                    addLaborCharge(description, hours, rate);

                    // Reset form
                    document.getElementById('laborDescription').value = '';
                    document.getElementById('laborHours').value = '1';
                    document.getElementById('laborRate').value = '65';
                }
            });
        }

        // Save button
        const saveServiceItemsBtn = document.getElementById('saveServiceItemsBtn');
        if (saveServiceItemsBtn) {
            saveServiceItemsBtn.addEventListener('click', function() {
                const activeTab = document.querySelector('.tab.active');
                const tabName = activeTab.getAttribute('data-tab');

                if (tabName === 'service-items') {
                    saveServiceItems();
                } else if (tabName === 'generate-bill') {
                    generateBill();
                } else if (tabName === 'update-status') {
                    updateServiceStatus();
                }
            });
        }

        // Save bill button
        const saveBillBtn = document.getElementById('saveBillBtn');
        if (saveBillBtn) {
            saveBillBtn.addEventListener('click', function() {
                saveServiceItems();
            });
        }

        // Preview bill button
        const previewBillBtn = document.getElementById('previewBillBtn');
        if (previewBillBtn) {
            previewBillBtn.addEventListener('click', function() {
                // Switch to the generate-bill tab
                const generateBillTab = document.querySelector('.tab[data-tab="generate-bill"]');
                if (generateBillTab) {
                    generateBillTab.click();
                }
            });
        }

        // Download PDF button
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        if (downloadPdfBtn) {
            downloadPdfBtn.addEventListener('click', function() {
                downloadBillPdf();
            });
        }

        // Send to Admin button
        const sendToAdminBtn = document.getElementById('sendToAdminBtn');
        if (sendToAdminBtn) {
            sendToAdminBtn.addEventListener('click', function() {
                sendBillToAdmin();
            });
        }

        // Mark as complete button
        const markCompleteBtn = document.getElementById('markCompleteBtn');
        if (markCompleteBtn) {
            markCompleteBtn.addEventListener('click', function() {
                markServiceComplete();
            });
        }

        // Close modal when clicking outside
        const modalBackdrops = document.querySelectorAll('.modal-backdrop');
        modalBackdrops.forEach(backdrop => {
            backdrop.addEventListener('click', function(event) {
                if (event.target === this) {
                    this.classList.remove('show');
                }
            });
        });

        // Prevent click on modal content from closing the modal
        const modalContents = document.querySelectorAll('.modal-content');
        modalContents.forEach(content => {
            content.addEventListener('click', function(event) {
                event.stopPropagation();
            });
        });

        // Add ESC key event to close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                modalBackdrops.forEach(backdrop => {
                    backdrop.classList.remove('show');
                });
            }
        });
    }

    // Update modal footer buttons based on active tab
    function updateModalFooterButtons() {
        const saveServiceItemsBtn = document.getElementById('saveServiceItemsBtn');
        const markCompleteBtn = document.getElementById('markCompleteBtn');
        const activeTab = document.querySelector('.tab.active');

        if (saveServiceItemsBtn && markCompleteBtn && activeTab) {
            const tabName = activeTab.getAttribute('data-tab');

            if (tabName === 'service-items') {
                saveServiceItemsBtn.style.display = 'block';
                markCompleteBtn.style.display = 'block';
                saveServiceItemsBtn.textContent = 'Save';
            } else if (tabName === 'generate-bill') {
                saveServiceItemsBtn.style.display = 'block';
                markCompleteBtn.style.display = 'block';
                saveServiceItemsBtn.textContent = 'Finalize Bill';
            } else if (tabName === 'update-status') {
                saveServiceItemsBtn.style.display = 'block';
                markCompleteBtn.style.display = 'none';
                saveServiceItemsBtn.textContent = 'Save Status';
            } else {
                saveServiceItemsBtn.style.display = 'none';
                markCompleteBtn.style.display = 'none';
            }
        }
    }

    function getAuthToken() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token') || sessionStorage.getItem('jwt-token');
        return token;
    }

    function createAuthHeaders() {
        const token = getAuthToken();
        const headers = {
            'Content-Type': 'application/json'
        };

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        return headers;
    }

    // Track the number of retries
    let fetchRetries = 0;
    const MAX_RETRIES = 3;

    function fetchAssignedVehicles() {
        // Get token from URL parameter or session storage
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token') || sessionStorage.getItem('jwt-token');

        // Set up headers with token
        const headers = {};
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
            // Store token in session storage for future use
            sessionStorage.setItem('jwt-token', token);
        }

        console.log('Fetching assigned vehicles with token:', token ? token.substring(0, 10) + '...' : 'none');

        // Show loading indicator
        const tableBody = document.getElementById('vehiclesTableBody');
        if (tableBody) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                    <p>Loading assigned vehicles...</p>
                </td>
            </tr>
        `;
        }

        // Use the correct endpoint that matches the backend
        fetch('/serviceAdvisor/api/assigned-vehicles', {
            method: 'GET',
            headers: headers
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received vehicles data:', data);
                if (Array.isArray(data)) {
                    // Reset retries on success
                    fetchRetries = 0;
                    updateVehiclesTable(data);
                } else {
                    throw new Error('Invalid data format: expected an array');
                }
            })
            .catch(error => {
                console.error('Error fetching assigned vehicles:', error);

                // Try a few times before falling back to dummy data
                if (fetchRetries < MAX_RETRIES) {
                    fetchRetries++;
                    console.log(`Retrying fetch... attempt ${fetchRetries}/${MAX_RETRIES}`);
                    setTimeout(fetchAssignedVehicles, 1000); // Retry after 1 second
                    showNotification(`Retrying to load data (${fetchRetries}/${MAX_RETRIES})...`, 'info');
                } else {
                    showNotification('Error loading assigned vehicles: ' + error.message, 'error');
                    loadDummyData(); // Only fall back after MAX_RETRIES attempts
                }
            });
    }

    function loadDummyData() {
        console.warn("Loading dummy data as a fallback. This should only happen if the API is unavailable.");
        showNotification("Unable to connect to server, showing placeholder data", "warning");

        // Example dummy data for testing when API is unavailable
        const dummyVehicles = [
            {
                requestId: 1,
                vehicleName: "Honda Civic (2020)",
                registrationNumber: "ABC-1234",
                customerName: "John Smith",
                customerEmail: "john.smith@example.com",
                serviceType: "General Service",
                startDate: "2025-05-05",
                status: "Diagnosis"
            },
            {
                requestId: 2,
                vehicleName: "Toyota Camry (2019)",
                registrationNumber: "XYZ-5678",
                customerName: "Sarah Johnson",
                customerEmail: "sarah.j@example.com",
                serviceType: "Oil Change, Wheel Alignment",
                startDate: "2025-05-03",
                status: "Repair"
            },
            {
                requestId: 3,
                vehicleName: "Ford Mustang (2018)",
                registrationNumber: "DEF-9012",
                customerName: "Michael Brown",
                customerEmail: "michael.b@example.com",
                serviceType: "Engine Check, Brake Service",
                startDate: "2025-05-01",
                status: "Diagnosis"
            }
        ];

        updateVehiclesTable(dummyVehicles);
    }

    // Update the vehicles table with data from server
    function updateVehiclesTable(vehicles) {
        const tableBody = document.getElementById('vehiclesTableBody');
        if (!tableBody) return;

        // Clear existing rows
        tableBody.innerHTML = '';

        if (!vehicles || vehicles.length === 0) {
            // No vehicles found - show empty state
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
            <td colspan="6" class="empty-state">
                <i class="fas fa-car-alt"></i>
                <h3>No vehicles assigned</h3>
                <p>You don't have any active service requests assigned to you at the moment.</p>
            </td>
        `;
            tableBody.appendChild(emptyRow);
            return;
        }

        // Add rows for each vehicle
        vehicles.forEach((vehicle, index) => {
            const row = document.createElement('tr');
            row.setAttribute('data-id', vehicle.requestId);
            row.onclick = function() {
                openVehicleDetails(vehicle.requestId);
            };

            // Format date
            let formattedDate = 'N/A';
            if (vehicle.startDate) {
                const requestDate = new Date(vehicle.startDate);
                formattedDate = requestDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            }

            // Status badge class
            let statusClass = 'new';
            let statusText = vehicle.status || 'New';

            // Normalize status for display
            if (statusText.toLowerCase() === 'diagnosis' ||
                statusText.toLowerCase() === 'repair' ||
                statusText.toLowerCase() === 'in progress') {
                statusClass = 'in-progress';
                if (statusText.toLowerCase() === 'diagnosis') {
                    statusText = 'Diagnosis';
                } else if (statusText.toLowerCase() === 'repair') {
                    statusText = 'Repair';
                } else {
                    statusText = 'In Progress';
                }
            } else if (statusText.toLowerCase() === 'received' ||
                statusText.toLowerCase() === 'new') {
                statusClass = 'new';
                statusText = 'New';
            }

            // Safe access to properties with fallbacks
            const vehicleName = vehicle.vehicleName ||
                `${vehicle.vehicleBrand || ''} ${vehicle.vehicleModel || ''}`.trim() ||
                'Unknown Vehicle';
            const registrationNumber = vehicle.registrationNumber || 'No Registration';
            const customerName = vehicle.customerName || 'Unknown Customer';
            const customerEmail = vehicle.customerEmail || 'No Email';
            const serviceType = vehicle.serviceType || 'General Service';

            row.innerHTML = `
            <td>
                <div class="vehicle-details">
                    <div class="vehicle-model">${vehicleName}</div>
                    <div class="vehicle-info">Registration: ${registrationNumber}</div>
                </div>
            </td>
            <td>
                <div class="customer-details">
                    <div class="customer-name">${customerName}</div>
                    <div class="customer-info">${customerEmail}</div>
                </div>
            </td>
            <td>${serviceType}</td>
            <td>${formattedDate}</td>
            <td>
                <span class="status-badge ${statusClass}">
                    <i class="fas fa-circle"></i> ${statusText}
                </span>
            </td>
            <td class="action-cell">
                <button class="action-btn" onclick="openVehicleDetails(${vehicle.requestId}); event.stopPropagation();">
                    <i class="fas fa-eye"></i> View
                </button>
            </td>
        `;

            tableBody.appendChild(row);
        });
    }

    // Open vehicle details modal
    function openVehicleDetails(requestId) {
        console.log('Opening details for service request ID:', requestId);
        window.currentRequestId = requestId;

        // Show loading indicator in the modal
        const vehicleDetailsModal = document.getElementById('vehicleDetailsModal');
        vehicleDetailsModal.classList.add('show');

        const detailsTab = document.getElementById('details-tab');
        if (detailsTab) {
            detailsTab.innerHTML = `
            <div style="text-align: center; padding: 50px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 20px;"></i>
                <p>Loading service details...</p>
            </div>
        `;
        }

        // Reset tab to details tab
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => tab.classList.remove('active'));
        document.querySelector('.tab[data-tab="details"]').classList.add('active');

        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.remove('active'));
        document.getElementById('details-tab').classList.add('active');

        // Update footer buttons
        updateModalFooterButtons();

        // Get authentication token
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token') || sessionStorage.getItem('jwt-token');

        // Set up headers
        const headers = {};
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        // Fetch vehicle details from server using proper endpoint
        fetch(`/serviceAdvisor/api/service-details/${requestId}`, {
            method: 'GET',
            headers: headers
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to fetch service details: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received service details:', data);

                // Load vehicle details
                loadVehicleDetails(data);

                // Load current bill data if available
                if (data.currentBill) {
                    loadCurrentBill(data.currentBill);
                }

                // Load service history if available
                if (data.serviceHistory) {
                    loadServiceHistory(data.serviceHistory);
                }

                // Load and populate inventory items dropdown
                fetchInventoryItems();
            })
            .catch(error => {
                console.error('Error fetching vehicle details:', error);
                showNotification('Error loading service details: ' + error.message, 'error');

                // Show error in the details tab
                if (detailsTab) {
                    detailsTab.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                        <h3>Error Loading Details</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="openVehicleDetails(${requestId})">
                            <i class="fas fa-sync"></i> Retry
                        </button>
                    </div>
                `;
                }
            });
    }

    // Load vehicle details into the UI
    function loadVehicleDetails(data) {
        // Safety check
        if (!data) {
            console.error('No data provided to loadVehicleDetails');
            return;
        }

        try {
            // Create the detail cards if they don't exist yet
            createDetailCardsIfNeeded();

            // Vehicle Information
            const vehicleCard = document.querySelector('.detail-card:nth-of-type(1)');
            if (vehicleCard) {
                const makeModel = `${data.vehicleBrand || ''} ${data.vehicleModel || ''}`.trim();
                setDetailValue(vehicleCard, 1, makeModel || 'Not specified');
                setDetailValue(vehicleCard, 2, data.registrationNumber || 'Not specified');
                setDetailValue(vehicleCard, 3, data.vehicleYear || 'Not specified');
                setDetailValue(vehicleCard, 4, data.vehicleType || 'Not specified');
            }

            // Customer Information
            const customerCard = document.querySelector('.detail-card:nth-of-type(2)');
            if (customerCard) {
                setDetailValue(customerCard, 1, data.customerName || 'Not specified');
                setDetailValue(customerCard, 2, data.customerEmail || 'Not specified');
                setDetailValue(customerCard, 3, data.customerPhone || 'Not specified');
            }

            // Service Request Details
            const serviceCard = document.querySelector('.detail-card:nth-of-type(3)');
            if (serviceCard) {
                setDetailValue(serviceCard, 1, data.serviceType || 'General Service');

                // Format date
                let formattedDate = 'Not specified';
                if (data.requestDate) {
                    const requestDate = new Date(data.requestDate);
                    formattedDate = requestDate.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                }
                setDetailValue(serviceCard, 2, formattedDate);

                // Status badge
                const statusCell = serviceCard.querySelector('.detail-value:nth-of-type(3)');
                if (statusCell) {
                    const status = data.status || 'New';
                    let statusClass = getStatusClass(status);

                    statusCell.innerHTML = `
                    <span class="status-badge ${statusClass}">
                        <i class="fas fa-circle"></i> ${status}
                    </span>
                `;
                }

                // Description
                setDetailValue(serviceCard, 4, data.additionalDescription || 'No additional description provided.');
            }

            // Update vehicle summary in other tabs
            const vehicleSummaryElements = document.querySelectorAll('.vehicle-summary .vehicle-info-summary h4');
            const vehicleInfo = `${data.vehicleBrand || ''} ${data.vehicleModel || ''} (${data.registrationNumber || 'Unknown'})`.trim();
            vehicleSummaryElements.forEach(element => {
                element.textContent = vehicleInfo;
            });

            // Update customer info in summary
            const customerElements = document.querySelectorAll('.vehicle-summary .vehicle-info-summary p');
            customerElements.forEach(element => {
                element.textContent = `Customer: ${data.customerName || 'Unknown'}`;
            });

            // Update status badges in other tabs
            const statusDisplayElements = document.querySelectorAll('.vehicle-summary .status-display');
            const status = data.status || 'New';
            let statusClass = getStatusClass(status);

            statusDisplayElements.forEach(element => {
                element.innerHTML = `
                <span class="status-badge ${statusClass}" id="currentStatusBadge">
                    <i class="fas fa-circle"></i> ${status}
                </span>
            `;
            });

            // Update status dropdown
            const statusSelect = document.getElementById('statusSelect');
            if (statusSelect) {
                // Set current status as value
                for (let i = 0; i < statusSelect.options.length; i++) {
                    if (statusSelect.options[i].value.toLowerCase() === status.toLowerCase()) {
                        statusSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        } catch (error) {
            console.error('Error loading vehicle details:', error);
            showNotification('Error displaying vehicle details', 'error');
        }
    }

    // Create detail cards if they don't exist
    function createDetailCardsIfNeeded() {
        const detailsTab = document.getElementById('details-tab');
        if (!detailsTab) return;

        // Check if detail cards already exist
        if (detailsTab.querySelector('.detail-card')) return;

        // Create row for cards
        const row = document.createElement('div');
        row.className = 'row';

        // Vehicle Information Card
        const vehicleCard = document.createElement('div');
        vehicleCard.className = 'detail-card';
        vehicleCard.innerHTML = `
        <div class="detail-card-header">
            Vehicle Information
        </div>
        <div class="detail-card-body">
            <div class="detail-row">
                <div class="detail-label">Make/Model:</div>
                <div class="detail-value">Loading...</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Registration:</div>
                <div class="detail-value">Loading...</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Year:</div>
                <div class="detail-value">Loading...</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Type:</div>
                <div class="detail-value">Loading...</div>
            </div>
        </div>
    `;

        // Customer Information Card
        const customerCard = document.createElement('div');
        customerCard.className = 'detail-card';
        customerCard.innerHTML = `
        <div class="detail-card-header">
            Customer Information
        </div>
        <div class="detail-card-body">
            <div class="detail-row">
                <div class="detail-label">Name:</div>
                <div class="detail-value">Loading...</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Email:</div>
                <div class="detail-value">Loading...</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Phone:</div>
                <div class="detail-value">Loading...</div>
            </div>
        </div>
    `;

        // Service Request Card
        const serviceCard = document.createElement('div');
        serviceCard.className = 'detail-card';
        serviceCard.innerHTML = `
        <div class="detail-card-header">
            Service Request Details
        </div>
        <div class="detail-card-body">
            <div class="detail-row">
                <div class="detail-label">Service Type:</div>
                <div class="detail-value">Loading...</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Request Date:</div>
                <div class="detail-value">Loading...</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Status:</div>
                <div class="detail-value">
                    <span class="status-badge new">
                        <i class="fas fa-circle"></i> Loading...
                    </span>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Description:</div>
                <div class="detail-value">Loading...</div>
            </div>
        </div>
    `;

        // Add cards to row
        row.appendChild(vehicleCard);
        row.appendChild(customerCard);
        row.appendChild(serviceCard);

        // Add row to tab
        detailsTab.innerHTML = '';
        detailsTab.appendChild(row);
    }

    // Helper function to set detail value safely
    function setDetailValue(cardElement, index, value) {
        const valueElement = cardElement.querySelector(`.detail-value:nth-of-type(${index})`);
        if (valueElement) {
            valueElement.textContent = value;
        }
    }

    // Helper function to get status class based on status string
    function getStatusClass(status) {
        const statusLower = status.toLowerCase();
        if (statusLower === 'completed') {
            return 'completed';
        } else if (statusLower === 'diagnosis' || statusLower === 'repair') {
            return 'in-progress';
        } else {
            return 'new';
        }
    }

    // Load service history
    function loadServiceHistory(history) {
        const historyContainer = document.querySelector('.status-history');
        if (!historyContainer) return;

        historyContainer.innerHTML = '';

        if (!history || history.length === 0) {
            historyContainer.innerHTML = '<div class="empty-state">No status history available</div>';
            return;
        }

        try {
            // Sort history by timestamp (newest first)
            history.sort((a, b) => {
                // Handle potential invalid dates gracefully
                let dateA = new Date(a.timestamp || 0);
                let dateB = new Date(b.timestamp || 0);
                return dateB - dateA;
            });

            history.forEach(item => {
                // Default values if data is missing
                const status = item.status || 'Unknown';
                const updatedBy = item.updatedBy || 'System';
                const notes = item.workDescription || 'No notes provided';

                let formattedDate = 'Unknown date';
                try {
                    if (item.timestamp) {
                        const timestamp = new Date(item.timestamp);
                        formattedDate = timestamp.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        });
                    }
                } catch (e) {
                    console.warn('Invalid date format in history:', item.timestamp);
                }

                // Status badge class
                let statusClass = getStatusClass(status);

                const historyItem = document.createElement('div');
                historyItem.className = 'status-history-item';
                historyItem.innerHTML = `
                <div class="status-history-badge ${statusClass}">${status}</div>
                <div class="status-history-details">
                    <div class="status-history-date">${formattedDate}</div>
                    <div class="status-history-user">Updated by: ${updatedBy}</div>
                    <div class="status-history-notes">${notes}</div>
                </div>
            `;

                historyContainer.appendChild(historyItem);
            });
        } catch (error) {
            console.error('Error loading service history:', error);
            historyContainer.innerHTML = '<div class="empty-state">Error loading history data</div>';
        }
    }

    // Load current bill data
    function loadCurrentBill(billData) {
        if (!billData) {
            console.warn('No bill data provided');
            return;
        }

        try {
            // Clear existing data
            window.inventoryItems = [];
            window.laborCharges = [];

            // Load materials with proper error handling
            if (billData.materials && Array.isArray(billData.materials)) {
                billData.materials.forEach(item => {
                    if (item && item.itemId) {
                        window.inventoryItems.push({
                            key: item.itemId,
                            name: item.name || `Item ${item.itemId}`,
                            price: parseFloat(item.unitPrice) || 0,
                            quantity: parseInt(item.quantity) || 1
                        });
                    }
                });
            }

            // Load labor charges with proper error handling
            if (billData.laborCharges && Array.isArray(billData.laborCharges)) {
                billData.laborCharges.forEach(charge => {
                    if (charge) {
                        window.laborCharges.push({
                            description: charge.description || 'Labor charge',
                            hours: parseFloat(charge.hours) || 0,
                            rate: parseFloat(charge.ratePerHour) || 0
                        });
                    }
                });
            }

            // Render items and charges
            renderInventoryItems();
            renderLaborCharges();

            // Update bill summary with safe parsing
            const formatCurrency = (value) => {
                const num = parseFloat(value) || 0;
                return `$${num.toFixed(2)}`;
            };

            document.getElementById('partsSubtotal').textContent = formatCurrency(billData.partsSubtotal);
            document.getElementById('laborSubtotal').textContent = formatCurrency(billData.laborSubtotal);
            document.getElementById('subtotalAmount').textContent = formatCurrency(billData.subtotal);
            document.getElementById('taxAmount').textContent = formatCurrency(billData.tax);
            document.getElementById('totalAmount').textContent = formatCurrency(billData.total);

            // Update service notes
            const serviceNotesTextarea = document.getElementById('serviceNotes');
            if (serviceNotesTextarea && billData.notes) {
                serviceNotesTextarea.value = billData.notes;
            }
        } catch (error) {
            console.error('Error loading bill data:', error);
            showNotification('Error loading bill information', 'error');
        }
    }

    // Fetch inventory items for dropdown
    function fetchInventoryItems() {
        // Get token from URL parameter or session storage
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Set up headers
        const headers = {};
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        return fetch('/serviceAdvisor/api/inventory-items', {
            method: 'GET',
            headers: headers
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                populateInventoryDropdown(data);
                return data;
            })
            .catch(error => {
                console.error('Error fetching inventory items:', error);

                // Fallback to dummy data if API not implemented yet
                const dummyData = [
                    { itemId: 'oil-filter', name: 'Oil Filter', currentStock: 50, unitPrice: 15.99 },
                    { itemId: 'air-filter', name: 'Air Filter', currentStock: 30, unitPrice: 24.99 },
                    { itemId: 'brake-pads', name: 'Brake Pads', currentStock: 20, unitPrice: 89.99 },
                    { itemId: 'engine-oil', name: 'Engine Oil (1L)', currentStock: 100, unitPrice: 12.99 },
                    { itemId: 'wiper-blades', name: 'Wiper Blades', currentStock: 40, unitPrice: 19.99 },
                    { itemId: 'spark-plugs', name: 'Spark Plugs', currentStock: 80, unitPrice: 8.99 }
                ];
                populateInventoryDropdown(dummyData);
                return dummyData;
            });
    }

    // Populate inventory dropdown
    function populateInventoryDropdown(items) {
        const inventorySelect = document.getElementById('inventoryItemSelect');
        if (!inventorySelect) return;

        // Clear existing options except first one
        while (inventorySelect.options.length > 1) {
            inventorySelect.remove(1);
        }

        // Update inventory prices map
        window.inventoryPrices = {};

        // Add options
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.itemId;
            option.textContent = `${item.name} - $${item.unitPrice.toFixed(2)} (${item.currentStock} in stock)`;
            inventorySelect.appendChild(option);

            // Store price in inventory prices map
            window.inventoryPrices[item.itemId] = item.unitPrice;
        });
    }

    // Filter vehicles by status
    function filterVehicles(filter) {
        const rows = document.querySelectorAll('#vehiclesTableBody tr');

        rows.forEach(row => {
            const statusBadge = row.querySelector('.status-badge');
            if (!statusBadge) {
                row.style.display = filter === 'all' ? '' : 'none';
                return;
            }

            const status = statusBadge.textContent.trim().toLowerCase();

            if (filter === 'all') {
                row.style.display = '';
            } else if (filter === 'new' && (status.includes('new') || status.includes('received'))) {
                row.style.display = '';
            } else if (filter === 'in-progress' && (status.includes('diagnosis') || status.includes('repair') || status.includes('in progress'))) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Update filter button text
        const filterButton = document.getElementById('filterButton');
        if (filterButton) {
            if (filter === 'all') {
                filterButton.innerHTML = '<i class="fas fa-filter"></i> All Vehicles <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>';
            } else if (filter === 'new') {
                filterButton.innerHTML = '<i class="fas fa-filter"></i> New Assignments <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>';
            } else if (filter === 'in-progress') {
                filterButton.innerHTML = '<i class="fas fa-filter"></i> In Progress <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>';
            }
        }
    }

    // Filter vehicles by search term
    function filterVehiclesBySearch(searchTerm) {
        const rows = document.querySelectorAll('#vehiclesTableBody tr');

        rows.forEach(row => {
            const textContent = row.textContent.toLowerCase();

            if (textContent.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Add inventory item
    function addInventoryItem(itemKey, quantity = 1) {
        // Check if item ID exists
        if (!itemKey) return;

        // Find item name by making a dummy request to the server or use local map
        const itemName = itemKey; // This would be replaced by actual item name from server
        const price = window.inventoryPrices[itemKey] || 0;

        // Check if item already exists in the inventory items array
        const existingItemIndex = window.inventoryItems.findIndex(item => item.key === itemKey);

        if (existingItemIndex >= 0) {
            // Update quantity
            window.inventoryItems[existingItemIndex].quantity += quantity;
        } else {
            // Add new item
            window.inventoryItems.push({
                key: itemKey,
                name: itemName,
                price: price,
                quantity: quantity
            });
        }

        renderInventoryItems();
        updateBillSummary();
    }

    // Render inventory items
    function renderInventoryItems() {
        const inventoryItemsList = document.getElementById('inventoryItemsList');
        if (!inventoryItemsList) return;

        inventoryItemsList.innerHTML = '';

        if (window.inventoryItems.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
            <td colspan="5" style="text-align: center; padding: 20px;">
                No inventory items added yet.
            </td>
        `;
            inventoryItemsList.appendChild(emptyRow);
            return;
        }

        window.inventoryItems.forEach((item, index) => {
            const row = document.createElement('tr');
            const total = item.price * item.quantity;

            row.innerHTML = `
            <td>${item.name}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td>
                <div class="quantity-control">
                    <button class="quantity-btn" onclick="decrementInventoryQuantity(${index})">-</button>
                    <input type="number" class="quantity-input" value="${item.quantity}" min="1" data-index="${index}" onchange="updateInventoryQuantity(this)">
                    <button class="quantity-btn" onclick="incrementInventoryQuantity(${index})">+</button>
                </div>
            </td>
            <td>$${total.toFixed(2)}</td>
            <td style="text-align: center;">
                <button class="btn-remove" onclick="removeInventoryItem(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;

            inventoryItemsList.appendChild(row);
        });
    }

    // Increment inventory quantity
    function incrementInventoryQuantity(index) {
        window.inventoryItems[index].quantity++;
        renderInventoryItems();
        updateBillSummary();
    }

    // Decrement inventory quantity
    function decrementInventoryQuantity(index) {
        if (window.inventoryItems[index].quantity > 1) {
            window.inventoryItems[index].quantity--;
            renderInventoryItems();
            updateBillSummary();
        }
    }

    // Update inventory quantity
    function updateInventoryQuantity(input) {
        const index = parseInt(input.getAttribute('data-index'));
        const quantity = parseInt(input.value) || 1;

        if (quantity > 0) {
            window.inventoryItems[index].quantity = quantity;
            renderInventoryItems();
            updateBillSummary();
        }
    }

    // Remove inventory item
    function removeInventoryItem(index) {
        window.inventoryItems.splice(index, 1);
        renderInventoryItems();
        updateBillSummary();
    }

    // Add labor charge
    function addLaborCharge(description, hours, rate) {
        window.laborCharges.push({
            description: description,
            hours: hours,
            rate: rate
        });

        renderLaborCharges();
        updateBillSummary();
    }

    // Render labor charges
    function renderLaborCharges() {
        const laborChargesList = document.getElementById('laborChargesList');
        if (!laborChargesList) return;

        laborChargesList.innerHTML = '';

        if (window.laborCharges.length === 0) {
            laborChargesList.innerHTML = '<div style="padding: 10px 0; color: var(--gray);">No labor charges added yet.</div>';
            return;
        }

        window.laborCharges.forEach((charge, index) => {
            const laborItem = document.createElement('div');
            laborItem.className = 'labor-item';

            const total = charge.hours * charge.rate;

            laborItem.innerHTML = `
            <div class="labor-details">
                <div class="labor-title">${charge.description}</div>
                <div class="labor-subtitle">${charge.hours} hours @ $${charge.rate.toFixed(2)}/hr</div>
            </div>
            <div class="labor-price">$${total.toFixed(2)}</div>
            <div class="labor-actions">
                <button class="btn-remove" onclick="removeLaborCharge(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

            laborChargesList.appendChild(laborItem);
        });
    }

    // Remove labor charge
    function removeLaborCharge(index) {
        window.laborCharges.splice(index, 1);
        renderLaborCharges();
        updateBillSummary();
    }

    // Update bill summary
    function updateBillSummary() {
        // Calculate parts subtotal
        let partsSubtotal = 0;
        window.inventoryItems.forEach(item => {
            partsSubtotal += item.price * item.quantity;
        });

        // Calculate labor subtotal
        let laborSubtotal = 0;
        window.laborCharges.forEach(charge => {
            laborSubtotal += charge.hours * charge.rate;
        });

        // Calculate totals
        const subtotal = partsSubtotal + laborSubtotal;
        const tax = subtotal * 0.07; // 7% tax
        const total = subtotal + tax;

        // Update the display
        document.getElementById('partsSubtotal').textContent = `$${partsSubtotal.toFixed(2)}`;
        document.getElementById('laborSubtotal').textContent = `$${laborSubtotal.toFixed(2)}`;
        document.getElementById('subtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('taxAmount').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
    }

    // Update bill preview
    function updateBillPreview() {
        // Update the bill items table
        const billItemsList = document.getElementById('billItemsList');
        if (!billItemsList) return;

        billItemsList.innerHTML = '';

        // Add inventory items
        window.inventoryItems.forEach(item => {
            const row = document.createElement('tr');
            const total = item.price * item.quantity;

            row.innerHTML = `
            <td>${item.name} (Parts)</td>
            <td>${item.quantity}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td>$${total.toFixed(2)}</td>
        `;

            billItemsList.appendChild(row);
        });

        // Add labor charges
        window.laborCharges.forEach(charge => {
            const row = document.createElement('tr');
            const total = charge.hours * charge.rate;

            row.innerHTML = `
            <td>${charge.description} (Labor)</td>
            <td>${charge.hours} hrs</td>
            <td>$${charge.rate.toFixed(2)}/hr</td>
            <td>$${total.toFixed(2)}</td>
        `;

            billItemsList.appendChild(row);
        });

        // If no items, show message
        if (window.inventoryItems.length === 0 && window.laborCharges.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td colspan="4" style="text-align: center; padding: 20px;">
                No service items added yet.
            </td>
        `;
            billItemsList.appendChild(row);
        }

        // Calculate totals
        let subtotal = 0;
        window.inventoryItems.forEach(item => {
            subtotal += item.price * item.quantity;
        });

        window.laborCharges.forEach(charge => {
            subtotal += charge.hours * charge.rate;
        });

        const tax = subtotal * 0.07;
        const total = subtotal + tax;

        // Update the bill totals
        document.getElementById('billSubtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('billTax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('billTotal').textContent = `$${total.toFixed(2)}`;
    }

    // Initialize status update events
    function initializeStatusEvents() {
        const updateStatusBtn = document.getElementById('updateStatusBtn');
        if (updateStatusBtn) {
            updateStatusBtn.addEventListener('click', function() {
                updateServiceStatus();
            });
        }

        const statusSelect = document.getElementById('statusSelect');
        if (statusSelect) {
            statusSelect.addEventListener('change', function() {
                updateStatusPreview(this.value);
            });
        }
    }

    // Update status preview
    function updateStatusPreview(status) {
        const currentStatusBadge = document.getElementById('currentStatusBadge');
        if (currentStatusBadge) {
            // Remove all status classes
            currentStatusBadge.classList.remove('new', 'in-progress', 'completed', 'diagnosis', 'pending-parts', 'repair', 'quality-check');

            // Add the selected status class
            let statusClass = 'new';
            if (status === 'Diagnosis' || status === 'Repair') {
                statusClass = 'in-progress';
            } else if (status === 'Completed') {
                statusClass = 'completed';
            }

            currentStatusBadge.classList.add(statusClass);

            // Update the status text
            let statusText = status.replace(/-/g, ' ');
            statusText = statusText.charAt(0).toUpperCase() + statusText.slice(1);
            currentStatusBadge.innerHTML = `<i class="fas fa-circle"></i> ${statusText}`;
        }
    }

    // Update service status
    function updateServiceStatus() {
        const statusSelect = document.getElementById('statusSelect');
        const statusNotes = document.getElementById('statusNotes');
        const notifyCustomer = document.getElementById('notifyCustomer');

        if (!statusSelect || !statusNotes || !notifyCustomer) {
            console.error('Status update form elements not found');
            return;
        }

        const status = statusSelect.value;
        const notes = statusNotes.value;
        const shouldNotify = notifyCustomer.checked;

        // Get token from URL or session
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token') || sessionStorage.getItem('jwt-token');

        // Set up headers
        const headers = {
            'Content-Type': 'application/json'
        };
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        // Prepare data for API call
        const statusData = {
            status: status,
            notes: notes,
            notifyCustomer: shouldNotify
        };

        console.log(`Updating service ${window.currentRequestId} status to ${status}`);

        // Send to server using the correct endpoint
        fetch(`/serviceAdvisor/api/service/${window.currentRequestId}/status`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(statusData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to update status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Status update response:', data);

                // Add to status history
                addStatusHistoryItem(status, notes);

                // Show success notification
                showNotification(`Service status updated to ${status}!`);

                // If notify customer is checked, show additional notification
                if (shouldNotify && data.notificationSent) {
                    setTimeout(() => {
                        showNotification('Status update notification sent to customer');
                    }, 3000);
                }

                // Update the status in the main table and in all status badges
                updateStatusInTable(window.currentRequestId, status);
                updateAllStatusBadges(status);

                // Clear the notes field
                document.getElementById('statusNotes').value = '';

                // Refresh service details to ensure everything is in sync
                setTimeout(() => {
                    openVehicleDetails(window.currentRequestId);
                }, 1000);
            })
            .catch(error => {
                console.error('Error updating service status:', error);
                showNotification('Error updating status: ' + error.message, 'error');
            });
    }

    // Update all status badges in the modal
    function updateAllStatusBadges(status) {
        let statusClass = getStatusClass(status);

        // Update current status badge
        const currentStatusBadge = document.getElementById('currentStatusBadge');
        if (currentStatusBadge) {
            // Remove all status classes
            currentStatusBadge.classList.remove('new', 'in-progress', 'completed');
            currentStatusBadge.classList.add(statusClass);
            currentStatusBadge.innerHTML = `<i class="fas fa-circle"></i> ${status}`;
        }

        // Update all status displays
        const statusDisplays = document.querySelectorAll('.status-display .status-badge');
        statusDisplays.forEach(badge => {
            badge.classList.remove('new', 'in-progress', 'completed');
            badge.classList.add(statusClass);
            badge.innerHTML = `<i class="fas fa-circle"></i> ${status}`;
        });

        // Update status in details tab
        const detailStatus = document.querySelector('.detail-card:nth-of-type(3) .detail-value:nth-of-type(3) .status-badge');
        if (detailStatus) {
            detailStatus.classList.remove('new', 'in-progress', 'completed');
            detailStatus.classList.add(statusClass);
            detailStatus.innerHTML = `<i class="fas fa-circle"></i> ${status}`;
        }
    }

    function fetchServiceDetails(requestId) {
        // Get token from URL parameter or session storage
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Set up headers
        const headers = {};
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        return fetch(`/serviceAdvisor/api/service-details/${requestId}`, {
            method: 'GET',
            headers: headers
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .catch(error => {
                console.error(`Error fetching service details for ID ${requestId}:`, error);
                throw error;
            });
    }

    // Add status history item
    function addStatusHistoryItem(status, notes) {
        const statusHistory = document.querySelector('.status-history');
        if (!statusHistory) return;

        const now = new Date();
        const formattedDate = now.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });

        let statusText = status.replace(/-/g, ' ');
        statusText = statusText.charAt(0).toUpperCase() + statusText.slice(1);

        let statusClass = 'new';
        if (status === 'Diagnosis' || status === 'Repair') {
            statusClass = 'in-progress';
        } else if (status === 'Completed') {
            statusClass = 'completed';
        }

        const historyItem = document.createElement('div');
        historyItem.className = 'status-history-item';
        historyItem.innerHTML = `
        <div class="status-history-badge ${statusClass}">${statusText}</div>
        <div class="status-history-details">
            <div class="status-history-date">${formattedDate}</div>
            <div class="status-history-user">Updated by: Service Advisor</div>
            <div class="status-history-notes">${notes || 'No notes provided'}</div>
        </div>
    `;

        // Insert new history item at the top
        statusHistory.insertBefore(historyItem, statusHistory.firstChild);
    }

    // Update status in the table
    function updateStatusInTable(requestId, status) {
        const row = document.querySelector(`#vehiclesTableBody tr[data-id="${requestId}"]`);
        if (row) {
            const statusCell = row.querySelector('td:nth-child(5)');
            if (statusCell) {
                let statusClass = 'new';
                if (status === 'Diagnosis' || status === 'Repair') {
                    statusClass = 'in-progress';
                } else if (status === 'Completed') {
                    statusClass = 'completed';
                }

                statusCell.innerHTML = `
                <span class="status-badge ${statusClass}">
                    <i class="fas fa-circle"></i> ${status}
                </span>
            `;
            }
        }
    }

    // Save service items
    function saveServiceItems() {
        // Only proceed if we have items to save
        if (window.inventoryItems.length === 0 && window.laborCharges.length === 0) {
            showNotification('No service items to save', 'info');
            return;
        }

        // Show a saving indicator
        showNotification('Saving service items...', 'info');

        // Get token from URL or session
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token') || sessionStorage.getItem('jwt-token');

        // Set up headers
        const headers = {
            'Content-Type': 'application/json'
        };
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        // Track promises for inventory items and labor charges
        const promises = [];

        // Save inventory items if there are any
        if (window.inventoryItems.length > 0) {
            // Format inventory items for API
            const items = window.inventoryItems.map(item => {
                return {
                    itemId: item.key,
                    name: item.name,
                    quantity: item.quantity,
                    unitPrice: item.price
                };
            });

            // Create service materials request
            const materialsRequest = {
                items: items,
                replaceExisting: true
            };

            // Add inventory items promise
            const inventoryPromise = fetch(`/serviceAdvisor/api/service/${window.currentRequestId}/inventory-items`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(materialsRequest)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to save inventory items: ${response.status}`);
                    }
                    return response.json();
                });

            promises.push(inventoryPromise);
        }

        // Save labor charges if there are any
        if (window.laborCharges.length > 0) {
            // Format labor charges for API
            const charges = window.laborCharges.map(charge => {
                return {
                    description: charge.description,
                    hours: charge.hours,
                    ratePerHour: charge.rate,
                    total: charge.hours * charge.rate
                };
            });

            // Add labor charges promise
            const laborPromise = fetch(`/serviceAdvisor/api/service/${window.currentRequestId}/labor-charges`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(charges)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to save labor charges: ${response.status}`);
                    }
                    return response.json();
                });

            promises.push(laborPromise);
        }

        // Wait for all promises to resolve
        Promise.all(promises)
            .then(results => {
                console.log('Save service items results:', results);

                // Use the latest bill data (from the last result)
                const latestData = results[results.length - 1];
                if (latestData && latestData.currentBill) {
                    loadCurrentBill(latestData.currentBill);
                }

                // Show success notification
                showNotification('Service items saved successfully!');

                // Refresh service details to ensure everything is in sync
                setTimeout(() => {
                    openVehicleDetails(window.currentRequestId);
                }, 1000);
            })
            .catch(error => {
                console.error('Error saving service items:', error);
                showNotification('Error: ' + error.message, 'error');
            });
    }

    // Generate bill
    function generateBill() {
        // Get service notes
        const serviceNotes = document.getElementById('serviceNotes').value;

        // Prepare bill request data
        const billRequest = {
            materials: window.inventoryItems.map(item => {
                return {
                    itemId: item.key,
                    name: item.name,
                    quantity: item.quantity,
                    unitPrice: item.price,
                    total: item.price * item.quantity
                };
            }),
            laborCharges: window.laborCharges.map(charge => {
                return {
                    description: charge.description,
                    hours: charge.hours,
                    ratePerHour: charge.rate,
                    total: charge.hours * charge.rate
                };
            }),
            materialsTotal: window.inventoryItems.reduce((sum, item) => sum + (item.price * item.quantity), 0),
            laborTotal: window.laborCharges.reduce((sum, charge) => sum + (charge.hours * charge.rate), 0),
            subtotal: window.inventoryItems.reduce((sum, item) => sum + (item.price * item.quantity), 0) +
                window.laborCharges.reduce((sum, charge) => sum + (charge.hours * charge.rate), 0),
            notes: serviceNotes,
            sendEmail: true
        };

        // Calculate tax and grand total
        billRequest.gst = billRequest.subtotal * 0.07;
        billRequest.grandTotal = billRequest.subtotal + billRequest.gst;

        // Send to server
        fetch(`/serviceAdvisor/api/service/${window.currentRequestId}/generate-bill`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(billRequest)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to generate bill');
                }
                return response.json();
            })
            .then(data => {
                // Show success notification
                showNotification('Bill generated successfully!');

                // If email was sent, show notification
                if (data.emailSent) {
                    setTimeout(() => {
                        showNotification('Bill email sent to customer');
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error generating bill:', error);
                showNotification('Error generating bill: ' + error.message, 'error');
            });
    }

    // Download bill PDF
    function downloadBillPdf() {
        // Here you would generate and download a PDF of the bill
        // For demo purposes, we'll just show a success notification
        showNotification('Bill PDF downloaded successfully!');
    }

    // Send bill to admin
    function sendBillToAdmin() {
        // Here you would send the bill to admin for processing
        // For demo purposes, we'll just show a success notification
        showNotification('Bill has been sent to admin for processing!');
    }

    // Mark service as complete
    function markServiceComplete() {
        // Update status to completed
        const statusSelect = document.getElementById('statusSelect');
        if (statusSelect) {
            // Find the "Completed" option
            for (let i = 0; i < statusSelect.options.length; i++) {
                if (statusSelect.options[i].value.toLowerCase() === 'completed') {
                    statusSelect.selectedIndex = i;
                    break;
                }
            }
        }

        // Set default notes
        const statusNotes = document.getElementById('statusNotes');
        if (statusNotes) {
            statusNotes.value = "Service marked as complete by service advisor.";
        }

        // Enable customer notification
        const notifyCustomer = document.getElementById('notifyCustomer');
        if (notifyCustomer) {
            notifyCustomer.checked = true;
        }

        // Preview the status update
        updateStatusPreview('Completed');

        // Call the update function
        updateServiceStatus();
    }

    // Show notification
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('successNotification');

        // Update notification class based on type
        notification.className = 'notification'; // Reset classes
        notification.classList.add(type);

        document.getElementById('notificationMessage').textContent = message;
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
</script>
</body>
</html>