<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Albany Motors - Completed Services</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts - Baloo Bhaijaan 2 -->
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --dutch-white: #EFFBBB; /* Dutch White */
            --dutch-white-light: #f5ffd4;
            --dutch-white-dark: #d6e297;
            --dutch-white-darker: #bfca85;
            --wine: #722F37; /* Wine */
            --wine-light: #8a3943;
            --wine-dark: #5e262e;
            --wine-darker: #491d23;
            --wine-gradient: linear-gradient(145deg, #722F37 0%, #5e262e 100%);
            --wine-gradient-hover: linear-gradient(145deg, #8a3943 0%, #722F37 100%);
            --dutch-white-gradient: linear-gradient(145deg, #EFFFBB 0%, #d6e297 100%);
            --white: #ffffff;
            --light-bg: #f8f9fa;
            --light-gray: #e9ecef;
            --medium-gray: #adb5bd;
            --dark-gray: #495057;
            --danger: #ef5350;
            --warning: #ffca28;
            --success: #66bb6a;
            --info: #42a5f5;

            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.1);
            --shadow-xl: 0 12px 24px rgba(0,0,0,0.15);

            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 1rem;

            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            font-family: 'Baloo Bhaijaan 2', sans-serif;
            background-color: #f8f9fa;
            color: var(--dark-gray);
            min-height: 100vh;
            scroll-behavior: smooth;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--wine);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--wine-light);
        }

        .app-container {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: var(--wine-gradient);
            color: var(--white);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
        }

        .sidebar-header {
            padding: 1.75rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h2 {
            margin-bottom: 0;
            font-weight: 700;
            color: var(--white);
            font-size: 1.75rem;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .sidebar-content::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.75rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu-item {
            padding: 0 0.75rem;
            margin-bottom: 0.25rem;
        }

        .sidebar-menu-link {
            display: flex;
            align-items: center;
            padding: 0.85rem 1rem;
            color: rgba(255, 255, 255, 0.95);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: var(--transition);
            position: relative;
        }

        .sidebar-menu-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .sidebar-menu-link.active {
            background-color: var(--dutch-white-light);
            color: var(--wine);
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-menu-link.active::before {
            content: '';
            position: absolute;
            left: -0.75rem;
            top: 50%;
            transform: translateY(-50%);
            height: 2rem;
            width: 4px;
            background-color: var(--dutch-white-dark);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .sidebar-menu-link i {
            width: 1.5rem;
            text-align: center;
            font-size: 1.1rem;
            margin-right: 0.75rem;
        }

        .sidebar-menu-link span {
            font-size: 1rem;
            font-weight: 500;
            color: inherit;
        }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--white);
        }

        .user-role {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: var(--radius-md);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            transition: var(--transition);
            color: var(--dark-gray);
        }

        /* Header Styles */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            position: relative;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .header-left h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--wine);
            margin-bottom: 0.5rem;
            position: relative;
            letter-spacing: 1px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
        }

        .header-subtitle {
            font-size: 1rem;
            color: var(--medium-gray);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
        }

        /* Premium Button */
        .btn-premium {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn-premium::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            transition: all 0.4s ease;
            z-index: -1;
        }

        .btn-premium:hover::after {
            width: 100%;
        }

        .btn-premium.primary {
            background: var(--wine-gradient);
            color: white;
        }

        .btn-premium.primary:hover {
            box-shadow: 0 6px 15px rgba(114, 47, 55, 0.3);
            transform: translateY(-2px);
        }

        .btn-premium.secondary {
            background-color: var(--white);
            color: var(--wine);
        }

        .btn-premium.secondary:hover {
            background-color: var(--light-bg);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        /* Search Box */
        .search-box {
            position: relative;
            max-width: 400px;
            margin-bottom: 2rem;
        }

        .search-input {
            padding: 1rem 1rem 1rem 3rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--radius-lg);
            width: 100%;
            font-size: 1rem;
            color: var(--dark-gray);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--wine);
            box-shadow: 0 0 0 4px rgba(114, 47, 55, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--medium-gray);
            pointer-events: none;
        }

        /* Table Section */
        .table-section {
            background-color: var(--white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            transition: var(--transition);
            border: 1px solid rgba(114, 47, 55, 0.1);
        }

        .table-section:hover {
            box-shadow: 0 15px 30px rgba(114, 47, 55, 0.15), 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .table-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--wine);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .table-title i {
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--dutch-white-light);
            color: var(--wine);
            border-radius: var(--radius-sm);
        }

        .table-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .search-box-sm {
            position: relative;
        }

        .search-input-sm {
            padding: 0.65rem 1rem 0.65rem 2.5rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--radius-lg);
            width: 250px;
            font-size: 0.9rem;
            color: var(--dark-gray);
            transition: var(--transition);
        }

        .search-input-sm:focus {
            outline: none;
            border-color: var(--wine-light);
            box-shadow: 0 0 0 3px rgba(114, 47, 55, 0.1);
        }

        .search-icon-sm {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--medium-gray);
            pointer-events: none;
        }

        .premium-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .premium-table thead th {
            background-color: var(--bg-light);
            color: var(--dark-gray);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1.25rem 1rem;
            border-bottom: 1px solid var(--light-gray);
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .premium-table tbody td {
            padding: 1.25rem 1rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--light-gray);
            font-size: 0.95rem;
        }

        .premium-table tbody tr:last-child td {
            border-bottom: none;
        }

        .premium-table tbody tr {
            transition: var(--transition);
            cursor: pointer;
        }

        .premium-table tbody tr:hover {
            background-color: rgba(114, 47, 55, 0.05);
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.85rem;
            font-weight: 500;
            line-height: 1;
        }

        .status-completed {
            background-color: rgba(102, 187, 106, 0.15);
            color: #00701a;
        }

        .status-completed i {
            color: var(--success);
        }

        .status-pending {
            background-color: rgba(255, 202, 40, 0.15);
            color: #d68000;
        }

        .status-pending i {
            color: var(--warning);
        }

        .status-paid {
            background-color: rgba(102, 187, 106, 0.15);
            color: #00701a;
        }

        .status-paid i {
            color: var(--success);
        }

        .status-dispatched {
            background-color: rgba(156, 39, 176, 0.15);
            color: #7b1fa2;
        }

        .status-dispatched i {
            color: #7b1fa2;
        }

        /* Vehicle Info Cell Styles */
        .vehicle-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .vehicle-icon {
            width: 2.5rem;
            height: 2.5rem;
            background-color: var(--dutch-white-light);
            color: var(--wine);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: var(--transition);
        }

        .vehicle-details {
            display: flex;
            flex-direction: column;
        }

        .vehicle-details h5 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--wine);
        }

        .vehicle-details p {
            font-size: 0.8rem;
            color: var(--medium-gray);
            margin: 0;
        }

        .person-info {
            display: flex;
            flex-direction: column;
        }

        .person-details h5 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--wine);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px;
        }

        .person-details p {
            font-size: 0.75rem;
            color: var(--medium-gray);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px;
        }

        /* Membership Badge */
        .membership-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .membership-standard {
            background-color: rgba(66, 165, 245, 0.15);
            color: var(--info);
        }

        .membership-premium {
            background: linear-gradient(to right, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.3));
            color: #b8860b;
        }

        /* Table Action Buttons */
        .table-actions-cell {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .btn-table-action {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--white);
            color: var(--wine);
            border: 1px solid var(--light-gray);
            border-radius: 50%;
            font-size: 0.85rem;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .btn-table-action:hover {
            background-color: var(--light-bg);
            border-color: var(--wine-light);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .btn-table-action.success {
            background-color: rgba(102, 187, 106, 0.1);
            color: #00701a;
            border-color: rgba(102, 187, 106, 0.3);
        }

        .btn-table-action.warning {
            background-color: rgba(255, 202, 40, 0.1);
            color: #d68000;
            border-color: rgba(255, 202, 40, 0.3);
        }

        .btn-table-action.info {
            background-color: rgba(66, 165, 245, 0.1);
            color: #0069c0;
            border-color: rgba(66, 165, 245, 0.3);
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }

        .pagination {
            display: flex;
            gap: 0.35rem;
            background-color: white;
            border-radius: 50px;
            padding: 0.5rem;
            box-shadow: var(--shadow-lg);
        }

        .page-item .page-link {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: var(--dark-gray);
            font-weight: 500;
            border: none;
            transition: var(--transition);
            background-color: transparent;
        }

        .page-item .page-link:hover {
            background-color: var(--light-gray);
        }

        .page-item.active .page-link {
            background-color: var(--wine);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .page-item.disabled .page-link {
            color: var(--medium-gray);
            pointer-events: none;
            opacity: 0.6;
        }

        /* Modal Styles - Premium */
        .modal-premium .modal-content {
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .modal-premium .modal-header {
            background: var(--wine-gradient);
            color: white;
            border-bottom: none;
            padding: 1.75rem 2rem;
            position: relative;
        }

        .modal-premium .modal-title {
            font-weight: 700;
            font-size: 1.35rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-premium .modal-title i {
            width: 2.5rem;
            height: 2.5rem;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .modal-premium .modal-body {
            padding: 2.5rem;
        }

        .modal-premium .modal-footer {
            padding: 1.5rem 2.5rem;
            border-top: 1px solid var(--light-gray);
            background-color: rgba(248, 249, 250, 0.5);
        }

        .modal-premium .btn-close {
            background: rgba(255, 255, 255, 0.2) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23FFF'%3E%3Cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3E%3C/svg%3E") center/1em auto no-repeat;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            opacity: 0.8;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .modal-premium .btn-close:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Service Details */
        .service-detail-row {
            display: flex;
            flex-wrap: nowrap;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
            width: 100%;
            overflow-x: auto;
        }

        .service-detail-col {
            flex: 1 0 auto;
            min-width: 180px;
            padding-right: 1.5rem;
        }

        .detail-label {
            font-size: 0.85rem;
            color: var(--medium-gray);
            margin-bottom: 0.35rem;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .materials-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1.5rem;
            background-color: var(--light-bg);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .materials-table th {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--dark-gray);
            padding: 0.75rem 1rem;
            text-align: left;
            background-color: var(--light-bg);
            border-bottom: 1px solid var(--light-gray);
        }

        .materials-table td {
            font-size: 0.9rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .materials-table tr:last-child td {
            border-bottom: none;
        }

        .materials-table tbody tr:last-child {
            background-color: rgba(102, 187, 106, 0.05);
            font-weight: 600;
        }

        /* Labor Charges Table */
        .labor-charges-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1.5rem;
            background-color: var(--light-bg);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .labor-charges-table th {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--dark-gray);
            padding: 0.75rem 1rem;
            text-align: left;
            background-color: var(--light-bg);
            border-bottom: 1px solid var(--light-gray);
        }

        .labor-charges-table td {
            font-size: 0.9rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .labor-charges-table tr:last-child td {
            border-bottom: none;
        }

        .invoice-summary {
            background-color: var(--light-bg);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .invoice-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .invoice-summary-row:last-child {
            margin-bottom: 0;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--light-gray);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .invoice-summary-label {
            color: var(--dark-gray);
        }

        .invoice-summary-value {
            color: var(--wine);
        }

        /* Steps indicator for completed services workflow */
        .workflow-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }

        .workflow-steps::before {
            content: '';
            position: absolute;
            top: 24px;
            left: 30px;
            right: 30px;
            height: 2px;
            background-color: var(--light-gray);
            z-index: 1;
        }

        .workflow-step {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .step-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--light-bg);
            border: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
            color: var(--medium-gray);
            font-size: 1.25rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .step-text {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--medium-gray);
            text-align: center;
            transition: all 0.3s ease;
        }

        .workflow-step.active .step-icon {
            background-color: var(--wine);
            border-color: var(--wine);
            color: white;
            box-shadow: 0 0 0 5px rgba(114, 47, 55, 0.2);
        }

        .workflow-step.active .step-text {
            color: var(--wine);
            font-weight: 600;
        }

        .workflow-step.completed .step-icon {
            background-color: var(--success);
            border-color: var(--success);
            color: white;
        }

        .workflow-step.completed .step-text {
            color: var(--success);
        }

        /* Albany Spinner */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .spinner-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .spinner-container {
            position: relative;
            width: 120px;
            height: 120px;
            perspective: 300px;
        }

        .albany-spinner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            animation: spin 3s infinite cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .spinner-letter {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 72px;
            font-weight: 800;
            color: var(--wine);
            text-shadow: 0 0 5px rgba(114, 47, 55, 0.3);
            backface-visibility: hidden;
            transform: rotateY(0deg) translateZ(60px);
        }

        .spinner-circle {
            position: absolute;
            top: -10px;
            left: -10px;
            width: calc(100% + 20px);
            height: calc(100% + 20px);
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: var(--wine);
            border-bottom-color: var(--dutch-white);
            animation: spin-reverse 1.5s linear infinite;
        }

        .spinner-circle:nth-child(2) {
            top: -5px;
            left: -5px;
            width: calc(100% + 10px);
            height: calc(100% + 10px);
            border-top-color: var(--dutch-white);
            border-bottom-color: var(--wine);
            animation-duration: 2s;
        }

        .spinner-text {
            position: absolute;
            bottom: -40px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: var(--wine);
        }

        @keyframes spin {
            0% {
                transform: rotateY(0deg);
            }
            25% {
                transform: rotateY(90deg);
            }
            50% {
                transform: rotateY(180deg);
            }
            75% {
                transform: rotateY(270deg);
            }
            100% {
                transform: rotateY(360deg);
            }
        }

        @keyframes spin-reverse {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Success Modal */
        .success-modal .modal-content {
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            background-color: var(--white);
            position: relative;
        }

        .success-modal .modal-body {
            padding: 3.5rem 2.5rem;
            text-align: center;
            position: relative;
        }

        .success-modal .modal-body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 15px;
            background: var(--wine-gradient);
        }

        .success-icon-container {
            margin-bottom: 2rem;
            position: relative;
            display: inline-flex;
        }

        .success-icon-wrapper {
            width: 8rem;
            height: 8rem;
            border-radius: 50%;
            background: linear-gradient(145deg, rgba(102, 187, 106, 0.15), rgba(102, 187, 106, 0.05));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 187, 106, 0.6);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(102, 187, 106, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 187, 106, 0);
            }
        }

        .success-icon {
            width: 6rem;
            height: 6rem;
            border-radius: 50%;
            background-color: var(--success);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: 0 10px 30px rgba(102, 187, 106, 0.3);
            animation: scale-in 0.5s ease-out;
        }

        @keyframes scale-in {
            0% {
                transform: scale(0);
            }
            80% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        .success-modal .success-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 1rem;
        }

        .success-modal .success-message {
            font-size: 1.1rem;
            color: var(--medium-gray);
            margin-bottom: 2rem;
            line-height: 1.6;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        .success-modal .continue-btn {
            padding: 1rem 3rem;
            font-size: 1.1rem;
            border-radius: var(--radius-lg);
            background: var(--wine-gradient);
            color: white;
            border: none;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        .success-modal .continue-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(114, 47, 55, 0.2);
        }

        /* Footer */
        .app-footer {
            margin-top: 3rem;
            padding-bottom: 2rem;
        }

        .footer-content {
            background: var(--wine-gradient);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            color: white;
            text-align: center;
        }

        .footer-text {
            margin: 0;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .footer-brand {
            font-weight: 600;
            color: var(--dutch-white-light);
        }

        /* Mobile menu toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1060;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: var(--wine-gradient);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(114, 47, 55, 0.25);
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .mobile-menu-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(114, 47, 55, 0.3);
        }

        /* Toast Notification */
        .toast-container {
            z-index: 1070;
        }
        .bg-wine {
            background-color: #722F37;
        }
        .toast {
            opacity: 0.95;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.2);
        }

        /* Responsive Design */
        @media (max-width: 991.98px) {
            .sidebar {
                width: 5rem;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            }

            .sidebar-header h2,
            .sidebar-menu-link span,
            .user-info,
            .nav-section-title,
            .logout-btn span {
                display: none;
            }

            .sidebar-menu-link {
                justify-content: center;
                padding: 0.75rem;
            }

            .sidebar-menu-link i {
                margin-right: 0;
                font-size: 1.25rem;
            }

            .sidebar-menu-link.active::before {
                left: -0.5rem;
            }

            .sidebar-footer {
                justify-content: center;
                padding: 1rem;
            }

            .logout-btn {
                padding: 0.5rem;
                justify-content: center;
            }

            .main-content {
                margin-left: 5rem;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-left h1 {
                font-size: 2rem;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .table-actions {
                width: 100%;
                justify-content: space-between;
            }

            .search-box-sm {
                width: 100%;
            }

            .search-input-sm {
                width: 100%;
            }
        }

        @media (max-width: 767.98px) {
            .sidebar {
                z-index: 1050;
            }

            .table-section {
                overflow-x: auto;
            }

            .premium-table {
                min-width: 1000px;
            }

            .mobile-menu-toggle {
                display: flex;
            }

            .sidebar {
                width: 0;
                transform: translateX(-100%);
            }

            .sidebar.active {
                width: 280px;
                transform: translateX(0);
            }

            .sidebar.active .sidebar-header h2,
            .sidebar.active .sidebar-menu-link span,
            .sidebar.active .user-info,
            .sidebar.active .nav-section-title,
            .sidebar.active .logout-btn span {
                display: block;
            }

            .sidebar.active .sidebar-menu-link {
                justify-content: flex-start;
                padding: 0.85rem 1rem;
            }

            .sidebar.active .sidebar-menu-link i {
                margin-right: 0.75rem;
            }

            .sidebar.active .logout-btn {
                padding: 0.5rem 1rem;
                justify-content: space-between;
            }

            .main-content {
                margin-left: 0;
            }

            .page-header {
                padding-top: 4rem;
            }
        }

        @media (max-width: 575.98px) {
            .main-content {
                padding: 1rem;
            }

            .page-header {
                margin-bottom: 1.5rem;
            }

            .header-left h1 {
                font-size: 1.75rem;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.75rem;
                width: 100%;
            }

            .btn-premium {
                width: 100%;
                justify-content: center;
            }

            .search-box {
                max-width: 100%;
            }

            .service-detail-row {
                flex-direction: column;
            }

            .service-detail-col {
                width: 100%;
                padding-right: 0;
                margin-bottom: 1rem;
            }
        }

        /* Hide all table rows except the first 5 by default */
        .premium-table tbody tr {
            display: none;
        }

        .premium-table tbody tr.active-page {
            display: table-row;
        }
    </style>
</head>
<body>
<!-- Albany Spinner Overlay -->
<div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner-container">
        <div class="albany-spinner">
            <div class="spinner-letter">A</div>
            <div class="spinner-circle"></div>
            <div class="spinner-circle"></div>
        </div>
        <div class="spinner-text">Loading...</div>
    </div>
</div>

<!-- Mobile Menu Toggle Button -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
</button>

<div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Albany</h2>
        </div>

        <div class="sidebar-content">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/dashboard}" class="sidebar-menu-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/service-requests}" class="sidebar-menu-link">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Service Requests</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/vehicles}" class="sidebar-menu-link">
                            <i class="fas fa-car"></i>
                            <span>Vehicles</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/customers}" class="sidebar-menu-link">
                            <i class="fas fa-users"></i>
                            <span>Customers</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/service-advisors}" class="sidebar-menu-link">
                            <i class="fas fa-user-tie"></i>
                            <span>Service Advisors</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/inventory}" class="sidebar-menu-link">
                            <i class="fas fa-boxes"></i>
                            <span>Inventory</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/completed-services}" class="sidebar-menu-link active">
                            <i class="fas fa-check-circle"></i>
                            <span>Completed Services</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-name">Arthur Morgan</div>
                <div class="user-role">Administrator</div>
            </div>
            <button class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <header class="page-header">
            <div class="header-left">
                <h1>Completed Services</h1>
                <div class="header-subtitle">
                    <i class="fas fa-check-circle"></i>
                    View and manage completed vehicle services
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-premium primary" data-bs-toggle="modal" data-bs-target="#filterServicesModal">
                    <i class="fas fa-filter"></i>
                    Filter Services
                </button>
            </div>
        </header>

        <!-- Search Box -->
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="Search by vehicle, registration number, customer...">
            <i class="fas fa-search search-icon"></i>
        </div>

        <!-- Completed Services Table -->
        <section class="table-section">
            <div class="table-header">
                <h3 class="table-title">
                    <i class="fas fa-check-circle"></i>
                    Completed Services
                </h3>
                <div class="table-actions">
                    <div class="search-box-sm">
                        <input type="text" class="search-input-sm" placeholder="Filter completed services...">
                        <i class="fas fa-search search-icon-sm"></i>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="premium-table" id="completedServicesTable">
                    <thead>
                    <tr>
                        <th>Service ID</th>
                        <th>Vehicle</th>
                        <th>Customer</th>
                        <th>Membership</th>
                        <th>Service Type</th>
                        <th>Completion Date</th>
                        <th>Total Amount</th>
                        <th>Bill/Invoice</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="completedServicesTableBody">
                    <!-- Will be populated dynamically via JavaScript -->
                    <tr id="loading-row-completed">
                        <td colspan="10" class="text-center py-4">
                            <div class="spinner-border text-wine" role="status"></div>
                            <p class="mt-2">Loading completed services...</p>
                        </td>
                    </tr>
                    <tr id="empty-row-completed" style="display: none;">
                        <td colspan="10" class="text-center py-4">
                            <div class="my-5">
                                <i class="fas fa-check-circle fa-3x text-muted mb-3"></i>
                                <h5>No completed services found</h5>
                                <p class="text-muted">Once services are completed, they will appear here</p>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-container">
                <ul class="pagination" id="paginationCompleted">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" id="prevBtnCompleted" aria-label="Previous">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#" data-page="1">1</a></li>
                    <li class="page-item"><a class="page-link" href="#" data-page="2">2</a></li>
                    <li class="page-item"><a class="page-link" href="#" data-page="3">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#" id="nextBtnCompleted" aria-label="Next">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </section>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-content">
                <p class="footer-text">
                    &copy; 2025 <span class="footer-brand">Albany</span>. All Rights Reserved.
                </p>
            </div>
        </footer>
    </main>
</div>

<!-- Filter Services Modal -->
<div class="modal fade modal-premium" id="filterServicesModal" tabindex="-1" aria-labelledby="filterServicesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterServicesModalLabel">
                    <i class="fas fa-filter"></i>
                    Filter Completed Services
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="filterServicesForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="filterByVehicleType" class="form-label">Vehicle Type</label>
                            <select class="form-select" id="filterByVehicleType">
                                <option value="">All Types</option>
                                <option value="Car">Car</option>
                                <option value="Bike">Bike</option>
                                <option value="Truck">Truck</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="filterByServiceType" class="form-label">Service Type</label>
                            <select class="form-select" id="filterByServiceType">
                                <option value="">All Service Types</option>
                                <option value="Oil Change">Oil Change</option>
                                <option value="Brake Service">Brake Service</option>
                                <option value="Tire Rotation">Tire Rotation</option>
                                <option value="Engine Repair">Engine Repair</option>
                                <option value="Transmission Service">Transmission Service</option>
                                <option value="Regular Maintenance">Regular Maintenance</option>
                                <option value="Battery Replacement">Battery Replacement</option>
                                <option value="Diagnostics">Diagnostics</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="filterByPaymentStatus" class="form-label">Payment Status</label>
                            <select class="form-select" id="filterByPaymentStatus">
                                <option value="">All Payment Statuses</option>
                                <option value="Pending">Pending</option>
                                <option value="Paid">Paid</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="filterByInvoiceStatus" class="form-label">Invoice Status</label>
                            <select class="form-select" id="filterByInvoiceStatus">
                                <option value="">All Invoice Statuses</option>
                                <option value="Generated">Generated</option>
                                <option value="Pending">Pending</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="filterDateFrom" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="filterDateFrom">
                        </div>
                        <div class="col-md-6">
                            <label for="filterDateTo" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="filterDateTo">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-premium primary" id="applyFilterBtn">
                    <i class="fas fa-check"></i>
                    Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Service Details Modal -->
<div class="modal fade modal-premium" id="viewServiceDetailsModal" tabindex="-1" aria-labelledby="viewServiceDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewServiceDetailsModalLabel">
                    <i class="fas fa-info-circle"></i>
                    Service Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Service ID</div>
                        <div class="detail-value" id="viewServiceId">REQ-1001</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Status</div>
                        <div class="detail-value" id="viewStatus">
                            <span class="status-badge status-completed">
                                <i class="fas fa-check-circle"></i> Completed
                            </span>
                        </div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Completion Date</div>
                        <div class="detail-value" id="viewCompletionDate">April 15, 2025</div>
                    </div>
                </div>

                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Vehicle</div>
                        <div class="detail-value" id="viewVehicleName">Honda City</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Registration Number</div>
                        <div class="detail-value" id="viewRegistrationNumber">MH02AB1234</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Vehicle Category</div>
                        <div class="detail-value" id="viewVehicleCategory">Car</div>
                    </div>
                </div>

                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Customer</div>
                        <div class="detail-value" id="viewCustomerName">Rajesh Kumar</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Contact</div>
                        <div class="detail-value" id="viewCustomerContact">+91 98765 43210</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Membership</div>
                        <div class="detail-value" id="viewMembership">Premium</div>
                    </div>
                </div>

                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Service Type</div>
                        <div class="detail-value" id="viewServiceType">Engine Repair</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Service Advisor</div>
                        <div class="detail-value" id="viewServiceAdvisor">Amit Sharma</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Total Amount</div>
                        <div class="detail-value" id="viewTotalAmount">12,803.00</div>
                    </div>
                </div>

                <div>
                    <div class="detail-label">Service Description</div>
                    <div class="detail-value" id="viewServiceDescription">
                        <p>Vehicle was showing check engine light and making unusual noise when accelerating. Timing belt and related components replaced.</p>
                    </div>
                </div>

                <div id="materialsSection" class="mt-4">
                    <h5 class="mb-3">Materials Used</h5>
                    <table class="materials-table" id="materialsTable">
                        <thead>
                        <tr>
                            <th>Item</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                        </thead>
                        <tbody id="materialsTableBody">
                        <!-- Will be populated dynamically -->
                        </tbody>
                    </table>

                    <h5 class="mt-4 mb-3">Labor Charges</h5>
                    <table class="labor-charges-table" id="laborChargesTable">
                        <thead>
                        <tr>
                            <th>Description</th>
                            <th>Hours</th>
                            <th>Rate/Hour</th>
                            <th>Total</th>
                        </tr>
                        </thead>
                        <tbody id="laborChargesTableBody">
                        <!-- Will be populated dynamically -->
                        </tbody>
                    </table>

                    <div class="invoice-summary">
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">Materials Total</div>
                            <div class="invoice-summary-value" id="summaryMaterialsTotal">7,250.00</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">Labor Total</div>
                            <div class="invoice-summary-value" id="summaryLaborTotal">3,600.00</div>
                        </div>
                        <div class="invoice-summary-row premium-discount-row" id="premiumDiscountRow" style="display:none;">
                            <div class="invoice-summary-label text-success">Premium Membership Discount (30% off labor)</div>
                            <div class="invoice-summary-value text-success" id="summaryDiscount">-1,080.00</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">Subtotal</div>
                            <div class="invoice-summary-value" id="summarySubtotal">10,850.00</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">GST (18%)</div>
                            <div class="invoice-summary-value" id="summaryGST">1,953.00</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">Grand Total</div>
                            <div class="invoice-summary-value" id="summaryGrandTotal">12,803.00</div>
                        </div>
                    </div>
                </div>

                <!-- Workflow steps for completed services -->
                <div id="workflowStepsContainer" class="mt-4">
                    <h5 class="mb-3">Service Workflow</h5>
                    <div class="workflow-steps">
                        <div class="workflow-step" id="stepBill">
                            <div class="step-icon">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div class="step-text">Generate Bill</div>
                        </div>
                        <div class="workflow-step" id="stepPayment">
                            <div class="step-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="step-text">Payment</div>
                        </div>
                        <div class="workflow-step" id="stepInvoice">
                            <div class="step-icon">
                                <i class="fas fa-file-invoice"></i>
                            </div>
                            <div class="step-text">Invoice</div>
                        </div>
                        <div class="workflow-step" id="stepDelivery">
                            <div class="step-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="step-text">Delivery</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="completedServiceFooter">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn-action info" id="downloadInvoiceBtn">
                    <i class="fas fa-download"></i> Download Invoice
                </button>
                <!-- Additional action buttons will be added dynamically based on service status -->
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade modal-premium" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">
                    <i class="fas fa-money-bill-wave"></i>
                    Process Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    Processing payment for service <strong id="paymentServiceId">REQ-1001</strong> for <strong id="paymentCustomerName">Rajesh Kumar</strong>.
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="detail-label">Vehicle</div>
                        <div class="detail-value" id="paymentVehicleName">Honda City</div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-label">Total Amount</div>
                        <div class="detail-value fw-bold text-wine" id="paymentAmount">12,803.00</div>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="paymentMethod" class="form-label">Payment Method</label>
                    <select class="form-select" id="paymentMethod" required>
                        <option value="">Select Payment Method</option>
                        <option value="UPI">UPI</option>
                        <option value="Card">Credit/Debit Card</option>
                        <option value="Net Banking">Net Banking</option>
                        <option value="Cash">Cash</option>
                    </select>
                </div>

                <div class="form-group mb-3">
                    <label for="transactionId" class="form-label">Transaction ID</label>
                    <input type="text" class="form-control" id="transactionId" placeholder="Enter transaction ID">
                    <small class="form-text text-muted">Enter transaction ID or reference number (if applicable)</small>
                </div>

                <div class="form-group mb-3">
                    <label for="paidAmount" class="form-label">Amount Received</label>
                    <div class="input-group">
                        <span class="input-group-text"></span>
                        <input type="number" class="form-control" id="paidAmount" placeholder="Enter amount" required>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="paymentNotes" class="form-label">Payment Notes</label>
                    <textarea class="form-control" id="paymentNotes" rows="2" placeholder="Optional notes about this payment"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-premium primary" id="confirmPaymentBtn">
                    <i class="fas fa-check-circle"></i>
                    Confirm Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Invoice Modal -->
<div class="modal fade modal-premium" id="generateInvoiceModal" tabindex="-1" aria-labelledby="generateInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateInvoiceModalLabel">
                    <i class="fas fa-file-invoice"></i>
                    Generate Invoice
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success mb-4">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="invoiceAlertMessage">Payment has been received for service <strong id="invoiceServiceId">REQ-1001</strong>. Please generate an official invoice for <strong id="invoiceCustomerName">Rajesh Kumar</strong>.</span>
                    <span id="premiumBadge" style="display:none;" class="ms-2 membership-badge membership-premium"><i class="fas fa-crown"></i> Premium</span>
                </div>

                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Vehicle</div>
                        <div class="detail-value" id="invoiceVehicleName">Honda City</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Registration Number</div>
                        <div class="detail-value" id="invoiceRegistrationNumber">MH02AB1234</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Service Type</div>
                        <div class="detail-value" id="invoiceServiceType">Engine Repair</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-label">Completion Date</div>
                        <div class="detail-value" id="invoiceCompletionDate">April 15, 2025</div>
                    </div>
                </div>

                <div class="invoice-summary">
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">Materials Total</div>
                        <div class="invoice-summary-value" id="invoiceMaterialsTotal">7,250.00</div>
                    </div>
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">Labor Total</div>
                        <div class="invoice-summary-value" id="invoiceLaborTotal">3,600.00</div>
                    </div>
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">Subtotal</div>
                        <div class="invoice-summary-value" id="invoiceSubtotal">10,850.00</div>
                    </div>
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">GST (18%)</div>
                        <div class="invoice-summary-value" id="invoiceGST">1,953.00</div>
                    </div>
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">Grand Total</div>
                        <div class="invoice-summary-value" id="invoiceGrandTotal">12,803.00</div>
                    </div>
                </div>

                <div class="form-group mt-4">
                    <label for="invoiceNotes" class="form-label">Additional Notes</label>
                    <textarea class="form-control" id="invoiceNotes" rows="3" placeholder="Add any additional notes for the invoice"></textarea>
                </div>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" value="" id="sendInvoiceEmail" checked>
                    <label class="form-check-label" for="sendInvoiceEmail">
                        Send invoice to customer via email
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-premium primary" id="confirmGenerateInvoiceBtn">
                    <i class="fas fa-file-invoice"></i>
                    Generate & Send Invoice
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Vehicle Delivery/Dispatch Modal -->
<div class="modal fade modal-premium" id="deliveryModal" tabindex="-1" aria-labelledby="deliveryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deliveryModalLabel">
                    <i class="fas fa-truck"></i>
                    Vehicle Delivery
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="deliveryModalInfo">Arrange delivery for completed service <strong id="deliveryServiceId">REQ-1001</strong></span>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="detail-label">Vehicle</div>
                        <div class="detail-value" id="deliveryVehicleName">Honda City</div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-label">Registration Number</div>
                        <div class="detail-value" id="deliveryRegistrationNumber">MH02AB1234</div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label">Delivery Method</label>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="deliveryMethod" id="customerPickup" value="pickup" checked>
                        <label class="form-check-label" for="customerPickup">
                            <i class="fas fa-user me-2"></i> Customer Pickup
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deliveryMethod" id="homeDelivery" value="delivery">
                        <label class="form-check-label" for="homeDelivery">
                            <i class="fas fa-home me-2"></i> Home Delivery
                        </label>
                    </div>
                </div>

                <div id="pickupFields">
                    <div class="form-group mb-3">
                        <label for="pickupPerson" class="form-label">Person Collecting Vehicle</label>
                        <input type="text" class="form-control" id="pickupPerson" placeholder="Enter name of person collecting the vehicle">
                        <small class="form-text text-muted">This person must present valid ID</small>
                    </div>

                    <div class="form-group mb-3">
                        <label for="pickupTime" class="form-label">Expected Pickup Time</label>
                        <input type="datetime-local" class="form-control" id="pickupTime">
                    </div>
                </div>

                <div id="deliveryFields" style="display: none;">
                    <div class="form-group mb-3">
                        <label for="deliveryAddress" class="form-label">Delivery Address</label>
                        <textarea class="form-control" id="deliveryAddress" rows="3" placeholder="Enter delivery address"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="deliveryDate" class="form-label">Delivery Date</label>
                                <input type="date" class="form-control" id="deliveryDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="deliveryTimeSlot" class="form-label">Time Slot</label>
                                <select class="form-select" id="deliveryTimeSlot">
                                    <option value="">Select time slot</option>
                                    <option value="9AM-12PM">9:00 AM - 12:00 PM</option>
                                    <option value="12PM-3PM">12:00 PM - 3:00 PM</option>
                                    <option value="3PM-6PM">3:00 PM - 6:00 PM</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="deliveryContact" class="form-label">Contact Number</label>
                        <input type="tel" class="form-control" id="deliveryContact" placeholder="Enter contact number for delivery">
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="deliveryNotes" class="form-label">Delivery Notes</label>
                    <textarea class="form-control" id="deliveryNotes" rows="2" placeholder="Any special instructions for delivery or pickup"></textarea>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmDeliveryCheck" required>
                    <label class="form-check-label" for="confirmDeliveryCheck">
                        I confirm that all service work has been completed, invoice generated, and payment has been received
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-premium primary" id="confirmDeliveryBtn">
                    <i class="fas fa-check-circle"></i>
                    <span id="confirmDeliveryBtnText">Confirm Pickup</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade success-modal" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="success-icon-container">
                    <div class="success-icon-wrapper">
                        <div class="success-icon">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                </div>
                <h3 class="success-title" id="successTitle">Success!</h3>
                <p class="success-message" id="successMessage">Operation completed successfully.</p>
                <button type="button" class="continue-btn" data-bs-dismiss="modal">
                    <i class="fas fa-check-circle"></i>
                    Continue
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- jQuery and Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

<script>
    // JavaScript to manage completed services
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize app
        initializeApp();

        // Set up event listeners
        setupEventListeners();

        // Load completed services from API
        loadCompletedServicesFromAPI();
    });

    // Global variables
    let completedServices = [];
    let currentCompletedPage = 1;
    const itemsPerPage = 5;
    let currentServiceId = null;

    // Get JWT token from storage or URL
    function getJwtToken() {
        // First check URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const tokenFromUrl = urlParams.get('token');

        if (tokenFromUrl) {
            return tokenFromUrl;
        }

        // Then check local storage
        return localStorage.getItem("jwt-token") || sessionStorage.getItem("jwt-token");
    }

    // Initialize app
    function initializeApp() {
        // Setup mobile menu toggle
        setupMobileMenu();

        // Setup logout button
        setupLogout();

        // Setup token-based authentication
        setupAuthentication();

        // Set current date if element exists
        setupDateDisplay();

        // Initialize delivery method toggle
        initializeDeliveryMethodToggle();
    }

    function setupMobileMenu() {
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });
        }
    }

    function setupLogout() {
        const logoutBtn = document.querySelector('.logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                // Show confirmation dialog
                if (confirm('Are you sure you want to logout?')) {
                    // Clear storage
                    localStorage.removeItem("jwt-token");
                    sessionStorage.removeItem("jwt-token");
                    localStorage.removeItem("user-role");
                    localStorage.removeItem("user-name");
                    sessionStorage.removeItem("user-role");
                    sessionStorage.removeItem("user-name");

                    // Redirect to logout
                    window.location.href = '/admin/logout';
                }
            });
        }
    }

    function setupDateDisplay() {
        const dateElement = document.getElementById('current-date');
        if (dateElement) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const today = new Date();
            dateElement.textContent = today.toLocaleDateString('en-US', options);
        }
    }

    // Initialize delivery method toggle
    function initializeDeliveryMethodToggle() {
        const pickupRadio = document.getElementById('customerPickup');
        const deliveryRadio = document.getElementById('homeDelivery');
        const pickupFields = document.getElementById('pickupFields');
        const deliveryFields = document.getElementById('deliveryFields');
        const confirmDeliveryBtnText = document.getElementById('confirmDeliveryBtnText');

        if (pickupRadio && deliveryRadio) {
            pickupRadio.addEventListener('change', function() {
                if (this.checked) {
                    pickupFields.style.display = '';
                    deliveryFields.style.display = 'none';
                    confirmDeliveryBtnText.textContent = 'Confirm Pickup';
                }
            });

            deliveryRadio.addEventListener('change', function() {
                if (this.checked) {
                    pickupFields.style.display = 'none';
                    deliveryFields.style.display = '';
                    confirmDeliveryBtnText.textContent = 'Confirm Delivery';
                }
            });
        }
    }

    function setupAuthentication() {
        // Get token from storage
        const tokenFromStorage = getJwtToken();

        if (tokenFromStorage) {
            console.log("Token found in storage");

            // Check if current URL already has a token parameter
            const currentUrl = new URL(window.location.href);
            const urlToken = currentUrl.searchParams.get('token');

            // If URL doesn't have the token, update all navigation links
            if (!urlToken) {
                // Add token to all sidebar navigation links
                document.querySelectorAll('.sidebar-menu-link').forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && !href.includes('token=')) {
                        const separator = href.includes('?') ? '&' : '?';
                        link.setAttribute('href', href + separator + 'token=' + encodeURIComponent(tokenFromStorage));
                    }
                });

                // Add token to current URL for refresh protection
                if (window.location.href.indexOf('token=') === -1) {
                    const separator = window.location.href.indexOf('?') === -1 ? '?' : '&';
                    const newUrl = window.location.href + separator + 'token=' + encodeURIComponent(tokenFromStorage);
                    window.history.replaceState({}, document.title, newUrl);
                }
            }
        } else {
            console.warn("No token found in storage");
            // If no token is found, redirect to login
            window.location.href = '/admin/login?error=session_expired';
        }
    }

    function setupEventListeners() {
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                filterCompletedServices(this.value);
            });
        }

        // Table search for Completed Services
        const completedTableSearchInput = document.querySelector('.search-input-sm');
        if (completedTableSearchInput) {
            completedTableSearchInput.addEventListener('keyup', function() {
                filterTableRows(this.value, 'completedServicesTable');
            });
        }

        // Table pagination for Completed Services
        document.querySelectorAll('#paginationCompleted .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                if (!this.parentElement.classList.contains('disabled')) {
                    const page = this.getAttribute('data-page');
                    if (page) {
                        currentCompletedPage = parseInt(page);
                        updateCompletedPagination();
                        showCompletedServicesPage(currentCompletedPage);
                    }
                }
            });
        });

        // Previous & Next buttons for Completed Services
        document.getElementById('prevBtnCompleted').addEventListener('click', function(e) {
            e.preventDefault();
            if (currentCompletedPage > 1) {
                currentCompletedPage--;
                updateCompletedPagination();
                showCompletedServicesPage(currentCompletedPage);
            }
        });

        document.getElementById('nextBtnCompleted').addEventListener('click', function(e) {
            e.preventDefault();
            const totalPages = Math.ceil(completedServices.length / itemsPerPage);
            if (currentCompletedPage < totalPages) {
                currentCompletedPage++;
                updateCompletedPagination();
                showCompletedServicesPage(currentCompletedPage);
            }
        });

        // Apply Filter button
        document.getElementById('applyFilterBtn').addEventListener('click', function() {
            applyFilters();
        });

        // Download invoice button
        document.getElementById('downloadInvoiceBtn').addEventListener('click', function() {
            downloadInvoice();
        });

        // Payment confirmation
        document.getElementById('confirmPaymentBtn').addEventListener('click', function() {
            processPayment();
        });

        // Invoice generation
        document.getElementById('confirmGenerateInvoiceBtn').addEventListener('click', function() {
            generateInvoice();
        });

        // Delivery confirmation
        document.getElementById('confirmDeliveryBtn').addEventListener('click', function() {
            confirmDelivery();
        });
    }

    // Load completed services from API
    function loadCompletedServicesFromAPI() {
        // Show loading spinner
        document.getElementById('loading-row-completed').style.display = '';
        document.getElementById('empty-row-completed').style.display = 'none';

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Show spinner
        showSpinner();

        // API call to fetch completed services
        fetch('/admin/api/vehicle-tracking/completed-services?token=' + encodeURIComponent(token))
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Raw API response for completed services:', data);

                // Process each service to ensure data consistency
                data.forEach(service => {
                    enhanceServiceData(service);
                });

                completedServices = data;
                hideSpinner();

                // Hide loading spinner
                document.getElementById('loading-row-completed').style.display = 'none';

                // Check if there are services to display
                if (completedServices.length > 0) {
                    // Update pagination
                    updateCompletedPagination();

                    // Show first page
                    showCompletedServicesPage(currentCompletedPage);
                } else {
                    // Show enhanced empty state
                    document.getElementById('empty-row-completed').style.display = '';
                    document.getElementById('empty-row-completed').innerHTML = `
                <td colspan="10" class="text-center py-5">
                    <div class="my-5">
                        <i class="fas fa-check-circle fa-4x text-muted mb-4" style="opacity: 0.3;"></i>
                        <h4 class="text-wine">No Completed Services</h4>
                        <p class="text-muted mt-3">
                            There are no completed services to display.
                            <br>Completed vehicle services will appear here once they're finished.
                        </p>
                        <button class="btn-premium primary mt-3" onclick="refreshCompletedServices()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh Data
                        </button>
                    </div>
                </td>
                `;
                }
            })
            .catch(error => {
                console.error('Error fetching completed services:', error);
                hideSpinner();

                // Hide loading spinner and show empty state with error
                document.getElementById('loading-row-completed').style.display = 'none';
                document.getElementById('empty-row-completed').style.display = '';
                document.getElementById('empty-row-completed').innerHTML = `
                <td colspan="10" class="text-center py-5">
                    <div class="my-5">
                        <i class="fas fa-exclamation-triangle fa-4x text-danger mb-4"></i>
                        <h4 class="text-danger">Error Loading Services</h4>
                        <p class="text-muted mt-3">
                            We encountered a problem while loading completed services.
                            <br>Error: ${error.message}
                        </p>
                        <button class="btn-premium primary mt-3" onclick="refreshCompletedServices()">
                            <i class="fas fa-sync-alt"></i>
                            Try Again
                        </button>
                    </div>
                </td>
            `;
            });
    }

    // Comprehensive function to enhance service data
    function enhanceServiceData(service) {
        console.log('Enhancing service data for:', service);

        // Ensure consistent ID fields
        ensureConsistentIdFields(service);

        // Enhance vehicle information
        enhanceVehicleInfo(service);

        // Extract and enhance customer information
        enhanceCustomerInfo(service);

        // Format dates for display
        enhanceServiceDates(service);

        // Ensure financial information is present
        ensureFinancialData(service);

        // Ensure service status flags are present
        ensureServiceStatusFlags(service);

        console.log('Enhanced service data:', service);
    }

    // Ensure consistent ID fields (serviceId/requestId)
    function ensureConsistentIdFields(service) {
        // Make sure we have both serviceId and requestId consistently
        if (service.serviceId && !service.requestId) {
            service.requestId = service.serviceId;
        } else if (service.requestId && !service.serviceId) {
            service.serviceId = service.requestId;
        } else if (!service.serviceId && !service.requestId) {
            // This shouldn't happen, but just in case
            console.warn("Service missing both serviceId and requestId");
            service.serviceId = 0;
            service.requestId = 0;
        }
    }

    // Ensure vehicle information is complete and consistent
    function enhanceVehicleInfo(service) {
        // Ensure vehicle name exists
        if (!service.vehicleName || service.vehicleName == null) {
            // Try to construct from brand and model
            const brand = getStringValue(service, "vehicleBrand");
            const model = getStringValue(service, "vehicleModel");

            if (brand && model) {
                service.vehicleName = brand + " " + model;
            } else if (service.vehicle && service.vehicle.brand && service.vehicle.model) {
                service.vehicleName = service.vehicle.brand + " " + service.vehicle.model;
            } else {
                service.vehicleName = "Unknown Vehicle";
            }
        }

        // Ensure registration number is present
        if (!service.registrationNumber || service.registrationNumber == null) {
            // Try different possible field names
            if (service.vehicleRegistration) {
                service.registrationNumber = service.vehicleRegistration;
            } else if (service.regNumber) {
                service.registrationNumber = service.regNumber;
            } else if (service.registration) {
                service.registrationNumber = service.registration;
            } else if (service.vehicle && service.vehicle.registrationNumber) {
                service.registrationNumber = service.vehicle.registrationNumber;
            } else {
                // If still not found, use placeholder
                service.registrationNumber = "Unknown";
            }
        }

        // Ensure vehicle category is normalized
        if (!service.category) {
            if (service.vehicleType) {
                service.category = service.vehicleType;
            } else if (service.vehicle && service.vehicle.category) {
                service.category = service.vehicle.category;
            } else if (service.vehicleName && service.vehicleName.includes("Bike")) {
                service.category = "Bike";
            } else if (service.vehicleName && service.vehicleName.includes("Truck")) {
                service.category = "Truck";
            } else {
                // Default category
                service.category = "Car";
            }
        }

        // Normalize category formatting
        if (service.category) {
            service.category = capitalizeFirstLetter(service.category);
        }
    }

    // Enhanced function to extract and normalize customer information
    function enhanceCustomerInfo(service) {
        try {
            console.log("Raw customer data before enhancement:",
                service.customer ? JSON.stringify(service.customer, null, 2) : "No direct customer object");

            // EXTRACTING CUSTOMER NAME
            if (!service.customerName || service.customerName === null || service.customerName === '') {
                // Direct extraction from customer object
                if (service.customer) {
                    if (typeof service.customer === 'object') {
                        // Complete customer object with firstName and lastName
                        if (service.customer.firstName && service.customer.lastName) {
                            service.customerName = service.customer.firstName + ' ' + service.customer.lastName;
                        }
                        // Name in customer.name field
                        else if (service.customer.name) {
                            service.customerName = service.customer.name;
                        }
                        // Name in user object
                        else if (service.customer.user) {
                            if (service.customer.user.firstName && service.customer.user.lastName) {
                                service.customerName = service.customer.user.firstName + ' ' + service.customer.user.lastName;
                            } else if (service.customer.user.name) {
                                service.customerName = service.customer.user.name;
                            }
                        }
                    }
                    // If customer is just a string name
                    else if (typeof service.customer === 'string') {
                        service.customerName = service.customer;
                    }
                }

                // Try other possible field locations if still not found
                if (!service.customerName || service.customerName === null || service.customerName === '') {
                    if (service.user) {
                        if (service.user.firstName && service.user.lastName) {
                            service.customerName = service.user.firstName + ' ' + service.user.lastName;
                        } else if (service.user.name) {
                            service.customerName = service.user.name;
                        }
                    } else if (service.userName) {
                        service.customerName = service.userName;
                    } else if (service.client) {
                        if (typeof service.client === 'object') {
                            if (service.client.name) {
                                service.customerName = service.client.name;
                            } else if (service.client.firstName && service.client.lastName) {
                                service.customerName = service.client.firstName + ' ' + service.client.lastName;
                            }
                        } else if (typeof service.client === 'string') {
                            service.customerName = service.client;
                        }
                    } else {
                        service.customerName = "Unknown Customer";
                    }
                }
            }

            // EXTRACTING EMAIL
            // First clear any invalid values
            if (service.customerEmail === null || service.customerEmail === 'null' ||
                service.customerEmail === undefined || service.customerEmail === 'undefined') {
                service.customerEmail = '';
            }

            // Now try to extract from various places if not present or empty
            if (!service.customerEmail || service.customerEmail === '') {
                // Extract from customer object
                if (service.customer) {
                    if (typeof service.customer === 'object') {
                        if (service.customer.email) {
                            service.customerEmail = service.customer.email;
                        } else if (service.customer.user && service.customer.user.email) {
                            service.customerEmail = service.customer.user.email;
                        } else if (service.customer.emailAddress) {
                            service.customerEmail = service.customer.emailAddress;
                        }
                    }
                }

                // Try other possible field locations
                if (!service.customerEmail || service.customerEmail === '') {
                    if (service.email) {
                        service.customerEmail = service.email;
                    } else if (service.user && service.user.email) {
                        service.customerEmail = service.user.email;
                    } else if (service.user && service.user.emailAddress) {
                        service.customerEmail = service.user.emailAddress;
                    } else if (service.client && typeof service.client === 'object' && service.client.email) {
                        service.customerEmail = service.client.email;
                    } else {
                        service.customerEmail = "Not available";
                    }
                }
            }

            // EXTRACTING PHONE NUMBER
            // First clear any invalid values
            if (service.customerPhone === null || service.customerPhone === 'null' ||
                service.customerPhone === undefined || service.customerPhone === 'undefined') {
                service.customerPhone = '';
            }

            // Now try to extract from various places if not present or empty
            if (!service.customerPhone || service.customerPhone === '') {
                // Extract from customer object
                if (service.customer) {
                    if (typeof service.customer === 'object') {
                        if (service.customer.phoneNumber) {
                            service.customerPhone = service.customer.phoneNumber;
                        } else if (service.customer.phone) {
                            service.customerPhone = service.customer.phone;
                        } else if (service.customer.contact) {
                            service.customerPhone = service.customer.contact;
                        } else if (service.customer.mobile) {
                            service.customerPhone = service.customer.mobile;
                        } else if (service.customer.mobileNumber) {
                            service.customerPhone = service.customer.mobileNumber;
                        } else if (service.customer.user) {
                            if (service.customer.user.phoneNumber) {
                                service.customerPhone = service.customer.user.phoneNumber;
                            } else if (service.customer.user.phone) {
                                service.customerPhone = service.customer.user.phone;
                            } else if (service.customer.user.contact) {
                                service.customerPhone = service.customer.user.contact;
                            } else if (service.customer.user.mobile) {
                                service.customerPhone = service.customer.user.mobile;
                            }
                        }
                    }
                }

                // Try other possible field locations
                if (!service.customerPhone || service.customerPhone === '') {
                    if (service.phone) {
                        service.customerPhone = service.phone;
                    } else if (service.phoneNumber) {
                        service.customerPhone = service.phoneNumber;
                    } else if (service.contact) {
                        service.customerPhone = service.contact;
                    } else if (service.mobile) {
                        service.customerPhone = service.mobile;
                    } else if (service.user) {
                        if (service.user.phoneNumber) {
                            service.customerPhone = service.user.phoneNumber;
                        } else if (service.user.phone) {
                            service.customerPhone = service.user.phone;
                        } else if (service.user.contact) {
                            service.customerPhone = service.user.contact;
                        } else if (service.user.mobile) {
                            service.customerPhone = service.user.mobile;
                        }
                    } else if (service.client && typeof service.client === 'object') {
                        if (service.client.phoneNumber) {
                            service.customerPhone = service.client.phoneNumber;
                        } else if (service.client.phone) {
                            service.customerPhone = service.client.phone;
                        }
                    } else {
                        service.customerPhone = "Not available";
                    }
                }
            }

            // EXTRACTING MEMBERSHIP STATUS
            // First clear any invalid values
            if (service.membershipStatus === null || service.membershipStatus === 'null' ||
                service.membershipStatus === undefined || service.membershipStatus === 'undefined') {
                service.membershipStatus = '';
            }

            // Now try to extract from various places if not present or empty
            if (!service.membershipStatus || service.membershipStatus === '') {
                // Extract from customer object
                if (service.customer) {
                    if (typeof service.customer === 'object') {
                        if (service.customer.membershipStatus) {
                            service.membershipStatus = service.customer.membershipStatus;
                        } else if (service.customer.membership) {
                            service.membershipStatus = service.customer.membership;
                        } else if (service.customer.memberType) {
                            service.membershipStatus = service.customer.memberType;
                        } else if (service.customer.membershipType) {
                            service.membershipStatus = service.customer.membershipType;
                        } else if (service.customer.tier) {
                            service.membershipStatus = service.customer.tier;
                        } else if (service.customer.user) {
                            if (service.customer.user.membershipStatus) {
                                service.membershipStatus = service.customer.user.membershipStatus;
                            } else if (service.customer.user.membership) {
                                service.membershipStatus = service.customer.user.membership;
                            }
                        }
                    }
                }

                // Try other possible field locations
                if (!service.membershipStatus || service.membershipStatus === '') {
                    if (service.membership) {
                        service.membershipStatus = service.membership;
                    } else if (service.memberType) {
                        service.membershipStatus = service.memberType;
                    } else if (service.membershipType) {
                        service.membershipStatus = service.membershipType;
                    } else if (service.tier) {
                        service.membershipStatus = service.tier;
                    } else if (service.user) {
                        if (service.user.membershipStatus) {
                            service.membershipStatus = service.user.membershipStatus;
                        } else if (service.user.membership) {
                            service.membershipStatus = service.user.membership;
                        }
                    } else {
                        // Default value
                        service.membershipStatus = "Standard";
                    }
                }
            }

            // FORMATTING THE DATA
            // Format the name properly
            service.customerName = formatPersonName(service.customerName);

            // Format and validate email - ensure it has an @ symbol
            service.customerEmail = service.customerEmail.trim();
            if (!service.customerEmail.includes('@')) {
                service.customerEmail = "Not available";
            }

            // Format the phone number
            service.customerPhone = formatPhoneNumber(service.customerPhone);

            // Format the membership status
            service.membershipStatus = formatMembershipStatus(service.membershipStatus);

            console.log("Enhanced customer info:", {
                name: service.customerName,
                email: service.customerEmail,
                phone: service.customerPhone,
                membership: service.membershipStatus
            });
        } catch (e) {
            console.error("Error enhancing customer info:", e);
            // Set default values in case of error
            service.customerName = service.customerName || "Unknown Customer";
            service.customerPhone = service.customerPhone || "Not available";
            service.customerEmail = service.customerEmail || "Not available";
            service.membershipStatus = service.membershipStatus || "Standard";
        }
    }


    // Format and enhance date fields in the service map
    function enhanceServiceDates(service) {
        try {
            // List of date fields to format
            const dateFields = ['completedDate', 'requestDate', 'deliveryDate', 'updatedAt', 'createdAt', 'completionDate'];

            // Process each date field
            for (const fieldName of dateFields) {
                if (service[fieldName] && service[fieldName] !== null) {
                    try {
                        // Try to parse and format the date
                        const date = new Date(service[fieldName]);
                        if (!isNaN(date.getTime())) {
                            // Store the original date value
                            service['original' + capitalizeFirstLetter(fieldName)] = service[fieldName];

                            // Format the date in a user-friendly way
                            const options = { year: 'numeric', month: 'short', day: 'numeric' };
                            service['formatted' + capitalizeFirstLetter(fieldName)] = date.toLocaleDateString('en-US', options);
                        }
                    } catch (dateError) {
                        console.warn(`Error formatting date field ${fieldName}:`, dateError);
                    }
                }
            }

            // Ensure completedDate exists
            if (!service.completedDate || service.completedDate === null) {
                // Try using updatedAt as fallback
                if (service.updatedAt) {
                    service.completedDate = service.updatedAt;
                    try {
                        const date = new Date(service.updatedAt);
                        if (!isNaN(date.getTime())) {
                            service.formattedCompletedDate = date.toLocaleDateString('en-US', {
                                year: 'numeric', month: 'short', day: 'numeric'
                            });
                        }
                    } catch (e) {
                        console.warn("Error formatting fallback completedDate:", e);
                    }
                } else if (service.completionDate) {
                    // Try completionDate as another fallback
                    service.completedDate = service.completionDate;
                    try {
                        const date = new Date(service.completionDate);
                        if (!isNaN(date.getTime())) {
                            service.formattedCompletedDate = date.toLocaleDateString('en-US', {
                                year: 'numeric', month: 'short', day: 'numeric'
                            });
                        }
                    } catch (e) {
                        console.warn("Error formatting fallback completionDate:", e);
                    }
                } else {
                    // Last resort - use current date
                    const today = new Date();
                    service.completedDate = today.toISOString();
                    service.formattedCompletedDate = today.toLocaleDateString('en-US', {
                        year: 'numeric', month: 'short', day: 'numeric'
                    });
                }
            }
        } catch (e) {
            console.error("Error enhancing service dates:", e);
        }
    }

    // Ensure financial data is present and consistent
    function ensureFinancialData(service) {
        try {
            // Get materials total with fallback
            const materialsTotal = (() => {
                if (service.materialsTotal !== undefined && service.materialsTotal !== null) {
                    return parseFloat(service.materialsTotal);
                }

                // Calculate from materials array if available
                if (Array.isArray(service.materials) && service.materials.length > 0) {
                    return service.materials.reduce((sum, item) => {
                        const quantity = parseFloat(item.quantity || 1);
                        const unitPrice = parseFloat(item.unitPrice || 0);
                        return sum + (quantity * unitPrice);
                    }, 0);
                }

                return 0;
            })();

            // Get labor total with fallback
            const laborTotal = (() => {
                if (service.laborTotal !== undefined && service.laborTotal !== null) {
                    return parseFloat(service.laborTotal);
                }

                // Calculate from labor charges array if available
                if (Array.isArray(service.laborCharges) && service.laborCharges.length > 0) {
                    return service.laborCharges.reduce((sum, item) => {
                        return sum + parseFloat(item.total || 0);
                    }, 0);
                }

                return 0;
            })();

            // Update service with calculated values
            service.materialsTotal = materialsTotal;
            service.laborTotal = laborTotal;

            // Calculate discount if premium
            let discount = 0;
            if (service.membershipStatus.toLowerCase() === 'premium') {
                // 20% discount on labor
                discount = laborTotal * 0.2;
            }
            service.discount = discount;

            // Calculate subtotal
            const subtotal = materialsTotal + laborTotal - discount;
            service.subtotal = subtotal;

            // Calculate tax
            const tax = subtotal * 0.18; // 18% GST
            service.tax = tax;
            service.gst = tax; // Alternative field name

            // Calculate total cost
            const totalCost = subtotal + tax;
            service.totalCost = totalCost;
            service.totalAmount = totalCost; // For consistency
        } catch (e) {
            console.error("Error ensuring financial data:", e);

            // Set default values in case of error
            service.materialsTotal = 0;
            service.laborTotal = 0;
            service.discount = 0;
            service.subtotal = 0;
            service.tax = 0;
            service.gst = 0;
            service.totalCost = 0;
            service.totalAmount = 0;
        }
    }

    // Ensure service status flags are present
    function ensureServiceStatusFlags(service) {
        // Set default values for status flags if they don't exist
        service.hasBill = service.hasBill === true;
        service.isPaid = service.isPaid === true || service.paid === true;
        service.hasInvoice = service.hasInvoice === true;
        service.isDelivered = service.isDelivered === true || service.delivered === true;
        service.paid = service.isPaid; // For consistency
        service.delivered = service.isDelivered; // For consistency
    }

    // Show spinner overlay
    function showSpinner() {
        const spinnerOverlay = document.getElementById('spinnerOverlay');
        if (spinnerOverlay) {
            spinnerOverlay.classList.add('show');
        }
    }

    // Hide spinner overlay
    function hideSpinner() {
        const spinnerOverlay = document.getElementById('spinnerOverlay');
        if (spinnerOverlay) {
            spinnerOverlay.classList.remove('show');
        }
    }

    // Refresh completed services
    function refreshCompletedServices() {
        loadCompletedServicesFromAPI();
    }

    // Update pagination for completed services
    function updateCompletedPagination() {
        const totalPages = Math.ceil(completedServices.length / itemsPerPage);
        const paginationEl = document.getElementById('paginationCompleted');

        if (!paginationEl) return;

        // Clear existing page links (except prev/next)
        const pageLinks = paginationEl.querySelectorAll('.page-link[data-page]');
        pageLinks.forEach(link => {
            link.parentElement.remove();
        });

        // Get prev/next buttons
        const prevBtn = document.getElementById('prevBtnCompleted');
        const nextBtn = document.getElementById('nextBtnCompleted');
        const prevItem = prevBtn.parentElement;
        const nextItem = nextBtn.parentElement;

        // Disable/enable prev button
        if (currentCompletedPage === 1) {
            prevItem.classList.add('disabled');
        } else {
            prevItem.classList.remove('disabled');
        }

        // Disable/enable next button
        if (currentCompletedPage === totalPages || totalPages === 0) {
            nextItem.classList.add('disabled');
        } else {
            nextItem.classList.remove('disabled');
        }

        // Add page links
        let startPage = Math.max(1, currentCompletedPage - 1);
        let endPage = Math.min(totalPages, startPage + 2);

        if (endPage - startPage < 2) {
            startPage = Math.max(1, endPage - 2);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageItem = document.createElement('li');
            pageItem.classList.add('page-item');
            if (i === currentCompletedPage) {
                pageItem.classList.add('active');
            }

            const pageLink = document.createElement('a');
            pageLink.classList.add('page-link');
            pageLink.setAttribute('href', '#');
            pageLink.setAttribute('data-page', i);
            pageLink.textContent = i;

            pageLink.addEventListener('click', function(e) {
                e.preventDefault();
                currentCompletedPage = i;
                updateCompletedPagination();
                showCompletedServicesPage(currentCompletedPage);
            });

            pageItem.appendChild(pageLink);
            nextItem.parentElement.insertBefore(pageItem, nextItem);
        }
    }

    // Show completed services page
    function showCompletedServicesPage(page) {
        const tableBody = document.getElementById('completedServicesTableBody');
        if (!tableBody) return;

        // Calculate start and end index
        const startIdx = (page - 1) * itemsPerPage;
        const endIdx = Math.min(startIdx + itemsPerPage, completedServices.length);

        // Clear loading and empty rows
        document.getElementById('loading-row-completed').style.display = 'none';
        document.getElementById('empty-row-completed').style.display = 'none';

        // Clear existing data rows
        const existingRows = tableBody.querySelectorAll('tr:not(#loading-row-completed):not(#empty-row-completed)');
        existingRows.forEach(row => row.remove());

        // Add data rows
        for (let i = startIdx; i < endIdx; i++) {
            const service = completedServices[i];
            const row = createServiceRow(service);
            tableBody.appendChild(row);
        }
    }

    // Create a service row
    function createServiceRow(service) {
        const row = document.createElement('tr');
        row.classList.add('active-page');
        row.dataset.serviceId = service.serviceId || service.requestId;

        // Extract and format data
        const serviceId = service.serviceId || service.requestId;
        const vehicleName = service.vehicleName || 'Unknown Vehicle';
        const registrationNumber = service.registrationNumber || 'N/A';

        // Determine vehicle category and icon
        const category = service.category || 'Car';
        const categoryIcon = category.toLowerCase() === 'bike' ? 'fas fa-motorcycle' :
            category.toLowerCase() === 'truck' ? 'fas fa-truck' : 'fas fa-car';

        // Format customer details using our enhanced values
        const customerName = service.customerName || 'Not available';
        const customerEmail = service.customerEmail || 'No email provided';
        const customerPhone = service.customerPhone || 'No phone provided';

        // Format membership status using our enhanced value
        const membershipStatus = service.membershipStatus || 'Standard';

        // Format service type
        const serviceType = capitalizeEachWord(service.serviceType || 'General Service');

        // Format date - use our enhanced formatted date if available
        const completedDate = service.formattedCompletedDate || formatDate(service.completedDate || service.completionDate || service.updatedAt);

        // Format amount using the normalized total cost value
        const totalAmount = formatCurrency(service.totalCost || service.totalAmount || 0);

        // Check invoice status
        const hasInvoice = service.hasInvoice || false;

        row.innerHTML = `
    <td>REQ-${serviceId}</td>
    <td>
        <div class="vehicle-info">
            <div class="vehicle-icon">
                <i class="${categoryIcon}"></i>
            </div>
            <div class="vehicle-details">
                <h5>${vehicleName}</h5>
                <p>${registrationNumber}</p>
            </div>
        </div>
    </td>
    <td>
        <div class="person-info">
            <div class="person-details">
                <h5>${customerName}</h5>
                <p>
                    <i class="fas fa-envelope me-1 text-muted"></i> ${customerEmail}<br>
                    <i class="fas fa-phone me-1 text-muted"></i> ${customerPhone}
                </p>
            </div>
        </div>
    </td>
    <td>
        <span class="membership-badge ${membershipStatus.toLowerCase() === 'premium' ? 'membership-premium' : 'membership-standard'}">
            ${membershipStatus}
        </span>
    </td>
    <td>${serviceType}</td>
    <td>${completedDate}</td>
    <td>${totalAmount}</td>
    <td>
        ${hasInvoice ?
            `<span class="status-badge status-completed">
                <i class="fas fa-check-circle"></i> Generated
            </span>` :
            `<span class="status-badge status-pending">
                <i class="fas fa-clock"></i> Pending
            </span>`
        }
    </td>
    <td>
        <div class="table-actions-cell">
            <button class="btn-table-action" onclick="viewServiceDetails(${serviceId})">
                <i class="fas fa-eye"></i>
            </button>
            ${hasInvoice ?
            `<button class="btn-table-action success" onclick="downloadInvoiceById(${serviceId})">
                    <i class="fas fa-file-download"></i>
                </button>` : ''
        }
        </div>
    </td>
`;

        return row;
    }

    // Format membership status with proper capitalization
    function formatMembershipStatus(status) {
        if (!status) return 'Standard';

        // Convert to string and trim
        status = String(status).trim().toLowerCase();

        // Handle empty string
        if (status === '') return 'Standard';

        // Handle common variations
        if (status === 'Premium' || status === 'gold' || status === 'vip') {
            return 'Premium';
        }

        if (status === 'Standard' || status === 'basic' || status === 'regular' || status === 'normal') {
            return 'Standard';
        }

        // Default capitalization for other values
        return status.charAt(0).toUpperCase() + status.slice(1);
    }

    // Format a person's name properly
    function formatPersonName(name) {
        if (!name) return 'Not available';

        // If it's "Not assigned" or similar, return as is
        if (name === 'Not assigned' || name === 'Not available') return name;

        // Convert to string and trim
        name = String(name).trim();

        // Handle empty string
        if (name === '') return 'Not available';

        // Split by spaces and capitalize each part
        return name.split(' ')
            .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
            .join(' ');
    }

    // Format phone number
    function formatPhoneNumber(phone) {
        if (!phone) return '';

        // Convert to string and remove non-digit characters
        phone = String(phone).trim();

        // Check if it's a valid phone number format
        if (phone === '' || phone === 'Not available' || phone === 'No phone provided') {
            return 'Not available';
        }

        // For Indian phone numbers: if it's a 10-digit number, format as +91 XXXXX XXXXX
        const digits = phone.replace(/\D/g, '');
        if (/^\d{10}$/.test(digits)) {
            return `+91 ${digits.substring(0, 5)} ${digits.substring(5)}`;
        }

        // If it's a long number with country code
        if (/^\d{11,12}$/.test(digits) && (digits.startsWith('91'))) {
            return `+${digits.substring(0, 2)} ${digits.substring(2, 7)} ${digits.substring(7)}`;
        }

        // Otherwise, return as is
        return phone;
    }

    // Capitalize first letter of each word
    function capitalizeEachWord(text) {
        if (!text) return '';

        // Convert to string and trim
        text = String(text).trim();

        // Split by spaces and capitalize first letter of each word
        return text.split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
    }

    // Capitalize only first letter
    function capitalizeFirstLetter(text) {
        if (!text) return '';

        // Convert to string and trim
        text = String(text).trim();

        // Capitalize first letter only
        return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
    }

    // Helper function to safely get string value from a service object
    function getStringValue(service, key) {
        if (service && service[key] !== undefined && service[key] !== null) {
            return String(service[key]).trim();
        }
        return null;
    }

    // Format date with better error handling
    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';

        try {
            // Handle different date formats
            let date;
            if (typeof dateStr === 'string') {
                // Try parsing ISO format
                date = new Date(dateStr);
            } else if (dateStr instanceof Date) {
                date = dateStr;
            } else {
                return dateStr.toString();
            }

            if (isNaN(date.getTime())) return dateStr;

            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        } catch (e) {
            console.error("Error formatting date:", e);
            return dateStr || 'N/A';
        }
    }

    // Format currency with better error handling
    function formatCurrency(amount) {
        try {
            // Handle various input types
            if (amount === null || amount === undefined) return '0.00';

            // Convert to number if it's a string
            if (typeof amount === 'string') {
                // Remove currency symbol and commas
                amount = amount.replace(/[,]/g, '');
            }

            // Convert to a number and format
            const numAmount = parseFloat(amount);
            if (isNaN(numAmount)) return '0.00';

            return '' + numAmount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        } catch (e) {
            console.error("Error formatting currency:", e);
            return '0.00';
        }
    }

    // View service details with improved data handling
    function viewServiceDetails(serviceId) {
        // Save current service ID
        currentServiceId = serviceId;

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Show spinner
        showSpinner();

        // Extract the table row data first for use as fallback
        const tableRow = document.querySelector(`tr[data-service-id="${serviceId}"]`);
        let tableData = null;

        if (tableRow) {
            // Extract data from the table row to use as fallback
            tableData = {
                serviceId: serviceId,
                vehicleName: tableRow.querySelector('.vehicle-details h5')?.textContent?.trim() || '',
                registrationNumber: tableRow.querySelector('.vehicle-details p')?.textContent?.trim() || '',
                customerName: tableRow.querySelector('.person-details h5')?.textContent?.trim() || '',
                customerEmail: tableRow.querySelector('.person-details p')?.innerText.includes('@') ?
                    tableRow.querySelector('.person-details p')?.innerText.split('@')[0] + '@' +
                    tableRow.querySelector('.person-details p')?.innerText.split('@')[1].split('\n')[0] : '',
                customerPhone: tableRow.querySelector('.person-details p')?.innerText.includes('phone') ?
                    tableRow.querySelector('.person-details p')?.innerText.split('\n')[1].replace(/[^+0-9 ]/g, '').trim() : '',
                membershipStatus: tableRow.querySelector('.membership-badge')?.textContent?.trim() || 'Standard',
                serviceType: tableRow.cells[4]?.textContent?.trim() || '',
                completedDate: tableRow.cells[5]?.textContent?.trim() || '',
                totalCost: tableRow.cells[6]?.textContent?.replace(/[,]/g, '') || '0'
            };
            console.log("Extracted table data:", tableData);
        }

        // First, try to get the service from our existing data
        const existingService = completedServices.find(s => (s.serviceId == serviceId || s.requestId == serviceId));

        if (existingService) {
            console.log("Using existing service data:", existingService);
            hideSpinner();

            // Merge with table data for completeness
            const mergedData = mergeServiceData(existingService, tableData);
            populateServiceDetailsModal(mergedData);

            // Show the modal
            new bootstrap.Modal(document.getElementById('viewServiceDetailsModal')).show();
            return;
        }

        // If not found in existing data, fetch from API
        fetch(`/admin/api/vehicle-tracking/service-request/${serviceId}?token=${encodeURIComponent(token)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // Debug logging
                console.log("API RESPONSE:", data);
                console.log("Customer data path:", data.customer ? JSON.stringify(data.customer, null, 2) : "No customer object");

                // Enhance the data
                enhanceServiceData(data);

                // Merge API data with table data
                const mergedData = mergeServiceData(data, tableData);

                hideSpinner();
                populateServiceDetailsModal(mergedData);

                // Show the modal
                new bootstrap.Modal(document.getElementById('viewServiceDetailsModal')).show();
            })
            .catch(error => {
                hideSpinner();
                console.error('Error fetching service details:', error);

                // If API fails but we have table data, use that
                if (tableData) {
                    console.log("Using table data as fallback");
                    // Enhance the table data
                    enhanceServiceData(tableData);
                    populateServiceDetailsModal(tableData);
                    new bootstrap.Modal(document.getElementById('viewServiceDetailsModal')).show();
                } else {
                    showToast('Error', 'Failed to fetch service details: ' + error.message, 'error');
                }
            });
    }

    // Helper function to merge API data with table data - improved version
    function mergeServiceData(apiData, tableData) {
        if (!tableData) return apiData;

        const merged = {...apiData};

        // Only use table data as fallback if API data is missing or incomplete

        // Vehicle information
        if (!merged.vehicleName && tableData.vehicleName) merged.vehicleName = tableData.vehicleName;
        if (!merged.registrationNumber && tableData.registrationNumber) merged.registrationNumber = tableData.registrationNumber;

        // Customer information
        if (!merged.customerName && tableData.customerName) merged.customerName = tableData.customerName;
        if (!merged.customerEmail && tableData.customerEmail) merged.customerEmail = tableData.customerEmail;
        if (!merged.customerPhone && tableData.customerPhone) merged.customerPhone = tableData.customerPhone;
        if (!merged.membershipStatus && tableData.membershipStatus) merged.membershipStatus = tableData.membershipStatus;

        // Service information
        if (!merged.serviceType && tableData.serviceType) merged.serviceType = tableData.serviceType;
        if (!merged.completedDate && tableData.completedDate) merged.completedDate = tableData.completedDate;
        if ((!merged.totalCost && !merged.totalAmount) && tableData.totalCost) {
            merged.totalCost = tableData.totalCost;
            merged.totalAmount = tableData.totalCost;
        }

        // Ensure vehicle category is set
        if (!merged.category) {
            merged.category = merged.vehicleType ||
                (merged.vehicleName?.includes('Bike') ? 'Bike' :
                    merged.vehicleName?.includes('Truck') ? 'Truck' : 'Car');
        }

        // Make sure we've applied all our data enhancement functions
        enhanceServiceData(merged);

        return merged;
    }

    // Populate service details modal with comprehensive data handling
    function populateServiceDetailsModal(service) {
        console.log("Populating modal with:", service);

        // Basic info
        document.getElementById('viewServiceId').textContent = 'REQ-' + (service.requestId || service.serviceId || '');

        // Status
        document.getElementById('viewStatus').innerHTML = `
        <span class="status-badge status-completed">
            <i class="fas fa-check-circle"></i> ${service.status || 'Completed'}
        </span>
    `;

        // Completion Date - use formatted date if available
        let completionDate = service.formattedCompletedDate || formatDate(service.completedDate || service.completionDate || service.updatedAt || 'N/A');
        document.getElementById('viewCompletionDate').textContent = completionDate;

        // Vehicle info
        document.getElementById('viewVehicleName').textContent = service.vehicleName || 'Unknown Vehicle';
        document.getElementById('viewRegistrationNumber').textContent = service.registrationNumber || 'N/A';
        document.getElementById('viewVehicleCategory').textContent = capitalizeFirstLetter(service.category || 'Car');

        // Customer info - using our enhanced data
        document.getElementById('viewCustomerName').textContent = service.customerName || 'Not available';

        // Contact info - using our enhanced data
        const customerContactEl = document.getElementById('viewCustomerContact');
        if (customerContactEl) {
            let contactHtml = '';

            // Add phone if available
            if (service.customerPhone && service.customerPhone !== 'Not available') {
                contactHtml += `<i class="fas fa-phone me-1"></i> ${service.customerPhone}<br>`;
            }

            // Add email if available
            if (service.customerEmail && service.customerEmail !== 'Not available') {
                contactHtml += `<i class="fas fa-envelope me-1"></i> ${service.customerEmail}`;
            }

            customerContactEl.innerHTML = contactHtml || 'No contact information available';
        }

        // Membership - using our enhanced data
        document.getElementById('viewMembership').textContent = service.membershipStatus || 'Standard';

        // Service info
        document.getElementById('viewServiceType').textContent = capitalizeEachWord(service.serviceType || 'General Service');
        document.getElementById('viewServiceAdvisor').textContent = formatPersonName(service.serviceAdvisorName || 'Not assigned');

        // Total amount - using our calculated financial data
        document.getElementById('viewTotalAmount').textContent = formatCurrency(service.totalCost || service.totalAmount || 0);

        // Service description
        document.getElementById('viewServiceDescription').textContent =
            service.additionalDescription || service.serviceDescription || 'No description provided.';

        // Materials and labor tables
        populateMaterialsTable(service.materials || []);
        populateLaborTable(service.laborCharges || []);

        // Invoice summary - using our calculated financial data
        updateInvoiceSummary(service);

        // Update workflow steps - using our enhanced status data
        updateWorkflowSteps(service);

        // Update action buttons - using our enhanced status data
        updateServiceActionButtons(service);
    }

    // Populate materials table
    function populateMaterialsTable(materials) {
        const tableBody = document.getElementById('materialsTableBody');
        tableBody.innerHTML = '';

        let materialsTotalCost = 0;

        if (!materials || materials.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td colspan="4" class="text-center">No materials recorded for this service.</td>
        `;
            tableBody.appendChild(row);
        } else {
            materials.forEach(material => {
                const row = document.createElement('tr');

                // Safely get values with fallbacks
                const name = material.name || 'Unknown Item';
                const quantity = parseFloat(material.quantity || 1);
                const unitPrice = parseFloat(material.unitPrice || 0);
                const totalItemCost = material.total || (quantity * unitPrice);

                materialsTotalCost += parseFloat(totalItemCost);

                row.innerHTML = `
                <td>${name}</td>
                <td>${quantity}</td>
                <td>${formatCurrency(unitPrice)}</td>
                <td>${formatCurrency(totalItemCost)}</td>
            `;

                tableBody.appendChild(row);
            });

            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
            <td colspan="3" class="text-end fw-bold">Materials Total</td>
            <td class="fw-bold">${formatCurrency(materialsTotalCost)}</td>
        `;
            tableBody.appendChild(totalRow);
        }

        // Update summary
        document.getElementById('summaryMaterialsTotal').textContent = formatCurrency(materialsTotalCost);
    }

    // Populate labor table
    function populateLaborTable(laborCharges) {
        const tableBody = document.getElementById('laborChargesTableBody');
        tableBody.innerHTML = '';

        let laborTotalCost = 0;

        if (!laborCharges || laborCharges.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td colspan="4" class="text-center">No labor charges recorded for this service.</td>
        `;
            tableBody.appendChild(row);
        } else {
            laborCharges.forEach(labor => {
                const row = document.createElement('tr');

                // Safely parse labor values
                const description = labor.description || 'Service Labor';
                const hours = parseFloat(labor.hours || 1);
                const rate = parseFloat(labor.ratePerHour || 0);
                const total = parseFloat(labor.total || (hours * rate));

                laborTotalCost += total;

                row.innerHTML = `
                <td>${description}</td>
                <td>${hours}</td>
                <td>${formatCurrency(rate)}</td>
                <td>${formatCurrency(total)}</td>
            `;

                tableBody.appendChild(row);
            });

            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
            <td colspan="3" class="text-end fw-bold">Labor Total</td>
            <td class="fw-bold">${formatCurrency(laborTotalCost)}</td>
        `;
            tableBody.appendChild(totalRow);
        }

        // Update summary
        document.getElementById('summaryLaborTotal').textContent = formatCurrency(laborTotalCost);
    }

    // Update invoice summary
    function updateInvoiceSummary(service) {
        // Get values with fallbacks
        const materialsTotal = parseFloat(service.materialsTotal || 0) ||
            parseFloat(document.getElementById('summaryMaterialsTotal').textContent.replace(/[,]/g, '')) || 0;

        const laborTotal = parseFloat(service.laborTotal || 0) ||
            parseFloat(document.getElementById('summaryLaborTotal').textContent.replace(/[,]/g, '')) || 0;

        // Calculate discount for premium members - use properly formatted membership status
        const membershipStatus = formatMembershipStatus(service.membershipStatus || 'Standard');
        const isPremium = membershipStatus.toLowerCase() === 'premium';
        const premiumDiscountRow = document.getElementById('premiumDiscountRow');
        let discount = 0;

        if (isPremium) {
            // 20% discount on labor
            discount = laborTotal * 0.20;
            document.getElementById('summaryDiscount').textContent = '-' + formatCurrency(discount);
            premiumDiscountRow.style.display = '';
        } else {
            premiumDiscountRow.style.display = 'none';
        }

        // Calculate subtotal
        const subtotal = parseFloat(service.subtotal || 0) || (materialsTotal + laborTotal - discount);
        document.getElementById('summarySubtotal').textContent = formatCurrency(subtotal);

        // Calculate GST (18%)
        const gst = parseFloat(service.gst || service.tax || 0) || (subtotal * 0.18);
        document.getElementById('summaryGST').textContent = formatCurrency(gst);

        // Calculate grand total
        const grandTotal = parseFloat(service.totalCost || service.totalAmount || 0) || (subtotal + gst);
        document.getElementById('summaryGrandTotal').textContent = formatCurrency(grandTotal);
    }

    // Update workflow steps
    function updateWorkflowSteps(service) {
        // Reset all steps
        document.querySelectorAll('.workflow-step').forEach(step => {
            step.classList.remove('active', 'completed');
        });

        // Check service status with fallbacks
        const hasBill = service.hasBill === true;
        const isPaid = service.isPaid === true || service.paid === true;
        const hasInvoice = service.hasInvoice === true;
        const isDelivered = service.isDelivered === true || service.delivered === true;

        // Update bill step
        if (hasBill) {
            document.getElementById('stepBill').classList.add('completed');
        } else {
            document.getElementById('stepBill').classList.add('active');
        }

        // Update payment step
        if (isPaid) {
            document.getElementById('stepPayment').classList.add('completed');
        } else if (hasBill) {
            document.getElementById('stepPayment').classList.add('active');
        }

        // Update invoice step
        if (hasInvoice) {
            document.getElementById('stepInvoice').classList.add('completed');
        } else if (isPaid) {
            document.getElementById('stepInvoice').classList.add('active');
        }

        // Update delivery step
        if (isDelivered) {
            document.getElementById('stepDelivery').classList.add('completed');
        } else if (hasInvoice) {
            document.getElementById('stepDelivery').classList.add('active');
        }
    }

    // Update service action buttons
    function updateServiceActionButtons(service) {
        const footer = document.getElementById('completedServiceFooter');

        // Clear existing action buttons (except close)
        const existingButtons = footer.querySelectorAll('button:not([data-bs-dismiss="modal"])');
        existingButtons.forEach(button => {
            if (!button.classList.contains('btn-premium')) {
                button.remove();
            }
        });

        // Check service status with fallbacks
        const hasBill = service.hasBill === true;
        const isPaid = service.isPaid === true || service.paid === true;
        const hasInvoice = service.hasInvoice === true;
        const isDelivered = service.isDelivered === true || service.delivered === true;

        // Add appropriate action buttons
        if (!hasBill) {
            // Add generate bill button
            const generateBillBtn = document.createElement('button');
            generateBillBtn.type = 'button';
            generateBillBtn.className = 'btn-premium primary';
            generateBillBtn.innerHTML = '<i class="fas fa-file-invoice-dollar"></i> Generate Bill';
            generateBillBtn.addEventListener('click', function() {
                // Close the current modal
                bootstrap.Modal.getInstance(document.getElementById('viewServiceDetailsModal')).hide();

                // Open bill generation modal
                generateBill(service);
            });

            footer.appendChild(generateBillBtn);
        } else if (!isPaid) {
            // Add process payment button
            const processPaymentBtn = document.createElement('button');
            processPaymentBtn.type = 'button';
            processPaymentBtn.className = 'btn-premium primary';
            processPaymentBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Process Payment';
            processPaymentBtn.addEventListener('click', function() {
                // Close the current modal
                bootstrap.Modal.getInstance(document.getElementById('viewServiceDetailsModal')).hide();

                // Open payment modal
                openPaymentModal(service);
            });

            footer.appendChild(processPaymentBtn);
        } else if (!hasInvoice) {
            // Add generate invoice button
            const generateInvoiceBtn = document.createElement('button');
            generateInvoiceBtn.type = 'button';
            generateInvoiceBtn.className = 'btn-premium primary';
            generateInvoiceBtn.innerHTML = '<i class="fas fa-file-invoice"></i> Generate Invoice';
            generateInvoiceBtn.addEventListener('click', function() {
                // Close the current modal
                bootstrap.Modal.getInstance(document.getElementById('viewServiceDetailsModal')).hide();

                // Open invoice generation modal
                openInvoiceModal(service);
            });

            footer.appendChild(generateInvoiceBtn);
        } else if (!isDelivered) {
            // Add dispatch vehicle button
            const dispatchBtn = document.createElement('button');
            dispatchBtn.type = 'button';
            dispatchBtn.className = 'btn-premium primary';
            dispatchBtn.innerHTML = '<i class="fas fa-truck"></i> Dispatch Vehicle';
            dispatchBtn.addEventListener('click', function() {
                // Close the current modal
                bootstrap.Modal.getInstance(document.getElementById('viewServiceDetailsModal')).hide();

                // Open delivery modal
                openDeliveryModal(service);
            });

            footer.appendChild(dispatchBtn);
        }

        // Add download invoice button if available
        if (hasInvoice) {
            const downloadInvoiceBtn = document.createElement('button');
            downloadInvoiceBtn.type = 'button';
            downloadInvoiceBtn.className = 'btn-table-action success ms-2';
            downloadInvoiceBtn.id = 'downloadInvoiceBtn';
            downloadInvoiceBtn.innerHTML = '<i class="fas fa-file-download"></i> Download Invoice';
            downloadInvoiceBtn.addEventListener('click', function() {
                downloadInvoice();
            });

            footer.appendChild(downloadInvoiceBtn);
        }
    }

    // Filter completed services
    function filterCompletedServices(searchText) {
        if (!searchText || searchText.trim() === '') {
            showCompletedServicesPage(currentCompletedPage);
            return;
        }

        searchText = searchText.toLowerCase().trim();

        const filteredServices = completedServices.filter(service => {
            return (
                (service.vehicleName && service.vehicleName.toLowerCase().includes(searchText)) ||
                (service.registrationNumber && service.registrationNumber.toLowerCase().includes(searchText)) ||
                (service.customerName && service.customerName.toLowerCase().includes(searchText)) ||
                (service.customerPhone && service.customerPhone.toLowerCase().includes(searchText)) ||
                (service.customerEmail && service.customerEmail.toLowerCase().includes(searchText)) ||
                (service.serviceType && service.serviceType.toLowerCase().includes(searchText)) ||
                ('req-' + service.serviceId).toLowerCase().includes(searchText) ||
                (service.membershipStatus && service.membershipStatus.toLowerCase().includes(searchText))
            );
        });

        const tableBody = document.getElementById('completedServicesTableBody');
        if (!tableBody) return;

        // Clear loading and empty rows
        document.getElementById('loading-row-completed').style.display = 'none';

        // Clear existing data rows
        const existingRows = tableBody.querySelectorAll('tr:not(#loading-row-completed):not(#empty-row-completed)');
        existingRows.forEach(row => row.remove());

        if (filteredServices.length === 0) {
            // Show no results message
            document.getElementById('empty-row-completed').style.display = '';
            document.getElementById('empty-row-completed').innerHTML = `
            <td colspan="10" class="text-center py-5">
                <div class="my-4">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5>No matching services found</h5>
                    <p class="text-muted">Try a different search term</p>
                </div>
            </td>
        `;
        } else {
            document.getElementById('empty-row-completed').style.display = 'none';

            // Add filtered services
            filteredServices.forEach(service => {
                const row = createServiceRow(service);
                tableBody.appendChild(row);
            });
        }
    }

    // Filter table rows
    function filterTableRows(searchText, tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;

        const rows = table.querySelectorAll('tbody tr:not(#loading-row-completed):not(#empty-row-completed)');

        if (!searchText || searchText.trim() === '') {
            // Reset to current page
            showCompletedServicesPage(currentCompletedPage);
            return;
        }

        searchText = searchText.toLowerCase().trim();

        rows.forEach(row => {
            const rowText = row.textContent.toLowerCase();
            if (rowText.includes(searchText)) {
                row.style.display = '';
                row.classList.add('active-page');
            } else {
                row.style.display = 'none';
                row.classList.remove('active-page');
            }
        });
    }

    // Apply filters from modal
    function applyFilters() {
        // Get filter values
        const vehicleType = document.getElementById('filterByVehicleType').value;
        const serviceType = document.getElementById('filterByServiceType').value;
        const paymentStatus = document.getElementById('filterByPaymentStatus').value;
        const invoiceStatus = document.getElementById('filterByInvoiceStatus').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Prepare filter criteria
        const filterCriteria = {};

        if (vehicleType) filterCriteria.vehicleType = vehicleType;
        if (serviceType) filterCriteria.serviceType = serviceType;
        if (paymentStatus) filterCriteria.paymentStatus = paymentStatus;
        if (invoiceStatus) filterCriteria.invoiceStatus = invoiceStatus;
        if (dateFrom) filterCriteria.dateFrom = dateFrom;
        if (dateTo) filterCriteria.dateTo = dateTo;

        // Show spinner
        showSpinner();

        // Close the filter modal
        bootstrap.Modal.getInstance(document.getElementById('filterServicesModal')).hide();

        // Make API request
        fetch('/admin/api/vehicle-tracking/completed-services/filter?token=' + encodeURIComponent(token), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filterCriteria)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Filter API response:', data);

                // Process the data to ensure consistency
                data.forEach(service => {
                    enhanceServiceData(service);
                });

                hideSpinner();

                // Update global services array
                completedServices = data;

                // Reset to page 1
                currentCompletedPage = 1;

                // Update display
                updateCompletedPagination();
                showCompletedServicesPage(currentCompletedPage);

                // Show toast notification
                showToast(
                    'Filters Applied',
                    `Found ${completedServices.length} service${completedServices.length !== 1 ? 's' : ''} matching your criteria.`,
                    'success'
                );
            })
            .catch(error => {
                hideSpinner();
                console.error('Error applying filters:', error);
                showToast('Error', 'Failed to apply filters: ' + error.message, 'error');
            });
    }

    // Generate bill
    function generateBill(service) {
        // Populate bill generation modal with service details
        document.getElementById('billServiceId').textContent = 'REQ-' + service.serviceId;
        document.getElementById('billCustomerName').textContent = service.customerName;
        document.getElementById('billVehicleName').textContent = service.vehicleName;
        document.getElementById('billVehicleRegistration').textContent = service.registrationNumber;
        document.getElementById('billMembershipStatus').textContent = service.membershipStatus;

        // Set premium flag for discount display
        const isPremium = service.membershipStatus.toLowerCase() === 'premium';
        if (isPremium) {
            document.getElementById('billPremiumDiscount').style.display = '';
        } else {
            document.getElementById('billPremiumDiscount').style.display = 'none';
        }

        // Use our calculated financial data
        const materialsTotal = service.materialsTotal || 0;
        const laborTotal = service.laborTotal || 0;

        // Set materials and labor totals
        document.getElementById('billMaterialsTotal').textContent = formatCurrency(materialsTotal);
        document.getElementById('billLaborTotal').textContent = formatCurrency(laborTotal);

        // Calculate discount if premium
        let discount = 0;
        if (isPremium) {
            discount = laborTotal * 0.2;
            document.getElementById('billDiscountAmount').textContent = formatCurrency(discount);
        }

        // Calculate subtotal
        const subtotal = materialsTotal + laborTotal - discount;
        document.getElementById('billSubtotal').textContent = formatCurrency(subtotal);

        // Calculate GST
        const gst = subtotal * 0.18;
        document.getElementById('billGST').textContent = formatCurrency(gst);

        // Calculate total
        const total = subtotal + gst;
        document.getElementById('billTotal').textContent = formatCurrency(total);

        // Show the modal
        new bootstrap.Modal(document.getElementById('generateBillModal')).show();
    }

    // Process bill generation
    function processBillGeneration() {
        if (!currentServiceId) {
            showToast('Error', 'No service selected', 'error');
            return;
        }

        // Get bill details
        const notes = document.getElementById('billNotes').value;
        const sendEmail = document.getElementById('sendBillEmail').checked;

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Show spinner
        showSpinner();

        // Close bill modal
        bootstrap.Modal.getInstance(document.getElementById('generateBillModal')).hide();

        // Prepare bill data
        const billData = {
            notes: notes,
            sendEmail: sendEmail
        };

        // Make API request
        fetch(`/admin/api/vehicle-tracking/service-request/${currentServiceId}/bill?token=${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(billData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                hideSpinner();

                // Show success modal
                document.getElementById('successTitle').textContent = 'Bill Generated!';
                document.getElementById('successMessage').textContent = 'The bill has been generated successfully. You can now proceed with payment collection.';
                new bootstrap.Modal(document.getElementById('successModal')).show();

                // Refresh data
                refreshCompletedServices();
            })
            .catch(error => {
                hideSpinner();
                console.error('Error generating bill:', error);
                showToast('Error', 'Failed to generate bill: ' + error.message, 'error');
            });
    }

    // Download invoice
    function downloadInvoice() {
        if (!currentServiceId) {
            showToast('Error', 'No service selected', 'error');
            return;
        }

        downloadInvoiceById(currentServiceId);
    }

    // Download invoice by ID
    function downloadInvoiceById(serviceId) {
        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Show spinner
        showSpinner();

        // Create the URL for the download
        const downloadUrl = `/admin/api/vehicle-tracking/invoice/download/${serviceId}?token=${encodeURIComponent(token)}`;

        // Create an iframe to handle the download
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = downloadUrl;

        // Add to document
        document.body.appendChild(iframe);

        // Set timeout to remove iframe and hide spinner
        setTimeout(() => {
            document.body.removeChild(iframe);
            hideSpinner();
            showToast('Success', 'Invoice download initiated', 'success');
        }, 2000);
    }

    // Open payment modal
    function openPaymentModal(service) {
        // Populate payment modal with service details
        document.getElementById('paymentServiceId').textContent = 'REQ-' + (service.requestId || service.serviceId);
        document.getElementById('paymentCustomerName').textContent = service.customerName || 'Unknown Customer';
        document.getElementById('paymentVehicleName').textContent = service.vehicleName || 'Unknown Vehicle';
        document.getElementById('paymentAmount').textContent = formatCurrency(service.totalCost || service.totalAmount || 0);

        // Set default paid amount
        const totalAmount = parseFloat(service.totalCost || service.totalAmount || 0);
        document.getElementById('paidAmount').value = totalAmount.toFixed(2);

        // Show the modal
        new bootstrap.Modal(document.getElementById('paymentModal')).show();
    }

    // Process payment
    function processPayment() {
        if (!currentServiceId) {
            showToast('Error', 'No service selected', 'error');
            return;
        }

        // Get payment details
        const paymentMethod = document.getElementById('paymentMethod').value;
        const transactionId = document.getElementById('transactionId').value;
        const paidAmount = document.getElementById('paidAmount').value;
        const paymentNotes = document.getElementById('paymentNotes').value;

        // Validate input
        if (!paymentMethod) {
            showToast('Error', 'Please select a payment method', 'error');
            return;
        }

        if (!paidAmount) {
            showToast('Error', 'Please enter the amount received', 'error');
            return;
        }

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Show spinner
        showSpinner();

        // Close payment modal
        bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();

        // Prepare payment data
        const paymentData = {
            paymentMethod: paymentMethod,
            transactionId: transactionId,
            amount: parseFloat(paidAmount),
            notes: paymentNotes
        };

        // Make API request
        fetch(`/admin/api/vehicle-tracking/service-request/${currentServiceId}/payment?token=${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(paymentData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                hideSpinner();

                // Show success modal
                document.getElementById('successTitle').textContent = 'Payment Successful!';
                document.getElementById('successMessage').textContent = 'The payment has been recorded successfully.';
                new bootstrap.Modal(document.getElementById('successModal')).show();

                // Refresh data
                refreshCompletedServices();
            })
            .catch(error => {
                hideSpinner();
                console.error('Error processing payment:', error);
                showToast('Error', 'Failed to process payment: ' + error.message, 'error');
            });
    }

    // Open invoice modal
    function openInvoiceModal(service) {
        // Populate invoice modal with service details
        document.getElementById('invoiceServiceId').textContent = 'REQ-' + (service.requestId || service.serviceId);
        document.getElementById('invoiceCustomerName').textContent = service.customerName || 'Unknown Customer';
        document.getElementById('invoiceVehicleName').textContent = service.vehicleName || 'Unknown Vehicle';
        document.getElementById('invoiceRegistrationNumber').textContent = service.registrationNumber || 'N/A';
        document.getElementById('invoiceServiceType').textContent = capitalizeEachWord(service.serviceType || 'General Service');

        // Format completion date
        let completionDate = service.formattedCompletedDate || formatDate(service.completedDate) || formatDate(service.updatedAt) || 'N/A';
        document.getElementById('invoiceCompletionDate').textContent = completionDate;

        // Set premium badge
        const membershipStatus = service.membershipStatus || 'Standard';
        if (membershipStatus.toLowerCase() === 'premium') {
            document.getElementById('premiumBadge').style.display = '';
        } else {
            document.getElementById('premiumBadge').style.display = 'none';
        }

        // Use our calculated financial data
        const materialsTotal = service.materialsTotal || 0;
        const laborTotal = service.laborTotal || 0;

        // Set financial details
        document.getElementById('invoiceMaterialsTotal').textContent = formatCurrency(materialsTotal);
        document.getElementById('invoiceLaborTotal').textContent = formatCurrency(laborTotal);

        // Calculate discount for premium members
        let discount = 0;
        if (membershipStatus.toLowerCase() === 'premium') {
            discount = laborTotal * 0.20;
        }

        // Calculate subtotal
        const subtotal = materialsTotal + laborTotal - discount;
        document.getElementById('invoiceSubtotal').textContent = formatCurrency(subtotal);

        // Calculate GST (18%)
        const gst = subtotal * 0.18;
        document.getElementById('invoiceGST').textContent = formatCurrency(gst);

        // Calculate grand total
        const grandTotal = subtotal + gst;
        document.getElementById('invoiceGrandTotal').textContent = formatCurrency(grandTotal);

        // Show the modal
        new bootstrap.Modal(document.getElementById('generateInvoiceModal')).show();
    }

    // Generate invoice
    function generateInvoice() {
        if (!currentServiceId) {
            showToast('Error', 'No service selected', 'error');
            return;
        }

        // Get invoice details
        const notes = document.getElementById('invoiceNotes').value;
        const sendEmail = document.getElementById('sendInvoiceEmail').checked;

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Show spinner
        showSpinner();

        // Close invoice modal
        bootstrap.Modal.getInstance(document.getElementById('generateInvoiceModal')).hide();

        // Prepare invoice data
        const invoiceData = {
            notes: notes,
            sendEmail: sendEmail
        };

        // Make API request
        fetch(`/admin/api/vehicle-tracking/service-request/${currentServiceId}/invoice?token=${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(invoiceData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                hideSpinner();

                // Show success modal
                document.getElementById('successTitle').textContent = 'Invoice Generated!';
                document.getElementById('successMessage').textContent = 'The invoice has been generated successfully' + (sendEmail ? ' and sent to the customer via email.' : '.');
                new bootstrap.Modal(document.getElementById('successModal')).show();

                // Refresh data
                refreshCompletedServices();
            })
            .catch(error => {
                hideSpinner();
                console.error('Error generating invoice:', error);
                showToast('Error', 'Failed to generate invoice: ' + error.message, 'error');
            });
    }

    // Open delivery modal
    function openDeliveryModal(service) {
        // Populate delivery modal with service details
        document.getElementById('deliveryServiceId').textContent = 'REQ-' + (service.requestId || service.serviceId);
        document.getElementById('deliveryVehicleName').textContent = service.vehicleName || 'Unknown Vehicle';
        document.getElementById('deliveryRegistrationNumber').textContent = service.registrationNumber || 'N/A';

        // Reset form fields
        document.getElementById('pickupPerson').value = '';
        document.getElementById('pickupTime').value = '';
        document.getElementById('deliveryAddress').value = '';
        document.getElementById('deliveryDate').value = '';
        document.getElementById('deliveryTimeSlot').value = '';
        document.getElementById('deliveryContact').value = '';
        document.getElementById('deliveryNotes').value = '';
        document.getElementById('confirmDeliveryCheck').checked = false;

        // Show the modal
        new bootstrap.Modal(document.getElementById('deliveryModal')).show();
    }

    // Confirm delivery
    function confirmDelivery() {
        if (!currentServiceId) {
            showToast('Error', 'No service selected', 'error');
            return;
        }

        // Check confirmation
        if (!document.getElementById('confirmDeliveryCheck').checked) {
            showToast('Error', 'Please confirm that all service work has been completed', 'error');
            return;
        }

        // Get delivery details
        const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;

        let dispatchDetails = {
            deliveryMethod: deliveryMethod,
            notes: document.getElementById('deliveryNotes').value
        };

        if (deliveryMethod === 'pickup') {
            dispatchDetails.pickupPerson = document.getElementById('pickupPerson').value;
            dispatchDetails.pickupTime = document.getElementById('pickupTime').value;
        } else {
            dispatchDetails.deliveryAddress = document.getElementById('deliveryAddress').value;
            dispatchDetails.deliveryDate = document.getElementById('deliveryDate').value;
            dispatchDetails.deliveryTimeSlot = document.getElementById('deliveryTimeSlot').value;
            dispatchDetails.deliveryContact = document.getElementById('deliveryContact').value;
        }

        // Validate input
        if (deliveryMethod === 'pickup' && !dispatchDetails.pickupPerson) {
            showToast('Error', 'Please enter the name of person collecting vehicle', 'error');
            return;
        }

        if (deliveryMethod === 'delivery' && !dispatchDetails.deliveryAddress) {
            showToast('Error', 'Please enter delivery address', 'error');
            return;
        }

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Show spinner
        showSpinner();

        // Close delivery modal
        bootstrap.Modal.getInstance(document.getElementById('deliveryModal')).hide();

        // Make API request
        fetch(`/admin/api/vehicle-tracking/service-request/${currentServiceId}/dispatch?token=${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dispatchDetails)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                hideSpinner();

                // Show success modal
                document.getElementById('successTitle').textContent = 'Vehicle Dispatched!';
                document.getElementById('successMessage').textContent = 'The vehicle has been ' +
                    (deliveryMethod === 'pickup' ? 'marked for customer pickup.' : 'scheduled for delivery.');
                new bootstrap.Modal(document.getElementById('successModal')).show();

                // Refresh data
                refreshCompletedServices();
            })
            .catch(error => {
                hideSpinner();
                console.error('Error dispatching vehicle:', error);
                showToast('Error', 'Failed to dispatch vehicle: ' + error.message, 'error');
            });
    }

    // Show toast notification
    function showToast(title, message, type) {
        const toastContainer = document.querySelector('.toast-container');

        const toast = document.createElement('div');
        toast.className = `toast ${type === 'error' ? 'bg-danger' : type === 'success' ? 'bg-success' : 'bg-wine'} text-white`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');

        toast.innerHTML = `
        <div class="toast-header ${type === 'error' ? 'bg-danger' : type === 'success' ? 'bg-success' : 'bg-wine'} text-white">
            <strong class="me-auto">${title}</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;

        toastContainer.appendChild(toast);

        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 5000
        });

        bsToast.show();

        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', function() {
            toastContainer.removeChild(toast);
        });
    }
</script>

</body>
</html>