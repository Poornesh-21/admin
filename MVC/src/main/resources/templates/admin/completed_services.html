<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Albany Motors - Completed Services</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts - Baloo Bhaijaan 2 -->
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --dutch-white: #EFFBBB;
            --dutch-white-light: #f5ffd4;
            --wine: #722F37;
            --wine-light: #8a3943;
            --wine-dark: #5e262e;
            --white: #ffffff;
            --light-bg: #f8f9fa;
            --light-gray: #e9ecef;
            --dark-gray: #495057;
            --success: #66bb6a;
            --warning: #ffca28;
            --danger: #ef5350;
            --radius-md: 0.5rem;
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        body, html {
            font-family: 'Baloo Bhaijaan 2', sans-serif;
            background-color: #f8f9fa;
            color: var(--dark-gray);
        }

        .app-container {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: linear-gradient(145deg, var(--wine) 0%, var(--wine-dark) 100%);
            color: var(--white);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.75rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sidebar-header h2 {
            font-weight: 700;
            color: var(--white);
            font-size: 1.75rem;
            margin-bottom: 0;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu-item {
            padding: 0.25rem 0.75rem;
        }

        .sidebar-menu-link {
            display: flex;
            align-items: center;
            padding: 0.85rem 1rem;
            color: rgba(255, 255, 255, 0.95);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }

        .sidebar-menu-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-menu-link.active {
            background-color: var(--dutch-white-light);
            color: var(--wine);
            font-weight: 600;
        }

        .sidebar-menu-link i {
            width: 1.5rem;
            margin-right: 0.75rem;
            text-align: center;
        }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-role {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: var(--radius-md);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .logout-btn i {
            margin-right: 0.5rem;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .header-left h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--wine);
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            font-size: 1rem;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-section {
            background-color: var(--white);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .table-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--wine);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .premium-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .premium-table thead th {
            background-color: var(--light-bg);
            color: var(--dark-gray);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1.25rem 1rem;
            border-bottom: 1px solid var(--light-gray);
            text-align: left;
        }

        .premium-table tbody td {
            padding: 1.25rem 1rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--light-gray);
            font-size: 0.95rem;
        }

        .premium-table tbody tr {
            transition: background-color 0.3s ease;
            cursor: pointer;
        }

        .premium-table tbody tr:hover {
            background-color: rgba(114, 47, 55, 0.05);
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.85rem;
            font-weight: 500;
            line-height: 1;
        }

        .status-completed {
            background-color: rgba(102, 187, 106, 0.15);
            color: #00701a;
        }

        .status-pending {
            background-color: rgba(255, 202, 40, 0.15);
            color: #d68000;
        }

        .status-paid {
            background-color: rgba(102, 187, 106, 0.15);
            color: #00701a;
        }

        /* Vehicle Info Cell Styles */
        .vehicle-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .vehicle-icon {
            width: 2.5rem;
            height: 2.5rem;
            background-color: var(--dutch-white-light);
            color: var(--wine);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .vehicle-details {
            display: flex;
            flex-direction: column;
        }

        .vehicle-details h5 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--wine);
        }

        .vehicle-details p {
            font-size: 0.8rem;
            color: var(--dark-gray);
            margin: 0;
        }

        /* Membership Badge */
        .membership-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .membership-standard {
            background-color: rgba(66, 165, 245, 0.15);
            color: #0069c0;
        }

        .membership-premium {
            background: linear-gradient(to right, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.3));
            color: #b8860b;
        }

        /* Table Action Buttons */
        .table-actions-cell {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .btn-table-action {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--white);
            color: var(--wine);
            border: 1px solid var(--light-gray);
            border-radius: 50%;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-table-action:hover {
            background-color: var(--light-bg);
            border-color: var(--wine-light);
        }

        /* Modal Styles */
        .modal-premium .modal-content {
            border: none;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .modal-premium .modal-header {
            background: linear-gradient(145deg, var(--wine) 0%, var(--wine-dark) 100%);
            color: white;
            border-bottom: none;
            padding: 1.75rem 2rem;
        }

        .modal-premium .modal-title {
            font-weight: 700;
            font-size: 1.35rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-premium .modal-body {
            padding: 2rem;
        }

        .modal-premium .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--light-gray);
            background-color: rgba(248, 249, 250, 0.5);
        }

        /* Service Details */
        .service-detail-row {
            display: flex;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .service-detail-col {
            flex: 1;
            padding-right: 1.5rem;
        }

        .detail-label {
            font-size: 0.85rem;
            color: var(--dark-gray);
            margin-bottom: 0.35rem;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: 500;
            color: var(--dark-gray);
        }

        /* Materials Table */
        .materials-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1.5rem;
            background-color: var(--light-bg);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .materials-table th {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--dark-gray);
            padding: 0.75rem 1rem;
            text-align: left;
            background-color: var(--light-bg);
            border-bottom: 1px solid var(--light-gray);
        }

        .materials-table td {
            font-size: 0.9rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        /* Invoice Summary */
        .invoice-summary {
            background-color: var(--light-bg);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .invoice-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .invoice-summary-row:last-child {
            margin-bottom: 0;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--light-gray);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .premium-discount-row {
            color: var(--success);
        }

        /* Buttons */
        .btn-premium {
            padding: 0.75rem 1.5rem;
            border-radius: 30px;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
        }

        .btn-premium.primary {
            background: linear-gradient(145deg, var(--wine) 0%, var(--wine-dark) 100%);
            color: white;
        }

        .btn-premium.secondary {
            background-color: var(--white);
            color: var(--wine);
            border: 1px solid var(--light-gray);
        }

        /* Workflow Steps */
        .workflow-steps {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            position: relative;
        }

        .workflow-steps::before {
            content: '';
            position: absolute;
            top: 24px;
            left: 30px;
            right: 30px;
            height: 2px;
            background-color: var(--light-gray);
            z-index: 1;
        }

        .workflow-step {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .step-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--light-bg);
            border: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
            color: var(--dark-gray);
            font-size: 1.25rem;
        }

        .step-text {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--dark-gray);
            text-align: center;
        }

        .workflow-step.active .step-icon {
            background-color: var(--wine);
            border-color: var(--wine);
            color: white;
            box-shadow: 0 0 0 5px rgba(114, 47, 55, 0.2);
        }

        .workflow-step.active .step-text {
            color: var(--wine);
            font-weight: 600;
        }

        .workflow-step.completed .step-icon {
            background-color: var(--success);
            border-color: var(--success);
            color: white;
        }

        .workflow-step.completed .step-text {
            color: var(--success);
        }
    </style>
</head>
<body>
<div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Albany</h2>
        </div>

        <div class="sidebar-content">
            <div class="nav-section">
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Service Requests</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link">
                            <i class="fas fa-car"></i>
                            <span>Vehicles</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link">
                            <i class="fas fa-users"></i>
                            <span>Customers</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link">
                            <i class="fas fa-boxes"></i>
                            <span>Inventory</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link active">
                            <i class="fas fa-check-circle"></i>
                            <span>Completed Services</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-name">Admin User</div>
                <div class="user-role">Administrator</div>
            </div>
            <button class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <header class="page-header">
            <div class="header-left">
                <h1>Completed Services</h1>
                <div class="header-subtitle">
                    <i class="fas fa-check-circle"></i>
                    View and manage completed vehicle services
                </div>
            </div>
        </header>

        <!-- Completed Services Table -->
        <section class="table-section">
            <div class="table-header">
                <h3 class="table-title">
                    <i class="fas fa-check-circle"></i>
                    Completed Services
                </h3>
            </div>

            <div class="table-responsive">
                <table class="premium-table" id="completedServicesTable">
                    <thead>
                    <tr>
                        <th>Service ID</th>
                        <th>Vehicle</th>
                        <th>Customer</th>
                        <th>Membership</th>
                        <th>Completion Date</th>
                        <th>Total Amount</th>
                        <th>Invoice</th>
                        <th>Payment</th>
                        <th>Delivery</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="completedServicesTableBody">
                    <!-- Will be populated dynamically via JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>
</div>

<!-- View Service Details Modal -->
<div class="modal fade modal-premium" id="viewServiceDetailsModal" tabindex="-1" aria-labelledby="viewServiceDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewServiceDetailsModalLabel">
                    <i class="fas fa-info-circle"></i>
                    Service Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Service ID</div>
                        <div class="detail-value" id="viewServiceId">REQ-1001</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Vehicle</div>
                        <div class="detail-value" id="viewVehicleName">Honda Civic</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Registration</div>
                        <div class="detail-value" id="viewRegistrationNumber">ABC-1234</div>
                    </div>
                </div>

                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Customer</div>
                        <div class="detail-value" id="viewCustomerName">John Doe</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Membership</div>
                        <div class="detail-value" id="viewMembership">Premium</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Completion Date</div>
                        <div class="detail-value" id="viewCompletionDate">May 15, 2025</div>
                    </div>
                </div>

                <div id="materialsSection">
                    <h5 class="mb-3">Materials Used</h5>
                    <table class="materials-table" id="materialsTable">
                        <thead>
                        <tr>
                            <th>Item</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                        </thead>
                        <tbody id="materialsTableBody">
                        <!-- Will be populated dynamically -->
                        </tbody>
                    </table>

                    <h5 class="mt-4 mb-3">Labor Charges</h5>
                    <table class="materials-table" id="laborChargesTable">
                        <thead>
                        <tr>
                            <th>Description</th>
                            <th>Hours</th>
                            <th>Rate/Hour</th>
                            <th>Total</th>
                        </tr>
                        </thead>
                        <tbody id="laborChargesTableBody">
                        <!-- Will be populated dynamically -->
                        </tbody>
                    </table>

                    <div class="invoice-summary">
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">Materials Total</div>
                            <div class="invoice-summary-value" id="summaryMaterialsTotal">₹0.00</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">Labor Total</div>
                            <div class="invoice-summary-value" id="summaryLaborTotal">₹0.00</div>
                        </div>
                        <div class="invoice-summary-row premium-discount-row" id="premiumDiscountRow" style="display:none;">
                            <div class="invoice-summary-label">Premium Discount (30% off labor)</div>
                            <div class="invoice-summary-value" id="summaryDiscount">-₹0.00</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">Subtotal</div>
                            <div class="invoice-summary-value" id="summarySubtotal">₹0.00</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">GST (18%)</div>
                            <div class="invoice-summary-value" id="summaryGST">₹0.00</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">Grand Total</div>
                            <div class="invoice-summary-value" id="summaryGrandTotal">₹0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Workflow steps for completed services -->
                <div id="workflowStepsContainer" class="mt-4">
                    <h5 class="mb-3">Service Workflow</h5>
                    <div class="workflow-steps">
                        <div class="workflow-step" id="stepInvoice">
                            <div class="step-icon">
                                <i class="fas fa-file-invoice"></i>
                            </div>
                            <div class="step-text">Generate Invoice</div>
                        </div>
                        <div class="workflow-step" id="stepPayment">
                            <div class="step-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="step-text">Payment</div>
                        </div>
                        <div class="workflow-step" id="stepDelivery">
                            <div class="step-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="step-text">Delivery</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="serviceDetailsFooter">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn-premium primary" id="generateInvoiceBtn">
                    <i class="fas fa-file-invoice"></i> Generate Invoice
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Invoice Modal -->
<div class="modal fade modal-premium" id="generateInvoiceModal" tabindex="-1" aria-labelledby="generateInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateInvoiceModalLabel">
                    <i class="fas fa-file-invoice"></i>
                    Generate Invoice
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    Generate invoice for service <strong id="invoiceServiceId">REQ-1001</strong> for <strong id="invoiceCustomerName">John Doe</strong>.
                    <span id="invoicePremiumBadge" class="ms-2 badge bg-warning" style="display:none;">Premium</span>
                </div>

                <div class="mb-3">
                    <label for="customerEmail" class="form-label">Email</label>
                    <input type="email" class="form-control" id="customerEmail" value="">
                    <div class="form-text">Invoice will be sent to this email address.</div>
                </div>

                <div class="invoice-summary">
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">Materials Total</div>
                        <div class="invoice-summary-value" id="invoiceMaterialsTotal">₹0.00</div>
                    </div>
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">Labor Total</div>
                        <div class="invoice-summary-value" id="invoiceLaborTotal">₹0.00</div>
                    </div>
                    <div class="invoice-summary-row premium-discount-row" id="invoicePremiumDiscountRow" style="display:none;">
                        <div class="invoice-summary-label">Premium Discount (30% off labor)</div>
                        <div class="invoice-summary-value" id="invoiceDiscount">-₹0.00</div>
                    </div>
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">Subtotal</div>
                        <div class="invoice-summary-value" id="invoiceSubtotal">₹0.00</div>
                    </div>
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">GST (18%)</div>
                        <div class="invoice-summary-value" id="invoiceGST">₹0.00</div>
                    </div>
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">Grand Total</div>
                        <div class="invoice-summary-value" id="invoiceGrandTotal">₹0.00</div>
                    </div>
                </div>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="sendInvoiceEmail" checked>
                    <label class="form-check-label" for="sendInvoiceEmail">
                        Send invoice to customer via email
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-premium primary" id="confirmGenerateInvoiceBtn">
                    <i class="fas fa-file-invoice"></i> Generate & Send
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade modal-premium" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">
                    <i class="fas fa-money-bill-wave"></i>
                    Process Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    Processing payment for service <strong id="paymentServiceId">REQ-1001</strong> for <strong id="paymentCustomerName">John Doe</strong>.
                </div>

                <div class="mb-3">
                    <label for="paymentMethod" class="form-label">Payment Method</label>
                    <select class="form-select" id="paymentMethod" required>
                        <option value="">Select Payment Method</option>
                        <option value="UPI">UPI</option>
                        <option value="Card">Credit/Debit Card</option>
                        <option value="Net_Banking">Net Banking</option>
                        <option value="Cash">Cash</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="transactionId" class="form-label">Transaction ID</label>
                    <input type="text" class="form-control" id="transactionId" placeholder="Enter transaction ID">
                </div>

                <div class="mb-3">
                    <label for="paidAmount" class="form-label">Amount Received</label>
                    <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input type="number" class="form-control" id="paidAmount" placeholder="Enter amount" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-premium primary" id="confirmPaymentBtn">
                    <i class="fas fa-check-circle"></i> Confirm Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delivery Modal -->
<div class="modal fade modal-premium" id="deliveryModal" tabindex="-1" aria-labelledby="deliveryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deliveryModalLabel">
                    <i class="fas fa-truck"></i>
                    Vehicle Delivery
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="deliveryModalInfo">Arrange delivery for completed service <strong id="deliveryServiceId">REQ-1001</strong></span>
                </div>

                <div class="mb-3">
                    <label class="form-label">Delivery Method</label>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="deliveryMethod" id="customerPickup" value="pickup" checked>
                        <label class="form-check-label" for="customerPickup">
                            Customer Pickup
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deliveryMethod" id="homeDelivery" value="delivery">
                        <label class="form-check-label" for="homeDelivery">
                            Home Delivery
                        </label>
                    </div>
                </div>

                <div id="pickupFields">
                    <div class="mb-3">
                        <label for="pickupPerson" class="form-label">Person Collecting Vehicle</label>
                        <input type="text" class="form-control" id="pickupPerson" placeholder="Enter name">
                    </div>

                    <div class="mb-3">
                        <label for="pickupTime" class="form-label">Expected Pickup Time</label>
                        <input type="datetime-local" class="form-control" id="pickupTime">
                    </div>
                </div>

                <div id="deliveryFields" style="display: none;">
                    <div class="mb-3">
                        <label for="deliveryAddress" class="form-label">Delivery Address</label>
                        <textarea class="form-control" id="deliveryAddress" rows="3" placeholder="Enter delivery address"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="deliveryDate" class="form-label">Delivery Date</label>
                        <input type="date" class="form-control" id="deliveryDate">
                    </div>

                    <div class="mb-3">
                        <label for="deliveryContact" class="form-label">Contact Number</label>
                        <input type="tel" class="form-control" id="deliveryContact" placeholder="Enter contact number">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-premium primary" id="confirmDeliveryBtn">
                    <i class="fas fa-check-circle"></i>
                    <span id="confirmDeliveryBtnText">Confirm Pickup</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="mb-4">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h3 class="mb-3" id="successTitle">Success!</h3>
                <p class="mb-4" id="successMessage">Operation completed successfully.</p>
                <button type="button" class="btn-premium primary" data-bs-dismiss="modal">
                    Continue
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- jQuery and Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

<script>
    // Global variables
    let completedServices = [];
    let currentServiceId = null;
    let currentService = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Initial setup
        initializeEventListeners();
        loadCompletedServices();
    });

    // Initialize event listeners
    function initializeEventListeners() {
        // View service details button
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('view-service-btn') || e.target.closest('.view-service-btn')) {
                const btn = e.target.classList.contains('view-service-btn') ? e.target : e.target.closest('.view-service-btn');
                const serviceId = btn.getAttribute('data-id');
                viewServiceDetails(serviceId);
            }
        });

        // Generate invoice button
        document.getElementById('generateInvoiceBtn').addEventListener('click', function() {
            openGenerateInvoiceModal();
        });

        // Confirm generate invoice button
        document.getElementById('confirmGenerateInvoiceBtn').addEventListener('click', function() {
            generateInvoice();
        });

        // Confirm payment button
        document.getElementById('confirmPaymentBtn').addEventListener('click', function() {
            processPayment();
        });

        // Delivery method toggle
        document.getElementById('customerPickup').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('pickupFields').style.display = 'block';
                document.getElementById('deliveryFields').style.display = 'none';
                document.getElementById('confirmDeliveryBtnText').textContent = 'Confirm Pickup';
            }
        });

        document.getElementById('homeDelivery').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('pickupFields').style.display = 'none';
                document.getElementById('deliveryFields').style.display = 'block';
                document.getElementById('confirmDeliveryBtnText').textContent = 'Confirm Delivery';
            }
        });

        // Confirm delivery button
        document.getElementById('confirmDeliveryBtn').addEventListener('click', function() {
            processDelivery();
        });
    }

    // Load completed services from API
    function loadCompletedServices() {
        // Show loading indicator
        const tableBody = document.getElementById('completedServicesTableBody');
        tableBody.innerHTML = `
        <tr>
            <td colspan="10" class="text-center py-4">
                <div class="spinner-border text-wine" role="status"></div>
                <p class="mt-2">Loading completed services...</p>
            </td>
        </tr>
    `;

        // Get token
        const token = getAuthToken();

        // Fetch data from API
        fetch('/admin/api/vehicle-tracking/completed-services', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch completed services');
                }
                return response.json();
            })
            .then(data => {
                completedServices = data;
                renderCompletedServicesTable();
            })
            .catch(error => {
                console.error('Error fetching completed services:', error);
                tableBody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-4">
                    <div class="text-danger mb-3">
                        <i class="fas fa-exclamation-circle fa-2x"></i>
                    </div>
                    <p>Error loading completed services: ${error.message}</p>
                    <button class="btn-premium primary mt-3" onclick="loadCompletedServices()">
                        <i class="fas fa-sync-alt"></i> Try Again
                    </button>
                </td>
            </tr>
        `;
            });
    }

    // Helper function to get auth token
    function getAuthToken() {
        // Get token from URL or local storage
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token') || localStorage.getItem('jwt-token') || sessionStorage.getItem('jwt-token');
        return token;
    }

    // Render the completed services table
    function renderCompletedServicesTable() {
        const tableBody = document.getElementById('completedServicesTableBody');
        tableBody.innerHTML = '';

        // Check if there are services to display
        if (!completedServices || completedServices.length === 0) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-5">
                    <div class="my-4">
                        <i class="fas fa-check-circle fa-3x text-muted mb-3" style="opacity: 0.3;"></i>
                        <h5>No Completed Services</h5>
                        <p class="text-muted">Completed vehicle services will appear here once they're finished.</p>
                    </div>
                </td>
            </tr>
        `;
            return;
        }

        completedServices.forEach(service => {
            const row = document.createElement('tr');

            // Format date
            const completionDate = new Date(service.completionDate || service.completedDate || service.updatedAt);
            const formattedDate = completionDate.toLocaleDateString();

            // Format currency
            const formatter = new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2
            });

            // Invoice status
            const invoiceStatus = service.hasInvoice ?
                `<span class="status-badge status-completed"><i class="fas fa-check-circle"></i> Generated</span>` :
                `<span class="status-badge status-pending"><i class="fas fa-clock"></i> Pending</span>`;

            // Payment status
            const paymentStatus = service.isPaid || service.paid ?
                `<span class="status-badge status-paid"><i class="fas fa-check-circle"></i> Paid</span>` :
                `<span class="status-badge status-pending"><i class="fas fa-clock"></i> Pending</span>`;

            // Delivery status
            const deliveryStatus = service.isDelivered || service.delivered ?
                `<span class="status-badge status-completed"><i class="fas fa-check-circle"></i> Completed</span>` :
                `<span class="status-badge status-pending"><i class="fas fa-clock"></i> Pending</span>`;

            // Determine vehicle icon based on type
            const vehicleIcon = (service.vehicleType || service.category || '').toLowerCase() === 'bike' ?
                'fas fa-motorcycle' : (service.vehicleType || service.category || '').toLowerCase() === 'truck' ?
                    'fas fa-truck' : 'fas fa-car';

            row.innerHTML = `
            <td>REQ-${service.requestId || service.serviceId}</td>
            <td>
                <div class="vehicle-info">
                    <div class="vehicle-icon">
                        <i class="${vehicleIcon}"></i>
                    </div>
                    <div class="vehicle-details">
                        <h5>${service.vehicleName || `${service.vehicleBrand || ''} ${service.vehicleModel || ''}`}</h5>
                        <p>${service.registrationNumber}</p>
                    </div>
                </div>
            </td>
            <td>${service.customerName}</td>
            <td>
                <span class="membership-badge ${(service.membershipStatus || '').toLowerCase() === 'premium' ? 'membership-premium' : 'membership-standard'}">
                    ${service.membershipStatus || 'Standard'}
                </span>
            </td>
            <td>${formattedDate}</td>
            <td>${formatter.format(service.totalAmount || service.totalCost || 0)}</td>
            <td>${invoiceStatus}</td>
            <td>${paymentStatus}</td>
            <td>${deliveryStatus}</td>
            <td>
                <div class="table-actions-cell">
                    <button class="btn-table-action view-service-btn" data-id="${service.requestId || service.serviceId}">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </td>
        `;

            tableBody.appendChild(row);
        });
    }

    // View service details
    function viewServiceDetails(serviceId) {
        // Show loading state
        const modal = new bootstrap.Modal(document.getElementById('viewServiceDetailsModal'));
        modal.show();

        const materialsTableBody = document.getElementById('materialsTableBody');
        const laborChargesTableBody = document.getElementById('laborChargesTableBody');

        materialsTableBody.innerHTML = `
        <tr>
            <td colspan="4" class="text-center">
                <div class="spinner-border spinner-border-sm text-wine" role="status"></div>
                <span class="ms-2">Loading...</span>
            </td>
        </tr>
    `;

        laborChargesTableBody.innerHTML = `
        <tr>
            <td colspan="4" class="text-center">
                <div class="spinner-border spinner-border-sm text-wine" role="status"></div>
                <span class="ms-2">Loading...</span>
            </td>
        </tr>
    `;

        // Get token
        const token = getAuthToken();

        // Fetch service details from API
        fetch(`/admin/api/vehicle-tracking/service-request/${serviceId}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch service details');
                }
                return response.json();
            })
            .then(service => {
                // Store current service and ID globally
                currentServiceId = serviceId;
                currentService = service;

                // Update modal with service details
                document.getElementById('viewServiceId').textContent = `REQ-${service.requestId || service.serviceId}`;
                document.getElementById('viewVehicleName').textContent = service.vehicleName || `${service.vehicleBrand || ''} ${service.vehicleModel || ''}`;
                document.getElementById('viewRegistrationNumber').textContent = service.registrationNumber || 'N/A';
                document.getElementById('viewCustomerName').textContent = service.customerName || 'N/A';
                document.getElementById('viewMembership').textContent = service.membershipStatus || 'Standard';

                // Format date
                const completionDate = new Date(service.completionDate || service.completedDate || service.updatedAt);
                document.getElementById('viewCompletionDate').textContent = completionDate.toLocaleDateString();

                // Populate materials table
                populateMaterialsTable(service.materials || []);

                // Populate labor charges table
                populateLaborChargesTable(service.laborCharges || []);

                // Update invoice summary
                updateInvoiceSummary(service);

                // Update workflow steps
                updateWorkflowSteps(service);

                // Update footer buttons based on service status
                updateFooterButtons(service);
            })
            .catch(error => {
                console.error('Error fetching service details:', error);
                showToast('Error loading service details: ' + error.message, 'error');

                // Show error state in tables
                materialsTableBody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error loading materials data
                </td>
            </tr>
        `;

                laborChargesTableBody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error loading labor charges data
                </td>
            </tr>
        `;
            });
    }

    // Populate materials table
    function populateMaterialsTable(materials) {
        const tableBody = document.getElementById('materialsTableBody');
        tableBody.innerHTML = '';

        if (!materials || materials.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `<td colspan="4" class="text-center">No materials used</td>`;
            tableBody.appendChild(emptyRow);
            return;
        }

        // Number formatter for currency
        const formatter = new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2
        });

        let materialTotal = 0;

        materials.forEach(material => {
            const row = document.createElement('tr');
            const total = material.quantity * material.unitPrice;
            materialTotal += total;

            row.innerHTML = `
            <td>${material.name}</td>
            <td>${material.quantity}</td>
            <td>${formatter.format(material.unitPrice)}</td>
            <td>${formatter.format(total)}</td>
        `;

            tableBody.appendChild(row);
        });

        // Add total row
        const totalRow = document.createElement('tr');
        totalRow.innerHTML = `
        <td colspan="3" class="text-end fw-bold">Total</td>
        <td class="fw-bold">${formatter.format(materialTotal)}</td>
    `;
        tableBody.appendChild(totalRow);

        // Update materials total in summary
        document.getElementById('summaryMaterialsTotal').textContent = formatter.format(materialTotal);
    }

    // Populate labor charges table
    function populateLaborChargesTable(laborCharges) {
        const tableBody = document.getElementById('laborChargesTableBody');
        tableBody.innerHTML = '';

        if (!laborCharges || laborCharges.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `<td colspan="4" class="text-center">No labor charges</td>`;
            tableBody.appendChild(emptyRow);
            return;
        }

        // Number formatter for currency
        const formatter = new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2
        });

        let laborTotal = 0;

        laborCharges.forEach(charge => {
            const row = document.createElement('tr');
            const total = charge.hours * charge.ratePerHour;
            laborTotal += total;

            row.innerHTML = `
            <td>${charge.description}</td>
            <td>${charge.hours}</td>
            <td>${formatter.format(charge.ratePerHour)}/hr</td>
            <td>${formatter.format(total)}</td>
        `;

            tableBody.appendChild(row);
        });

        // Add total row
        const totalRow = document.createElement('tr');
        totalRow.innerHTML = `
        <td colspan="3" class="text-end fw-bold">Total</td>
        <td class="fw-bold">${formatter.format(laborTotal)}</td>
    `;
        tableBody.appendChild(totalRow);

        // Update labor total in summary
        document.getElementById('summaryLaborTotal').textContent = formatter.format(laborTotal);
    }

    // Update invoice summary
    function updateInvoiceSummary(service) {
        // Number formatter for currency
        const formatter = new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2
        });

        // Calculate totals
        let materialsTotal = 0;
        if (service.materials && service.materials.length > 0) {
            materialsTotal = service.materials.reduce((total, item) => total + (item.quantity * item.unitPrice), 0);
        }

        let laborTotal = 0;
        if (service.laborCharges && service.laborCharges.length > 0) {
            laborTotal = service.laborCharges.reduce((total, charge) => total + (charge.hours * charge.ratePerHour), 0);
        }

        // Apply premium discount if applicable (30% off labor)
        let discount = 0;
        const isPremium = service.membershipStatus === 'Premium';
        const premiumDiscountRow = document.getElementById('premiumDiscountRow');

        if (isPremium) {
            discount = laborTotal * 0.3; // 30% discount
            document.getElementById('summaryDiscount').textContent = `-${formatter.format(discount)}`;
            premiumDiscountRow.style.display = '';
        } else {
            premiumDiscountRow.style.display = 'none';
        }

        // Calculate subtotal and tax
        const subtotal = materialsTotal + laborTotal - discount;
        const tax = subtotal * 0.18; // 18% GST
        const total = subtotal + tax;

        // Update summary values
        document.getElementById('summaryMaterialsTotal').textContent = formatter.format(materialsTotal);
        document.getElementById('summaryLaborTotal').textContent = formatter.format(laborTotal);
        document.getElementById('summarySubtotal').textContent = formatter.format(subtotal);
        document.getElementById('summaryGST').textContent = formatter.format(tax);
        document.getElementById('summaryGrandTotal').textContent = formatter.format(total);
    }

    // Update workflow steps
    function updateWorkflowSteps(service) {
        // Reset all steps
        document.querySelectorAll('.workflow-step').forEach(step => {
            step.classList.remove('active', 'completed');
        });

        // Update steps based on service status
        if (service.hasInvoice) {
            document.getElementById('stepInvoice').classList.add('completed');

            if (service.isPaid) {
                document.getElementById('stepPayment').classList.add('completed');

                if (service.isDelivered) {
                    document.getElementById('stepDelivery').classList.add('completed');
                } else {
                    document.getElementById('stepDelivery').classList.add('active');
                }
            } else {
                document.getElementById('stepPayment').classList.add('active');
            }
        } else {
            document.getElementById('stepInvoice').classList.add('active');
        }
    }

    // Update footer buttons based on service status
    function updateFooterButtons(service) {
        const footer = document.getElementById('serviceDetailsFooter');
        // Clear existing action buttons except Close
        const actionButtons = footer.querySelectorAll('button:not([data-bs-dismiss="modal"])');
        actionButtons.forEach(button => button.remove());

        // Add appropriate action button based on workflow step
        if (!service.hasInvoice) {
            // Add Generate Invoice button
            const generateInvoiceBtn = document.createElement('button');
            generateInvoiceBtn.type = 'button';
            generateInvoiceBtn.className = 'btn-premium primary';
            generateInvoiceBtn.innerHTML = '<i class="fas fa-file-invoice"></i> Generate Invoice';
            generateInvoiceBtn.addEventListener('click', openGenerateInvoiceModal);
            footer.appendChild(generateInvoiceBtn);
        } else if (!service.isPaid) {
            // Add Process Payment button
            const processPaymentBtn = document.createElement('button');
            processPaymentBtn.type = 'button';
            processPaymentBtn.className = 'btn-premium primary';
            processPaymentBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Process Payment';
            processPaymentBtn.addEventListener('click', openPaymentModal);
            footer.appendChild(processPaymentBtn);
        } else if (!service.isDelivered) {
            // Add Delivery button
            const deliveryBtn = document.createElement('button');
            deliveryBtn.type = 'button';
            deliveryBtn.className = 'btn-premium primary';
            deliveryBtn.innerHTML = '<i class="fas fa-truck"></i> Schedule Delivery';
            deliveryBtn.addEventListener('click', openDeliveryModal);
            footer.appendChild(deliveryBtn);
        }
    }

    // Open generate invoice modal
    function openGenerateInvoiceModal() {
        if (!currentService) return;

        // Number formatter for currency
        const formatter = new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2
        });

        // Set service details
        document.getElementById('invoiceServiceId').textContent = `REQ-${currentService.requestId}`;
        document.getElementById('invoiceCustomerName').textContent = currentService.customerName;
        document.getElementById('customerEmail').value = currentService.customerEmail || '';

        // Calculate totals
        let materialsTotal = 0;
        if (currentService.materials && currentService.materials.length > 0) {
            materialsTotal = currentService.materials.reduce((total, item) => total + (item.quantity * item.unitPrice), 0);
        }

        let laborTotal = 0;
        if (currentService.laborCharges && currentService.laborCharges.length > 0) {
            laborTotal = currentService.laborCharges.reduce((total, charge) => total + (charge.hours * charge.ratePerHour), 0);
        }

        // Apply premium discount if applicable (30% off labor)
        let discount = 0;
        const isPremium = currentService.membershipStatus === 'Premium';
        const premiumDiscountRow = document.getElementById('invoicePremiumDiscountRow');
        const premiumBadge = document.getElementById('invoicePremiumBadge');

        if (isPremium) {
            discount = laborTotal * 0.3; // 30% discount
            document.getElementById('invoiceDiscount').textContent = `-${formatter.format(discount)}`;
            premiumDiscountRow.style.display = '';
            premiumBadge.style.display = '';
        } else {
            premiumDiscountRow.style.display = 'none';
            premiumBadge.style.display = 'none';
        }

        // Calculate subtotal and tax
        const subtotal = materialsTotal + laborTotal - discount;
        const tax = subtotal * 0.18; // 18% GST
        const total = subtotal + tax;

        // Update invoice values
        document.getElementById('invoiceMaterialsTotal').textContent = formatter.format(materialsTotal);
        document.getElementById('invoiceLaborTotal').textContent = formatter.format(laborTotal);
        document.getElementById('invoiceSubtotal').textContent = formatter.format(subtotal);
        document.getElementById('invoiceGST').textContent = formatter.format(tax);
        document.getElementById('invoiceGrandTotal').textContent = formatter.format(total);

        // Close service details modal
        const serviceDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewServiceDetailsModal'));
        serviceDetailsModal.hide();

        // Show invoice modal
        const invoiceModal = new bootstrap.Modal(document.getElementById('generateInvoiceModal'));
        invoiceModal.show();
    }

    // Generate invoice
    function generateInvoice() {
        if (!currentService) return;

        // Get email address
        const email = document.getElementById('customerEmail').value;
        if (!email) {
            showToast('Please enter customer email', 'error');
            return;
        }

        // Get send email checkbox
        const sendEmail = document.getElementById('sendInvoiceEmail').checked;

        // Show loading state
        const confirmBtn = document.getElementById('confirmGenerateInvoiceBtn');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div> Generating...';

        // Close invoice modal
        const invoiceModal = bootstrap.Modal.getInstance(document.getElementById('generateInvoiceModal'));
        invoiceModal.hide();

        // Build request object
        const invoiceRequest = {
            serviceId: currentServiceId,
            emailAddress: email,
            sendEmail: sendEmail,
            notes: "Generated from admin portal"
        };

        // Get token
        const token = getAuthToken();

        // Call API to generate invoice
        fetch('/admin/api/vehicle-tracking/generate-invoice', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(invoiceRequest)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to generate invoice');
                }
                return response.json();
            })
            .then(data => {
                // Reset button state
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-file-invoice"></i> Generate & Send';

                // Update service status
                if (currentService) {
                    currentService.hasInvoice = true;
                }

                // Refresh table
                loadCompletedServices();

                // Show success message
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                document.getElementById('successTitle').textContent = 'Invoice Generated';
                document.getElementById('successMessage').textContent = sendEmail ?
                    `Invoice has been generated and sent to ${email}` :
                    'Invoice has been generated successfully';
                successModal.show();

                // Close success modal after a delay and show payment modal
                setTimeout(() => {
                    successModal.hide();
                    openPaymentModal();
                }, 2000);
            })
            .catch(error => {
                // Reset button state
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-file-invoice"></i> Generate & Send';

                console.error('Error generating invoice:', error);
                showToast('Error generating invoice: ' + error.message, 'error');
            });
    }

    // Open payment modal
    function openPaymentModal() {
        if (!currentService) return;

        // Set service details
        document.getElementById('paymentServiceId').textContent = `REQ-${currentService.requestId}`;
        document.getElementById('paymentCustomerName').textContent = currentService.customerName;

        // Calculate total amount
        let materialsTotal = 0;
        if (currentService.materials && currentService.materials.length > 0) {
            materialsTotal = currentService.materials.reduce((total, item) => total + (item.quantity * item.unitPrice), 0);
        }

        let laborTotal = 0;
        if (currentService.laborCharges && currentService.laborCharges.length > 0) {
            laborTotal = currentService.laborCharges.reduce((total, charge) => total + (charge.hours * charge.ratePerHour), 0);
        }

        // Apply premium discount if applicable (30% off labor)
        let discount = 0;
        if (currentService.membershipStatus === 'Premium') {
            discount = laborTotal * 0.3; // 30% discount
        }

        // Calculate total
        const subtotal = materialsTotal + laborTotal - discount;
        const tax = subtotal * 0.18; // 18% GST
        const total = subtotal + tax;

        // Set amount
        document.getElementById('paidAmount').value = total.toFixed(2);

        // Show payment modal
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        paymentModal.show();
    }

    // Process payment
    function processPayment() {
        if (!currentService) return;

        // Validate form
        const paymentMethod = document.getElementById('paymentMethod').value;
        const transactionId = document.getElementById('transactionId').value;
        const paidAmount = document.getElementById('paidAmount').value;

        if (!paymentMethod) {
            showToast('Please select a payment method', 'error');
            return;
        }

        if (!paidAmount || paidAmount <= 0) {
            showToast('Please enter a valid amount', 'error');
            return;
        }

        // Show loading state
        const confirmBtn = document.getElementById('confirmPaymentBtn');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div> Processing...';

        // Close payment modal
        const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
        paymentModal.hide();

        // Build payment request
        const paymentRequest = {
            serviceId: currentServiceId,
            paymentMethod: paymentMethod,
            transactionId: transactionId,
            amount: parseFloat(paidAmount),
            notes: "Payment processed by admin"
        };

        // Get token
        const token = getAuthToken();

        // Call API to process payment
        fetch('/admin/api/vehicle-tracking/process-payment', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(paymentRequest)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to process payment');
                }
                return response.json();
            })
            .then(data => {
                // Reset button state
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Payment';

                // Update service status
                if (currentService) {
                    currentService.isPaid = true;
                    currentService.paid = true;
                }

                // Refresh table
                loadCompletedServices();

                // Show success message
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                document.getElementById('successTitle').textContent = 'Payment Processed';
                document.getElementById('successMessage').textContent = 'Payment has been processed successfully';
                successModal.show();

                // Close success modal after a delay and show delivery modal
                setTimeout(() => {
                    successModal.hide();
                    openDeliveryModal();
                }, 2000);
            })
            .catch(error => {
                // Reset button state
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Payment';

                console.error('Error processing payment:', error);
                showToast('Error processing payment: ' + error.message, 'error');
            });
    }

    // Open delivery modal
    function openDeliveryModal() {
        if (!currentService) return;

        // Set service details
        document.getElementById('deliveryServiceId').textContent = `REQ-${currentService.requestId}`;

        // Reset form fields
        document.getElementById('pickupPerson').value = '';
        document.getElementById('pickupTime').value = '';
        document.getElementById('deliveryAddress').value = '';
        document.getElementById('deliveryDate').value = '';
        document.getElementById('deliveryContact').value = '';

        // Set delivery method to pickup by default
        document.getElementById('customerPickup').checked = true;
        document.getElementById('pickupFields').style.display = 'block';
        document.getElementById('deliveryFields').style.display = 'none';
        document.getElementById('confirmDeliveryBtnText').textContent = 'Confirm Pickup';

        // Show delivery modal
        const deliveryModal = new bootstrap.Modal(document.getElementById('deliveryModal'));
        deliveryModal.show();
    }

    // Process delivery
    function processDelivery() {
        if (!currentService) return;

        // Get delivery method
        const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;

        // Validate form based on delivery method
        if (deliveryMethod === 'pickup') {
            const pickupPerson = document.getElementById('pickupPerson').value;
            const pickupTime = document.getElementById('pickupTime').value;

            if (!pickupPerson) {
                showToast('Please enter pickup person name', 'error');
                return;
            }

            if (!pickupTime) {
                showToast('Please select pickup time', 'error');
                return;
            }
        } else {
            const deliveryAddress = document.getElementById('deliveryAddress').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const deliveryContact = document.getElementById('deliveryContact').value;

            if (!deliveryAddress) {
                showToast('Please enter delivery address', 'error');
                return;
            }

            if (!deliveryDate) {
                showToast('Please select delivery date', 'error');
                return;
            }

            if (!deliveryContact) {
                showToast('Please enter contact number', 'error');
                return;
            }
        }

        // Show loading state
        const confirmBtn = document.getElementById('confirmDeliveryBtn');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div> Processing...';

        // Close delivery modal
        const deliveryModal = bootstrap.Modal.getInstance(document.getElementById('deliveryModal'));
        deliveryModal.hide();

        // Build delivery request
        const deliveryRequest = {
            serviceId: currentServiceId,
            deliveryType: deliveryMethod,
            notes: "Processed by admin"
        };

        // Add delivery details based on method
        if (deliveryMethod === 'pickup') {
            deliveryRequest.pickupPerson = document.getElementById('pickupPerson').value;
            deliveryRequest.pickupTime = document.getElementById('pickupTime').value;
        } else {
            deliveryRequest.deliveryAddress = document.getElementById('deliveryAddress').value;
            deliveryRequest.deliveryDate = document.getElementById('deliveryDate').value;
            deliveryRequest.contactNumber = document.getElementById('deliveryContact').value;
        }

        // Get token
        const token = getAuthToken();

        // Call API to process delivery
        fetch('/admin/api/vehicle-tracking/process-delivery', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(deliveryRequest)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to process delivery');
                }
                return response.json();
            })
            .then(data => {
                // Reset button state
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = `<i class="fas fa-check-circle"></i> ${deliveryMethod === 'pickup' ? 'Confirm Pickup' : 'Confirm Delivery'}`;

                // Update service status
                if (currentService) {
                    currentService.isDelivered = true;
                    currentService.delivered = true;
                }

                // Refresh table
                loadCompletedServices();

                // Show success message
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                document.getElementById('successTitle').textContent = 'Delivery Scheduled';
                document.getElementById('successMessage').textContent = deliveryMethod === 'pickup' ?
                    'Vehicle pickup has been scheduled successfully' :
                    'Vehicle delivery has been scheduled successfully';
                successModal.show();
            })
            .catch(error => {
                // Reset button state
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = `<i class="fas fa-check-circle"></i> ${deliveryMethod === 'pickup' ? 'Confirm Pickup' : 'Confirm Delivery'}`;

                console.error('Error processing delivery:', error);
                showToast('Error processing delivery: ' + error.message, 'error');
            });
    }

    // Show toast notification
    function showToast(message, type = 'success') {
        const toastContainer = document.querySelector('.toast-container');

        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'success'} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');

        toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;

        toastContainer.appendChild(toastEl);

        const toast = new bootstrap.Toast(toastEl, {
            autohide: true,
            delay: 3000
        });

        toast.show();

        // Remove from DOM after hiding
        toastEl.addEventListener('hidden.bs.toast', function () {
            toastEl.remove();
        });
    }
</script>
</body>
</html>