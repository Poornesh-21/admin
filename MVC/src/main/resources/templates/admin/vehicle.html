<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Albany Motors - Vehicle Tracking</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts - Baloo Bhaijaan 2 -->
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --dutch-white: #EFFBBB; /* Dutch White */
            --dutch-white-light: #f5ffd4;
            --dutch-white-dark: #d6e297;
            --dutch-white-darker: #bfca85;
            --wine: #722F37; /* Wine */
            --wine-light: #8a3943;
            --wine-dark: #5e262e;
            --wine-darker: #491d23;
            --wine-gradient: linear-gradient(145deg, #722F37 0%, #5e262e 100%);
            --wine-gradient-hover: linear-gradient(145deg, #8a3943 0%, #722F37 100%);
            --dutch-white-gradient: linear-gradient(145deg, #EFFFBB 0%, #d6e297 100%);
            --white: #ffffff;
            --light-bg: #f8f9fa;
            --light-gray: #e9ecef;
            --medium-gray: #adb5bd;
            --dark-gray: #495057;
            --danger: #ef5350;
            --warning: #ffca28;
            --success: #66bb6a;
            --info: #42a5f5;

            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.1);
            --shadow-xl: 0 12px 24px rgba(0,0,0,0.15);

            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 1rem;

            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            font-family: 'Baloo Bhaijaan 2', sans-serif;
            background-color: #f8f9fa;
            color: var(--dark-gray);
            min-height: 100vh;
            scroll-behavior: smooth;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--wine);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--wine-light);
        }

        .app-container {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: var(--wine-gradient);
            color: var(--white);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
        }

        .sidebar-header {
            padding: 1.75rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h2 {
            margin-bottom: 0;
            font-weight: 700;
            color: var(--white);
            font-size: 1.75rem;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .sidebar-content::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.75rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu-item {
            padding: 0 0.75rem;
            margin-bottom: 0.25rem;
        }

        .sidebar-menu-link {
            display: flex;
            align-items: center;
            padding: 0.85rem 1rem;
            color: rgba(255, 255, 255, 0.95);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: var(--transition);
            position: relative;
        }

        .sidebar-menu-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .sidebar-menu-link.active {
            background-color: var(--dutch-white-light);
            color: var(--wine);
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-menu-link.active::before {
            content: '';
            position: absolute;
            left: -0.75rem;
            top: 50%;
            transform: translateY(-50%);
            height: 2rem;
            width: 4px;
            background-color: var(--dutch-white-dark);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .sidebar-menu-link i {
            width: 1.5rem;
            text-align: center;
            font-size: 1.1rem;
            margin-right: 0.75rem;
        }

        .sidebar-menu-link span {
            font-size: 1rem;
            font-weight: 500;
            color: inherit;
        }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--white);
        }

        .user-role {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: var(--radius-md);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            transition: var(--transition);
            color: var(--dark-gray);
        }

        /* Header Styles */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            position: relative;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .header-left h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--wine);
            margin-bottom: 0.5rem;
            position: relative;
            letter-spacing: 1px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
        }

        .header-subtitle {
            font-size: 1rem;
            color: var(--medium-gray);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
        }

        /* Premium Button */
        .btn-premium {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn-premium::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            transition: all 0.4s ease;
            z-index: -1;
        }

        .btn-premium:hover::after {
            width: 100%;
        }

        .btn-premium.primary {
            background: var(--wine-gradient);
            color: white;
        }

        .btn-premium.primary:hover {
            box-shadow: 0 6px 15px rgba(114, 47, 55, 0.3);
            transform: translateY(-2px);
        }

        .btn-premium.secondary {
            background-color: var(--white);
            color: var(--wine);
        }

        .btn-premium.secondary:hover {
            background-color: var(--light-bg);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        /* Search Box */
        .search-box {
            position: relative;
            max-width: 400px;
            margin-bottom: 2rem;
        }

        .search-input {
            padding: 1rem 1rem 1rem 3rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--radius-lg);
            width: 100%;
            font-size: 1rem;
            color: var(--dark-gray);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--wine);
            box-shadow: 0 0 0 4px rgba(114, 47, 55, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--medium-gray);
            pointer-events: none;
        }

        /* Tabs Section */
        .tabs-section {
            margin-bottom: 2rem;
        }

        .nav-tabs {
            border-bottom: none;
            gap: 1rem;
        }

        .nav-tabs .nav-item {
            margin-bottom: 0;
        }

        .nav-tabs .nav-link {
            color: var(--dark-gray);
            font-weight: 600;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: var(--radius-lg);
            background-color: var(--light-bg);
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-tabs .nav-link:hover:not(.active) {
            background-color: var(--light-gray);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .nav-tabs .nav-link.active {
            color: var(--white);
            background: var(--wine-gradient);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .nav-tabs .nav-link .count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            color: inherit;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .nav-tabs .nav-link.active .count-badge {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Table Section */
        .table-section {
            background-color: var(--white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            transition: var(--transition);
            border: 1px solid rgba(114, 47, 55, 0.1);
        }

        .table-section:hover {
            box-shadow: 0 15px 30px rgba(114, 47, 55, 0.15), 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .table-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--wine);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .table-title i {
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--dutch-white-light);
            color: var(--wine);
            border-radius: var(--radius-sm);
        }

        .table-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .search-box-sm {
            position: relative;
        }

        .search-input-sm {
            padding: 0.65rem 1rem 0.65rem 2.5rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--radius-lg);
            width: 250px;
            font-size: 0.9rem;
            color: var(--dark-gray);
            transition: var(--transition);
        }

        .search-input-sm:focus {
            outline: none;
            border-color: var(--wine-light);
            box-shadow: 0 0 0 3px rgba(114, 47, 55, 0.1);
        }

        .search-icon-sm {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--medium-gray);
            pointer-events: none;
        }

        .premium-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .premium-table thead th {
            background-color: var(--bg-light);
            color: var(--dark-gray);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1.25rem 1rem;
            border-bottom: 1px solid var(--light-gray);
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .premium-table tbody td {
            padding: 1.25rem 1rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--light-gray);
            font-size: 0.95rem;
        }

        .premium-table tbody tr:last-child td {
            border-bottom: none;
        }

        .premium-table tbody tr {
            transition: var(--transition);
            cursor: pointer;
        }

        .premium-table tbody tr:hover {
            background-color: rgba(114, 47, 55, 0.05);
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.85rem;
            font-weight: 500;
            line-height: 1;
        }

        .status-received {
            background-color: rgba(255, 202, 40, 0.15);
            color: #d68000;
        }

        .status-received i {
            color: var(--warning);
        }

        .status-diagnosis {
            background-color: rgba(66, 165, 245, 0.15);
            color: #0069c0;
        }

        .status-diagnosis i {
            color: var(--info);
        }

        .status-repair {
            background-color: rgba(255, 87, 51, 0.15);
            color: #ff3c00;
        }

        .status-repair i {
            color: #ff3c00;
        }

        .status-completed {
            background-color: rgba(102, 187, 106, 0.15);
            color: #00701a;
        }

        .status-completed i {
            color: var(--success);
        }

        .status-pending {
            background-color: rgba(255, 202, 40, 0.15);
            color: #d68000;
        }

        .status-pending i {
            color: var(--warning);
        }

        .status-paid {
            background-color: rgba(102, 187, 106, 0.15);
            color: #00701a;
        }

        .status-paid i {
            color: var(--success);
        }

        .status-dispatched {
            background-color: rgba(156, 39, 176, 0.15);
            color: #7b1fa2;
        }

        .status-dispatched i {
            color: #7b1fa2;
        }

        /* Vehicle Info Cell Styles */
        .vehicle-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .vehicle-icon {
            width: 2.5rem;
            height: 2.5rem;
            background-color: var(--dutch-white-light);
            color: var(--wine);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: var(--transition);
        }

        .vehicle-details {
            display: flex;
            flex-direction: column;
        }

        .vehicle-details h5 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--wine);
        }

        .vehicle-details p {
            font-size: 0.8rem;
            color: var(--medium-gray);
            margin: 0;
        }

        .person-info {
            display: flex;
            flex-direction: column;
        }

        .person-details h5 {
            font-size: 0.85rem; /* Reduced size as requested */
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--wine);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px; /* Limit width to prevent table expansion */
        }

        .person-details p {
            font-size: 0.75rem;
            color: var(--medium-gray);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px; /* Limit width to prevent table expansion */
        }

        /* Membership Badge */
        .membership-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .membership-standard {
            background-color: rgba(66, 165, 245, 0.15);
            color: var(--info);
        }

        .membership-premium {
            background: linear-gradient(to right, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.3));
            color: #b8860b;
        }

        /* Table Action Buttons */
        .table-actions-cell {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .btn-table-action {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--white);
            color: var(--wine);
            border: 1px solid var(--light-gray);
            border-radius: 50%;
            font-size: 0.85rem;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .btn-table-action:hover {
            background-color: var(--light-bg);
            border-color: var(--wine-light);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .btn-table-action.success {
            background-color: rgba(102, 187, 106, 0.1);
            color: #00701a;
            border-color: rgba(102, 187, 106, 0.3);
        }

        .btn-table-action.warning {
            background-color: rgba(255, 202, 40, 0.1);
            color: #d68000;
            border-color: rgba(255, 202, 40, 0.3);
        }

        .btn-table-action.info {
            background-color: rgba(66, 165, 245, 0.1);
            color: #0069c0;
            border-color: rgba(66, 165, 245, 0.3);
        }

        .btn-action {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-lg);
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid var(--light-gray);
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .btn-action.success {
            background-color: rgba(102, 187, 106, 0.1);
            color: #00701a;
            border-color: rgba(102, 187, 106, 0.3);
        }

        .btn-action.success:hover {
            background-color: rgba(102, 187, 106, 0.2);
            border-color: rgba(102, 187, 106, 0.5);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-action.warning {
            background-color: rgba(255, 202, 40, 0.1);
            color: #d68000;
            border-color: rgba(255, 202, 40, 0.3);
        }

        .btn-action.warning:hover {
            background-color: rgba(255, 202, 40, 0.2);
            border-color: rgba(255, 202, 40, 0.5);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-action.info {
            background-color: rgba(66, 165, 245, 0.1);
            color: #0069c0;
            border-color: rgba(66, 165, 245, 0.3);
        }

        .btn-action.info:hover {
            background-color: rgba(66, 165, 245, 0.2);
            border-color: rgba(66, 165, 245, 0.5);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }

        .pagination {
            display: flex;
            gap: 0.35rem;
            background-color: white;
            border-radius: 50px;
            padding: 0.5rem;
            box-shadow: var(--shadow-lg);
        }

        .page-item .page-link {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: var(--dark-gray);
            font-weight: 500;
            border: none;
            transition: var(--transition);
            background-color: transparent;
        }

        .page-item .page-link:hover {
            background-color: var(--light-gray);
        }

        .page-item.active .page-link {
            background-color: var(--wine);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .page-item.disabled .page-link {
            color: var(--medium-gray);
            pointer-events: none;
            opacity: 0.6;
        }

        /* Modal Styles - Premium */
        .modal-premium .modal-content {
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .modal-premium .modal-header {
            background: var(--wine-gradient);
            color: white;
            border-bottom: none;
            padding: 1.75rem 2rem;
            position: relative;
        }

        .modal-premium .modal-title {
            font-weight: 700;
            font-size: 1.35rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-premium .modal-title i {
            width: 2.5rem;
            height: 2.5rem;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .modal-premium .modal-body {
            padding: 2.5rem;
        }

        .modal-premium .modal-footer {
            padding: 1.5rem 2.5rem;
            border-top: 1px solid var(--light-gray);
            background-color: rgba(248, 249, 250, 0.5);
        }

        .modal-premium .btn-close {
            background: rgba(255, 255, 255, 0.2) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23FFF'%3E%3Cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3E%3C/svg%3E") center/1em auto no-repeat;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            opacity: 0.8;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .modal-premium .btn-close:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Service Details */
        .service-detail-row {
            display: flex;
            flex-wrap: nowrap;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
            width: 100%;
            overflow-x: auto;
        }

        .service-detail-col {
            flex: 1 0 auto;
            min-width: 180px;
            padding-right: 1.5rem;
        }

        .detail-label {
            font-size: 0.85rem;
            color: var(--medium-gray);
            margin-bottom: 0.35rem;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .materials-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1.5rem;
            background-color: var(--light-bg);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .materials-table th {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--dark-gray);
            padding: 0.75rem 1rem;
            text-align: left;
            background-color: var(--light-bg);
            border-bottom: 1px solid var(--light-gray);
        }

        .materials-table td {
            font-size: 0.9rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .materials-table tr:last-child td {
            border-bottom: none;
        }

        .materials-table tbody tr:last-child {
            background-color: rgba(102, 187, 106, 0.05);
            font-weight: 600;
        }

        /* Labor Charges Table */
        .labor-charges-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1.5rem;
            background-color: var(--light-bg);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .labor-charges-table th {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--dark-gray);
            padding: 0.75rem 1rem;
            text-align: left;
            background-color: var(--light-bg);
            border-bottom: 1px solid var(--light-gray);
        }

        .labor-charges-table td {
            font-size: 0.9rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .labor-charges-table tr:last-child td {
            border-bottom: none;
        }

        .invoice-summary {
            background-color: var(--light-bg);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .invoice-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .invoice-summary-row:last-child {
            margin-bottom: 0;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--light-gray);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .invoice-summary-label {
            color: var(--dark-gray);
        }

        .invoice-summary-value {
            color: var(--wine);
        }

        /* Albany Spinner */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .spinner-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .spinner-container {
            position: relative;
            width: 120px;
            height: 120px;
            perspective: 300px;
        }

        .albany-spinner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            animation: spin 3s infinite cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .spinner-letter {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 72px;
            font-weight: 800;
            color: var(--wine);
            text-shadow: 0 0 5px rgba(114, 47, 55, 0.3);
            backface-visibility: hidden;
            transform: rotateY(0deg) translateZ(60px);
        }

        .spinner-circle {
            position: absolute;
            top: -10px;
            left: -10px;
            width: calc(100% + 20px);
            height: calc(100% + 20px);
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: var(--wine);
            border-bottom-color: var(--dutch-white);
            animation: spin-reverse 1.5s linear infinite;
        }

        .spinner-circle:nth-child(2) {
            top: -5px;
            left: -5px;
            width: calc(100% + 10px);
            height: calc(100% + 10px);
            border-top-color: var(--dutch-white);
            border-bottom-color: var(--wine);
            animation-duration: 2s;
        }

        .spinner-text {
            position: absolute;
            bottom: -40px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: var(--wine);
        }

        @keyframes spin {
            0% {
                transform: rotateY(0deg);
            }
            25% {
                transform: rotateY(90deg);
            }
            50% {
                transform: rotateY(180deg);
            }
            75% {
                transform: rotateY(270deg);
            }
            100% {
                transform: rotateY(360deg);
            }
        }

        @keyframes spin-reverse {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Success Modal */
        .success-modal .modal-content {
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            background-color: var(--white);
            position: relative;
        }

        .success-modal .modal-body {
            padding: 3.5rem 2.5rem;
            text-align: center;
            position: relative;
        }

        .success-modal .modal-body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 15px;
            background: var(--wine-gradient);
        }

        .success-icon-container {
            margin-bottom: 2rem;
            position: relative;
            display: inline-flex;
        }

        .success-icon-wrapper {
            width: 8rem;
            height: 8rem;
            border-radius: 50%;
            background: linear-gradient(145deg, rgba(102, 187, 106, 0.15), rgba(102, 187, 106, 0.05));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 187, 106, 0.6);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(102, 187, 106, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 187, 106, 0);
            }
        }

        .success-icon {
            width: 6rem;
            height: 6rem;
            border-radius: 50%;
            background-color: var(--success);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: 0 10px 30px rgba(102, 187, 106, 0.3);
            animation: scale-in 0.5s ease-out;
        }

        @keyframes scale-in {
            0% {
                transform: scale(0);
            }
            80% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        .success-modal .success-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 1rem;
        }

        .success-modal .success-message {
            font-size: 1.1rem;
            color: var(--medium-gray);
            margin-bottom: 2rem;
            line-height: 1.6;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        .success-modal .continue-btn {
            padding: 1rem 3rem;
            font-size: 1.1rem;
            border-radius: var(--radius-lg);
            background: var(--wine-gradient);
            color: white;
            border: none;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        .success-modal .continue-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(114, 47, 55, 0.2);
        }

        /* Footer */
        .app-footer {
            margin-top: 3rem;
            padding-bottom: 2rem;
        }

        .footer-content {
            background: var(--wine-gradient);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            color: white;
            text-align: center;
        }

        .footer-text {
            margin: 0;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .footer-brand {
            font-weight: 600;
            color: var(--dutch-white-light);
        }

        /* Mobile menu toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1060;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: var(--wine-gradient);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(114, 47, 55, 0.25);
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .mobile-menu-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(114, 47, 55, 0.3);
        }

        /* Toast Notification */
        .toast-container {
            z-index: 1070;
        }
        .bg-wine {
            background-color: #722F37;
        }
        .toast {
            opacity: 0.95;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.2);
        }

        /* Steps indicator for completed services workflow */
        .workflow-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }

        .workflow-steps::before {
            content: '';
            position: absolute;
            top: 24px;
            left: 30px;
            right: 30px;
            height: 2px;
            background-color: var(--light-gray);
            z-index: 1;
        }

        .workflow-step {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .step-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--light-bg);
            border: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
            color: var(--medium-gray);
            font-size: 1.25rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .step-text {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--medium-gray);
            text-align: center;
            transition: all 0.3s ease;
        }

        .workflow-step.active .step-icon {
            background-color: var(--wine);
            border-color: var(--wine);
            color: white;
            box-shadow: 0 0 0 5px rgba(114, 47, 55, 0.2);
        }

        .workflow-step.active .step-text {
            color: var(--wine);
            font-weight: 600;
        }

        .workflow-step.completed .step-icon {
            background-color: var(--success);
            border-color: var(--success);
            color: white;
        }

        .workflow-step.completed .step-text {
            color: var(--success);
        }

        /* Responsive Design */
        @media (max-width: 991.98px) {
            .sidebar {
                width: 5rem;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            }

            .sidebar-header h2,
            .sidebar-menu-link span,
            .user-info,
            .nav-section-title,
            .logout-btn span {
                display: none;
            }

            .sidebar-menu-link {
                justify-content: center;
                padding: 0.75rem;
            }

            .sidebar-menu-link i {
                margin-right: 0;
                font-size: 1.25rem;
            }

            .sidebar-menu-link.active::before {
                left: -0.5rem;
            }

            .sidebar-footer {
                justify-content: center;
                padding: 1rem;
            }

            .logout-btn {
                padding: 0.5rem;
                justify-content: center;
            }

            .main-content {
                margin-left: 5rem;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-left h1 {
                font-size: 2rem;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .table-actions {
                width: 100%;
                justify-content: space-between;
            }

            .search-box-sm {
                width: 100%;
            }

            .search-input-sm {
                width: 100%;
            }

            .workflow-steps {
                overflow-x: auto;
                padding-bottom: 1rem;
            }

            .workflow-step {
                min-width: 100px;
            }
        }

        @media (max-width: 767.98px) {
            .sidebar {
                z-index: 1050;
            }

            .table-section {
                overflow-x: auto;
            }

            .premium-table {
                min-width: 1000px;
            }

            .mobile-menu-toggle {
                display: flex;
            }

            .sidebar {
                width: 0;
                transform: translateX(-100%);
            }

            .sidebar.active {
                width: 280px;
                transform: translateX(0);
            }

            .sidebar.active .sidebar-header h2,
            .sidebar.active .sidebar-menu-link span,
            .sidebar.active .user-info,
            .sidebar.active .nav-section-title,
            .sidebar.active .logout-btn span {
                display: block;
            }

            .sidebar.active .sidebar-menu-link {
                justify-content: flex-start;
                padding: 0.85rem 1rem;
            }

            .sidebar.active .sidebar-menu-link i {
                margin-right: 0.75rem;
            }

            .sidebar.active .logout-btn {
                padding: 0.5rem 1rem;
                justify-content: space-between;
            }

            .main-content {
                margin-left: 0;
            }

            .page-header {
                padding-top: 4rem;
            }

            .nav-tabs {
                flex-direction: column;
                gap: 0.5rem;
            }

            .nav-tabs .nav-link {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 575.98px) {
            .main-content {
                padding: 1rem;
            }

            .page-header {
                margin-bottom: 1.5rem;
            }

            .header-left h1 {
                font-size: 1.75rem;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.75rem;
                width: 100%;
            }

            .btn-premium {
                width: 100%;
                justify-content: center;
            }

            .search-box {
                max-width: 100%;
            }

            .service-detail-row {
                flex-direction: column;
            }

            .service-detail-col {
                width: 100%;
                padding-right: 0;
                margin-bottom: 1rem;
            }

            .workflow-steps {
                margin-bottom: 1.5rem;
            }

            .workflow-step .step-text {
                font-size: 0.75rem;
            }
        }

        /* Hide all table rows except the first 5 by default */
        .premium-table tbody tr {
            display: none;
        }

        .premium-table tbody tr.active-page {
            display: table-row;
        }
    </style>
</head>
<body>
<!-- Albany Spinner Overlay -->
<div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner-container">
        <div class="albany-spinner">
            <div class="spinner-letter">A</div>
            <div class="spinner-circle"></div>
            <div class="spinner-circle"></div>
        </div>
        <div class="spinner-text">Loading...</div>
    </div>
</div>

<!-- Mobile Menu Toggle Button -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
</button>

<div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Albany</h2>
        </div>

        <div class="sidebar-content">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/dashboard}" class="sidebar-menu-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/service-requests}" class="sidebar-menu-link">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Service Requests</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/vehicles}" class="sidebar-menu-link active">
                            <i class="fas fa-car"></i>
                            <span>Vehicles</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/customers}" class="sidebar-menu-link">
                            <i class="fas fa-users"></i>
                            <span>Customers</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/service-advisors}" class="sidebar-menu-link">
                            <i class="fas fa-user-tie"></i>
                            <span>Service Advisors</span>
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a th:href="@{/admin/inventory}" class="sidebar-menu-link">
                            <i class="fas fa-boxes"></i>
                            <span>Inventory</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-name">Arthur Morgan</div>
                <div class="user-role">Administrator</div>
            </div>
            <button class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <header class="page-header">
            <div class="header-left">
                <h1>Vehicle Tracking</h1>
                <div class="header-subtitle">
                    <i class="fas fa-car"></i>
                    Track vehicles in service and completed services
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-premium primary" data-bs-toggle="modal" data-bs-target="#filterVehiclesModal">
                    <i class="fas fa-filter"></i>
                    Filter Vehicles
                </button>
            </div>
        </header>

        <!-- Search Box -->
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="Search by vehicle, registration number, customer...">
            <i class="fas fa-search search-icon"></i>
        </div>

        <!-- Tabs Section -->
        <div class="tabs-section">
            <ul class="nav nav-tabs" id="vehiclesTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="under-service-tab" data-bs-toggle="tab" data-bs-target="#under-service-tab-pane" type="button" role="tab" aria-controls="under-service-tab-pane" aria-selected="true">
                        <i class="fas fa-tools"></i>
                        Vehicles Under Service
                        <span class="count-badge" id="underServiceCount">12</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed-tab-pane" type="button" role="tab" aria-controls="completed-tab-pane" aria-selected="false">
                        <i class="fas fa-check-circle"></i>
                        Completed Services
                        <span class="count-badge" id="completedCount">8</span>
                    </button>
                </li>
            </ul>
        </div>

        <div class="tab-content" id="vehiclesTabsContent">
            <!-- Vehicles Under Service Tab -->
            <div class="tab-pane fade show active" id="under-service-tab-pane" role="tabpanel" aria-labelledby="under-service-tab" tabindex="0">
                <!-- Vehicles Under Service Table -->
                <section class="table-section">
                    <div class="table-header">
                        <h3 class="table-title">
                            <i class="fas fa-tools"></i>
                            Vehicles Under Service
                        </h3>
                        <div class="table-actions">
                            <div class="search-box-sm">
                                <input type="text" class="search-input-sm" placeholder="Filter vehicles...">
                                <i class="fas fa-search search-icon-sm"></i>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="premium-table" id="vehiclesUnderServiceTable">
                            <thead>
                            <tr>
                                <th>Service ID</th>
                                <th>Vehicle</th>
                                <th>Customer</th>
                                <th>Membership</th>
                                <th>Service Type</th>
                                <th>Service Advisor</th>
                                <th>Start Date</th>
                                <th>Est. Completion</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="vehiclesUnderServiceTableBody">
                            <!-- Will be populated dynamically via JavaScript -->
                            <tr id="loading-row-service">
                                <td colspan="10" class="text-center py-4">
                                    <div class="spinner-border text-wine" role="status"></div>
                                    <p class="mt-2">Loading vehicles under service...</p>
                                </td>
                            </tr>
                            <tr id="empty-row-service" style="display: none;">
                                <td colspan="10" class="text-center py-4">
                                    <div class="my-5">
                                        <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                                        <h5>No vehicles currently under service</h5>
                                        <p class="text-muted">All vehicles have been serviced or no service requests have been created</p>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-container">
                        <ul class="pagination" id="paginationService">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" id="prevBtnService" aria-label="Previous">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#" data-page="1">1</a></li>
                            <li class="page-item"><a class="page-link" href="#" data-page="2">2</a></li>
                            <li class="page-item"><a class="page-link" href="#" data-page="3">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#" id="nextBtnService" aria-label="Next">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </section>
            </div>

            <!-- Completed Services Tab -->
            <div class="tab-pane fade" id="completed-tab-pane" role="tabpanel" aria-labelledby="completed-tab" tabindex="0">
                <!-- Completed Services Table -->
                <section class="table-section">
                    <div class="table-header">
                        <h3 class="table-title">
                            <i class="fas fa-check-circle"></i>
                            Completed Services
                        </h3>
                        <div class="table-actions">
                            <div class="search-box-sm">
                                <input type="text" class="search-input-sm" placeholder="Filter completed services...">
                                <i class="fas fa-search search-icon-sm"></i>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="premium-table" id="completedServicesTable">
                            <thead>
                            <tr>
                                <th>Service ID</th>
                                <th>Vehicle</th>
                                <th>Customer</th>
                                <th>Membership</th>
                                <th>Service Type</th>
                                <th>Completion Date</th>
                                <th>Total Amount</th>
                                <th>Invoice Status</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="completedServicesTableBody">
                            <!-- Will be populated dynamically via JavaScript -->
                            <tr id="loading-row-completed">
                                <td colspan="10" class="text-center py-4">
                                    <div class="spinner-border text-wine" role="status"></div>
                                    <p class="mt-2">Loading completed services...</p>
                                </td>
                            </tr>
                            <tr id="empty-row-completed" style="display: none;">
                                <td colspan="10" class="text-center py-4">
                                    <div class="my-5">
                                        <i class="fas fa-check-circle fa-3x text-muted mb-3"></i>
                                        <h5>No completed services found</h5>
                                        <p class="text-muted">Once services are completed, they will appear here</p>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-container">
                        <ul class="pagination" id="paginationCompleted">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" id="prevBtnCompleted" aria-label="Previous">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#" data-page="1">1</a></li>
                            <li class="page-item"><a class="page-link" href="#" data-page="2">2</a></li>
                            <li class="page-item"><a class="page-link" href="#" data-page="3">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#" id="nextBtnCompleted" aria-label="Next">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </section>
            </div>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-content">
                <p class="footer-text">
                    &copy; 2025 <span class="footer-brand">Albany</span>. All Rights Reserved.
                </p>
            </div>
        </footer>
    </main>
</div>

<!-- Filter Vehicles Modal -->
<div class="modal fade modal-premium" id="filterVehiclesModal" tabindex="-1" aria-labelledby="filterVehiclesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterVehiclesModalLabel">
                    <i class="fas fa-filter"></i>
                    Filter Vehicles
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="filterVehiclesForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="filterByVehicleType" class="form-label">Vehicle Type</label>
                            <select class="form-select" id="filterByVehicleType">
                                <option value="">All Types</option>
                                <option value="Car">Car</option>
                                <option value="Bike">Bike</option>
                                <option value="Truck">Truck</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="filterByServiceType" class="form-label">Service Type</label>
                            <select class="form-select" id="filterByServiceType">
                                <option value="">All Service Types</option>
                                <option value="Oil Change">Oil Change</option>
                                <option value="Brake Service">Brake Service</option>
                                <option value="Tire Rotation">Tire Rotation</option>
                                <option value="Engine Repair">Engine Repair</option>
                                <option value="Transmission Service">Transmission Service</option>
                                <option value="Regular Maintenance">Regular Maintenance</option>
                                <option value="Battery Replacement">Battery Replacement</option>
                                <option value="Diagnostics">Diagnostics</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="filterByStatus" class="form-label">Status</label>
                            <select class="form-select" id="filterByStatus">
                                <option value="">All Statuses</option>
                                <option value="Received">Received</option>
                                <option value="Diagnosis">Diagnosis</option>
                                <option value="Repair">Repair</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="filterByPaymentStatus" class="form-label">Payment Status</label>
                            <select class="form-select" id="filterByPaymentStatus">
                                <option value="">All Payment Statuses</option>
                                <option value="Pending">Pending</option>
                                <option value="Paid">Paid</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="filterDateFrom" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="filterDateFrom">
                        </div>
                        <div class="col-md-6">
                            <label for="filterDateTo" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="filterDateTo">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-premium primary" id="applyFilterBtn">
                    <i class="fas fa-check"></i>
                    Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Service Details Modal -->
<div class="modal fade modal-premium" id="viewServiceDetailsModal" tabindex="-1" aria-labelledby="viewServiceDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewServiceDetailsModalLabel">
                    <i class="fas fa-info-circle"></i>
                    Service Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Service ID</div>
                        <div class="detail-value" id="viewServiceId">REQ-1001</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Status</div>
                        <div class="detail-value" id="viewStatus">
                            <span class="status-badge status-repair">
                                <i class="fas fa-wrench"></i> Repair
                            </span>
                        </div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Start Date</div>
                        <div class="detail-value" id="viewStartDate">April 10, 2025</div>
                    </div>
                </div>

                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Vehicle</div>
                        <div class="detail-value" id="viewVehicleName">Honda City</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Registration Number</div>
                        <div class="detail-value" id="viewRegistrationNumber">MH02AB1234</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Vehicle Category</div>
                        <div class="detail-value" id="viewVehicleCategory">Car</div>
                    </div>
                </div>

                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Customer</div>
                        <div class="detail-value" id="viewCustomerName">Rajesh Kumar</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Contact</div>
                        <div class="detail-value" id="viewCustomerContact">+91 98765 43210</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Membership</div>
                        <div class="detail-value" id="viewMembership">Premium</div>
                    </div>
                </div>

                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Service Type</div>
                        <div class="detail-value" id="viewServiceType">Engine Repair</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Estimated Completion</div>
                        <div class="detail-value" id="viewEstimatedCompletion">April 15, 2025</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Service Advisor</div>
                        <div class="detail-value" id="viewServiceAdvisor">Amit Sharma</div>
                    </div>
                </div>

                <div>
                    <div class="detail-label">Service Description</div>
                    <div class="detail-value" id="viewServiceDescription">
                        <p>Vehicle is showing check engine light and making unusual noise when accelerating.</p>
                    </div>
                </div>

                <div class="mt-4" id="progressSection">
                    <h5>Work Progress</h5>
                    <div class="progress mt-2" style="height: 20px;">
                        <div class="progress-bar bg-wine" role="progressbar" style="width: 65%;" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100">65%</div>
                    </div>
                    <p class="text-muted mt-2" id="viewProgressNotes">Current work: Replacing engine timing components and testing.</p>
                </div>

                <div id="materialsSection" style="display: none;">
                    <h5 class="mt-4 mb-3">Materials Used</h5>
                    <table class="materials-table" id="materialsTable">
                        <thead>
                        <tr>
                            <th>Item</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                        </thead>
                        <tbody id="materialsTableBody">
                        <!-- Will be populated dynamically -->
                        </tbody>
                    </table>

                    <h5 class="mt-4 mb-3">Labor Charges</h5>
                    <table class="labor-charges-table" id="laborChargesTable">
                        <thead>
                        <tr>
                            <th>Description</th>
                            <th>Hours</th>
                            <th>Rate/Hour</th>
                            <th>Total</th>
                        </tr>
                        </thead>
                        <tbody id="laborChargesTableBody">
                        <!-- Will be populated dynamically -->
                        </tbody>
                    </table>

                    <div class="invoice-summary">
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">Materials Total</div>
                            <div class="invoice-summary-value" id="summaryMaterialsTotal">7,250.00</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">Labor Total</div>
                            <div class="invoice-summary-value" id="summaryLaborTotal">3,600.00</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">Subtotal</div>
                            <div class="invoice-summary-value" id="summarySubtotal">10,850.00</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">GST (18%)</div>
                            <div class="invoice-summary-value" id="summaryGST">1,953.00</div>
                        </div>
                        <div class="invoice-summary-row">
                            <div class="invoice-summary-label">Grand Total</div>
                            <div class="invoice-summary-value" id="summaryGrandTotal">12,803.00</div>
                        </div>
                    </div>
                </div>

                <!-- Workflow steps for completed services -->
                <div id="workflowStepsContainer" style="display: none;" class="mt-4">
                    <h5 class="mb-3">Service Workflow</h5>
                    <div class="workflow-steps">
                        <div class="workflow-step" id="stepInvoice">
                            <div class="step-icon">
                                <i class="fas fa-file-invoice"></i>
                            </div>
                            <div class="step-text">Generate Invoice</div>
                        </div>
                        <div class="workflow-step" id="stepPayment">
                            <div class="step-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="step-text">Payment</div>
                        </div>
                        <div class="workflow-step" id="stepDelivery">
                            <div class="step-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="step-text">Dispatch</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="underServiceFooter">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn-premium primary" id="updateStatusBtn">
                    <i class="fas fa-edit"></i>
                    Update Status
                </button>
            </div>
            <div class="modal-footer" id="completedServiceFooter" style="display: none;">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Close</button>
                <!-- Dynamic buttons will be added based on service status -->
            </div>
        </div>
    </div>
</div>

<!-- Generate Invoice Modal -->
<div class="modal fade modal-premium" id="generateInvoiceModal" tabindex="-1" aria-labelledby="generateInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateInvoiceModalLabel">
                    <i class="fas fa-file-invoice"></i>
                    Generate Invoice
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success mb-4">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="invoiceAlertMessage">Service has been completed for <strong id="invoiceCustomerName">Rajesh Kumar</strong>. Please generate an official invoice.</span>
                </div>

                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Service ID</div>
                        <div class="detail-value" id="invoiceServiceId">REQ-1001</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Vehicle</div>
                        <div class="detail-value" id="invoiceVehicleName">Honda City</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Registration Number</div>
                        <div class="detail-value" id="invoiceRegistrationNumber">MH02AB1234</div>
                    </div>
                </div>

                <div class="service-detail-row">
                    <div class="service-detail-col">
                        <div class="detail-label">Service Type</div>
                        <div class="detail-value" id="invoiceServiceType">Engine Repair</div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Customer</div>
                        <div class="detail-value">
                            <span id="invoiceCustomerFullName">Rajesh Kumar</span>
                            <span id="premiumBadge" class="membership-badge membership-premium ms-2" style="display: none;">
                                <i class="fas fa-crown"></i> Premium
                            </span>
                        </div>
                    </div>
                    <div class="service-detail-col">
                        <div class="detail-label">Completed Date</div>
                        <div class="detail-value" id="invoiceCompletionDate">April 15, 2025</div>
                    </div>
                </div>

                <div class="invoice-summary">
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">Materials Total</div>
                        <div class="invoice-summary-value" id="invoiceMaterialsTotal">7,250.00</div>
                    </div>
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">Labor Total</div>
                        <div class="invoice-summary-value" id="invoiceLaborTotal">3,600.00</div>
                    </div>
                    <!-- Premium discount row will be added here dynamically if customer is premium -->
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">Subtotal</div>
                        <div class="invoice-summary-value" id="invoiceSubtotal">10,850.00</div>
                    </div>
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">GST (18%)</div>
                        <div class="invoice-summary-value" id="invoiceGST">1,953.00</div>
                    </div>
                    <div class="invoice-summary-row">
                        <div class="invoice-summary-label">Grand Total</div>
                        <div class="invoice-summary-value" id="invoiceGrandTotal">12,803.00</div>
                    </div>
                </div>

                <div class="form-group mt-4">
                    <label for="invoiceNotes" class="form-label">Additional Notes</label>
                    <textarea class="form-control" id="invoiceNotes" rows="3" placeholder="Add any notes to be included in the invoice"></textarea>
                </div>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" value="" id="sendInvoiceEmail" checked>
                    <label class="form-check-label" for="sendInvoiceEmail">
                        Send invoice to customer via email
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-premium primary" id="confirmGenerateInvoiceBtn">
                    <i class="fas fa-file-invoice"></i>
                    Generate & Send Invoice
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade modal-premium" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">
                    <i class="fas fa-money-bill-wave"></i>
                    Process Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    Processing payment for service <strong id="paymentServiceId">REQ-1001</strong> for <strong id="paymentCustomerName">Rajesh Kumar</strong>.
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="detail-label">Vehicle</div>
                        <div class="detail-value" id="paymentVehicleName">Honda City</div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-label">Total Amount</div>
                        <div class="detail-value fw-bold text-wine" id="paymentAmount">12,803.00</div>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="paymentMethod" class="form-label">Payment Method</label>
                    <select class="form-select" id="paymentMethod" required>
                        <option value="">Select Payment Method</option>
                        <option value="UPI">UPI</option>
                        <option value="Card">Credit/Debit Card</option>
                        <option value="Net Banking">Net Banking</option>
                        <option value="Cash">Cash</option>
                    </select>
                </div>

                <div class="form-group mb-3">
                    <label for="transactionId" class="form-label">Transaction ID</label>
                    <input type="text" class="form-control" id="transactionId" placeholder="Enter transaction ID">
                    <small class="form-text text-muted">Enter transaction ID or reference number (if applicable)</small>
                </div>

                <div class="form-group mb-3">
                    <label for="paidAmount" class="form-label">Amount Received</label>
                    <div class="input-group">
                        <span class="input-group-text"></span>
                        <input type="number" class="form-control" id="paidAmount" placeholder="Enter amount" required>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="paymentNotes" class="form-label">Payment Notes</label>
                    <textarea class="form-control" id="paymentNotes" rows="2" placeholder="Optional notes about this payment"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-premium primary" id="confirmPaymentBtn">
                    <i class="fas fa-check-circle"></i>
                    Confirm Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Vehicle Delivery/Dispatch Modal -->
<div class="modal fade modal-premium" id="deliveryModal" tabindex="-1" aria-labelledby="deliveryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deliveryModalLabel">
                    <i class="fas fa-truck"></i>
                    Vehicle Delivery
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="deliveryModalInfo">Arrange delivery for completed service <strong id="deliveryServiceId">REQ-1001</strong></span>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="detail-label">Vehicle</div>
                        <div class="detail-value" id="deliveryVehicleName">Honda City</div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-label">Registration Number</div>
                        <div class="detail-value" id="deliveryRegistrationNumber">MH02AB1234</div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label">Delivery Method</label>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="deliveryMethod" id="customerPickup" value="pickup" checked>
                        <label class="form-check-label" for="customerPickup">
                            <i class="fas fa-user me-2"></i> Customer Pickup
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deliveryMethod" id="homeDelivery" value="delivery">
                        <label class="form-check-label" for="homeDelivery">
                            <i class="fas fa-home me-2"></i> Home Delivery
                        </label>
                    </div>
                </div>

                <div id="pickupFields">
                    <div class="form-group mb-3">
                        <label for="pickupPerson" class="form-label">Person Collecting Vehicle</label>
                        <input type="text" class="form-control" id="pickupPerson" placeholder="Enter name of person collecting the vehicle">
                        <small class="form-text text-muted">This person must present valid ID</small>
                    </div>

                    <div class="form-group mb-3">
                        <label for="pickupTime" class="form-label">Expected Pickup Time</label>
                        <input type="datetime-local" class="form-control" id="pickupTime">
                    </div>
                </div>

                <div id="deliveryFields" style="display: none;">
                    <div class="form-group mb-3">
                        <label for="deliveryAddress" class="form-label">Delivery Address</label>
                        <textarea class="form-control" id="deliveryAddress" rows="3" placeholder="Enter delivery address"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="deliveryDate" class="form-label">Delivery Date</label>
                                <input type="date" class="form-control" id="deliveryDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="deliveryTimeSlot" class="form-label">Time Slot</label>
                                <select class="form-select" id="deliveryTimeSlot">
                                    <option value="">Select time slot</option>
                                    <option value="9AM-12PM">9:00 AM - 12:00 PM</option>
                                    <option value="12PM-3PM">12:00 PM - 3:00 PM</option>
                                    <option value="3PM-6PM">3:00 PM - 6:00 PM</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="deliveryContact" class="form-label">Contact Number</label>
                        <input type="tel" class="form-control" id="deliveryContact" placeholder="Enter contact number for delivery">
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="deliveryNotes" class="form-label">Delivery Notes</label>
                    <textarea class="form-control" id="deliveryNotes" rows="2" placeholder="Any special instructions for delivery or pickup"></textarea>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmDeliveryCheck" required>
                    <label class="form-check-label" for="confirmDeliveryCheck">
                        I confirm that all service work has been completed, invoice generated, and payment has been received
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-premium primary" id="confirmDeliveryBtn">
                    <i class="fas fa-check-circle"></i>
                    <span id="confirmDeliveryBtnText">Confirm Pickup</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade modal-premium" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateStatusModalLabel">
                    <i class="fas fa-sync-alt"></i>
                    Update Service Status
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    You are about to update the status of service <strong id="updateServiceId">REQ-1001</strong>.
                </div>

                <div class="mb-3">
                    <label for="serviceStatusSelect" class="form-label">Select New Status</label>
                    <select class="form-select" id="serviceStatusSelect">
                        <option value="Diagnosis">Diagnosis</option>
                        <option value="Repair">Repair</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>

                <p id="statusUpdateDescription" class="mt-3">
                    This will move the service from <span class="fw-bold text-wine" id="currentStatusText">Received</span>
                    to <span class="fw-bold text-success" id="newStatusText">Diagnosis</span>.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-premium secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-premium primary" id="confirmUpdateStatusBtn">
                    <i class="fas fa-check-circle"></i>
                    Update Status
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade success-modal" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="success-icon-container">
                    <div class="success-icon-wrapper">
                        <div class="success-icon">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                </div>
                <h3 class="success-title" id="successTitle">Success!</h3>
                <p class="success-message" id="successMessage">Operation completed successfully.</p>
                <button type="button" class="continue-btn" data-bs-dismiss="modal">
                    <i class="fas fa-check-circle"></i>
                    Continue
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- jQuery and Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

<script>
    // Vehicle Tracking System JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize app
        initializeApp();

        // Set up event listeners
        setupEventListeners();

        // Load vehicles under service from API
        loadVehiclesUnderServiceFromAPI();

        // Load completed services from API
        loadCompletedServicesFromAPI();
    });

    // Global variables
    let vehiclesUnderService = [];
    let completedServices = [];
    let currentServicePage = 1;
    let currentCompletedPage = 1;
    const itemsPerPage = 5;
    let currentServiceId = null;

    // Get JWT token from storage or URL
    function getJwtToken() {
        // First check URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const tokenFromUrl = urlParams.get('token');

        if (tokenFromUrl) {
            return tokenFromUrl;
        }

        // Then check local storage
        return localStorage.getItem("jwt-token") || sessionStorage.getItem("jwt-token");
    }

    // Initialize app
    function initializeApp() {
        // Setup mobile menu toggle
        setupMobileMenu();

        // Setup logout button
        setupLogout();

        // Setup token-based authentication
        setupAuthentication();

        // Set current date if element exists
        setupDateDisplay();

        // Initialize bill calculation handlers
        initializeBillCalculation();

        // Initialize delivery method toggle
        initializeDeliveryMethodToggle();
    }

    function setupMobileMenu() {
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });
        }
    }

    function setupLogout() {
        const logoutBtn = document.querySelector('.logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                // Show confirmation dialog
                if (confirm('Are you sure you want to logout?')) {
                    // Clear storage
                    localStorage.removeItem("jwt-token");
                    sessionStorage.removeItem("jwt-token");
                    localStorage.removeItem("user-role");
                    localStorage.removeItem("user-name");
                    sessionStorage.removeItem("user-role");
                    sessionStorage.removeItem("user-name");

                    // Redirect to logout
                    window.location.href = '/admin/logout';
                }
            });
        }
    }

    function setupDateDisplay() {
        const dateElement = document.getElementById('current-date');
        if (dateElement) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const today = new Date();
            dateElement.textContent = today.toLocaleDateString('en-US', options);
        }
    }

    // Initialize bill calculation for modal
    function initializeBillCalculation() {
        // Add Material button click
        document.getElementById('addMaterialBtn').addEventListener('click', function() {
            const container = document.getElementById('billMaterialsContainer');
            const newRow = document.querySelector('.bill-material-row').cloneNode(true);

            // Clear inputs in the new row
            newRow.querySelectorAll('input').forEach(input => {
                input.value = '';
                if (input.classList.contains('material-quantity')) {
                    input.value = '1';
                }
            });

            // Add event listeners to the new row inputs
            addMaterialRowEventListeners(newRow);

            // Add remove button functionality
            newRow.querySelector('.remove-material').addEventListener('click', function() {
                newRow.remove();
                updateBillTotals();
            });

            container.appendChild(newRow);
        });

        // Add Labor button click
        document.getElementById('addLaborBtn').addEventListener('click', function() {
            const container = document.getElementById('billLaborContainer');
            const newRow = document.querySelector('.bill-labor-row').cloneNode(true);

            // Clear inputs in the new row
            newRow.querySelectorAll('input').forEach(input => {
                input.value = '';
                if (input.classList.contains('labor-hours')) {
                    input.value = '1';
                }
            });

            // Add event listeners to the new row inputs
            addLaborRowEventListeners(newRow);

            // Add remove button functionality
            newRow.querySelector('.remove-labor').addEventListener('click', function() {
                newRow.remove();
                updateBillTotals();
            });

            container.appendChild(newRow);
        });

        // Add event listeners to initial rows
        document.querySelectorAll('.bill-material-row').forEach(row => {
            addMaterialRowEventListeners(row);
        });

        document.querySelectorAll('.bill-labor-row').forEach(row => {
            addLaborRowEventListeners(row);
        });

        // Add event listeners to initial remove buttons
        document.querySelectorAll('.remove-material').forEach(btn => {
            btn.addEventListener('click', function() {
                if (document.querySelectorAll('.bill-material-row').length > 1) {
                    btn.closest('.bill-material-row').remove();
                    updateBillTotals();
                } else {
                    // Don't remove the last row, just clear it
                    const row = btn.closest('.bill-material-row');
                    row.querySelectorAll('input').forEach(input => {
                        if (!input.classList.contains('material-quantity')) {
                            input.value = '';
                        } else {
                            input.value = '1';
                        }
                    });
                    updateBillTotals();
                }
            });
        });

        document.querySelectorAll('.remove-labor').forEach(btn => {
            btn.addEventListener('click', function() {
                if (document.querySelectorAll('.bill-labor-row').length > 1) {
                    btn.closest('.bill-labor-row').remove();
                    updateBillTotals();
                } else {
                    // Don't remove the last row, just clear it
                    const row = btn.closest('.bill-labor-row');
                    row.querySelectorAll('input').forEach(input => {
                        if (!input.classList.contains('labor-hours')) {
                            input.value = '';
                        } else {
                            input.value = '1';
                        }
                    });
                    updateBillTotals();
                }
            });
        });
    }

    // Add event listeners to material row inputs
    function addMaterialRowEventListeners(row) {
        const quantityInput = row.querySelector('.material-quantity');
        const priceInput = row.querySelector('.material-price');
        const totalInput = row.querySelector('.material-total');

        // Calculate total when quantity or price changes
        function calculateTotal() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = quantity * price;
            totalInput.value = total.toFixed(2);
            updateBillTotals();
        }

        quantityInput.addEventListener('input', calculateTotal);
        priceInput.addEventListener('input', calculateTotal);
    }

    // Add event listeners to labor row inputs
    function addLaborRowEventListeners(row) {
        const hoursInput = row.querySelector('.labor-hours');
        const rateInput = row.querySelector('.labor-rate');
        const totalInput = row.querySelector('.labor-total');

        // Calculate total when hours or rate changes
        function calculateTotal() {
            const hours = parseFloat(hoursInput.value) || 0;
            const rate = parseFloat(rateInput.value) || 0;
            const total = hours * rate;
            totalInput.value = total.toFixed(2);
            updateBillTotals();
        }

        hoursInput.addEventListener('input', calculateTotal);
        rateInput.addEventListener('input', calculateTotal);
    }

    // Update bill totals
    function updateBillTotals() {
        let materialsTotal = 0;
        let laborTotal = 0;

        // Calculate materials total
        document.querySelectorAll('.material-total').forEach(input => {
            materialsTotal += parseFloat(input.value) || 0;
        });

        // Calculate labor total
        document.querySelectorAll('.labor-total').forEach(input => {
            laborTotal += parseFloat(input.value) || 0;
        });

        // Calculate totals
        const subtotal = materialsTotal + laborTotal;
        const gst = subtotal * 0.18;
        const grandTotal = subtotal + gst;

        // Update display
        document.getElementById('billMaterialsTotal').textContent = '' + materialsTotal.toFixed(2);
        document.getElementById('billLaborTotal').textContent = '' + laborTotal.toFixed(2);
        document.getElementById('billSubtotal').textContent = '' + subtotal.toFixed(2);
        document.getElementById('billGST').textContent = '' + gst.toFixed(2);
        document.getElementById('billGrandTotal').textContent = '' + grandTotal.toFixed(2);
    }

    // Initialize delivery method toggle
    function initializeDeliveryMethodToggle() {
        const pickupRadio = document.getElementById('customerPickup');
        const deliveryRadio = document.getElementById('homeDelivery');
        const pickupFields = document.getElementById('pickupFields');
        const deliveryFields = document.getElementById('deliveryFields');
        const confirmDeliveryBtnText = document.getElementById('confirmDeliveryBtnText');

        if (pickupRadio && deliveryRadio) {
            pickupRadio.addEventListener('change', function() {
                if (this.checked) {
                    pickupFields.style.display = '';
                    deliveryFields.style.display = 'none';
                    confirmDeliveryBtnText.textContent = 'Confirm Pickup';
                }
            });

            deliveryRadio.addEventListener('change', function() {
                if (this.checked) {
                    pickupFields.style.display = 'none';
                    deliveryFields.style.display = '';
                    confirmDeliveryBtnText.textContent = 'Confirm Delivery';
                }
            });
        }
    }

    function setupAuthentication() {
        // Get token from storage
        const tokenFromStorage = getJwtToken();

        if (tokenFromStorage) {
            console.log("Token found in storage");

            // Check if current URL already has a token parameter
            const currentUrl = new URL(window.location.href);
            const urlToken = currentUrl.searchParams.get('token');

            // If URL doesn't have the token, update all navigation links
            if (!urlToken) {
                // Add token to all sidebar navigation links
                document.querySelectorAll('.sidebar-menu-link').forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && !href.includes('token=')) {
                        const separator = href.includes('?') ? '&' : '?';
                        link.setAttribute('href', href + separator + 'token=' + encodeURIComponent(tokenFromStorage));
                    }
                });

                // Add token to current URL for refresh protection
                if (window.location.href.indexOf('token=') === -1) {
                    const separator = window.location.href.indexOf('?') === -1 ? '?' : '&';
                    const newUrl = window.location.href + separator + 'token=' + encodeURIComponent(tokenFromStorage);
                    window.history.replaceState({}, document.title, newUrl);
                }
            }
        } else {
            console.warn("No token found in storage");
            // If no token is found, redirect to login
            window.location.href = '/admin/login?error=session_expired';
        }
    }

    function setupEventListeners() {
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab.id === 'under-service-tab-pane') {
                    filterVehiclesUnderService(this.value);
                } else if (activeTab.id === 'completed-tab-pane') {
                    filterCompletedServices(this.value);
                }
            });
        }

        // Table search for Vehicles Under Service
        const serviceTableSearchInput = document.querySelector('#under-service-tab-pane .search-input-sm');
        if (serviceTableSearchInput) {
            serviceTableSearchInput.addEventListener('keyup', function() {
                filterTableRows(this.value, 'vehiclesUnderServiceTable');
            });
        }

        // Table search for Completed Services
        const completedTableSearchInput = document.querySelector('#completed-tab-pane .search-input-sm');
        if (completedTableSearchInput) {
            completedTableSearchInput.addEventListener('keyup', function() {
                filterTableRows(this.value, 'completedServicesTable');
            });
        }

        // Table pagination for Vehicles Under Service
        document.querySelectorAll('#paginationService .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                if (!this.parentElement.classList.contains('disabled')) {
                    const page = this.getAttribute('data-page');
                    if (page) {
                        currentServicePage = parseInt(page);
                        updateServicePagination();
                        showVehiclesUnderServicePage(currentServicePage);
                    }
                }
            });
        });

        // Table pagination for Completed Services
        document.querySelectorAll('#paginationCompleted .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                if (!this.parentElement.classList.contains('disabled')) {
                    const page = this.getAttribute('data-page');
                    if (page) {
                        currentCompletedPage = parseInt(page);
                        updateCompletedPagination();
                        showCompletedServicesPage(currentCompletedPage);
                    }
                }
            });
        });

        // Previous & Next buttons for Vehicles Under Service
        document.getElementById('prevBtnService').addEventListener('click', function(e) {
            e.preventDefault();
            if (currentServicePage > 1) {
                currentServicePage--;
                updateServicePagination();
                showVehiclesUnderServicePage(currentServicePage);
            }
        });

        document.getElementById('nextBtnService').addEventListener('click', function(e) {
            e.preventDefault();
            const totalPages = Math.ceil(vehiclesUnderService.length / itemsPerPage);
            if (currentServicePage < totalPages) {
                currentServicePage++;
                updateServicePagination();
                showVehiclesUnderServicePage(currentServicePage);
            }
        });

        // Previous & Next buttons for Completed Services
        document.getElementById('prevBtnCompleted').addEventListener('click', function(e) {
            e.preventDefault();
            if (currentCompletedPage > 1) {
                currentCompletedPage--;
                updateCompletedPagination();
                showCompletedServicesPage(currentCompletedPage);
            }
        });

        document.getElementById('nextBtnCompleted').addEventListener('click', function(e) {
            e.preventDefault();
            const totalPages = Math.ceil(completedServices.length / itemsPerPage);
            if (currentCompletedPage < totalPages) {
                currentCompletedPage++;
                updateCompletedPagination();
                showCompletedServicesPage(currentCompletedPage);
            }
        });

        // Payment method change handler
        document.getElementById('paymentMethod').addEventListener('change', function() {
            const paymentMethod = this.value;
            const transactionIdGroup = document.getElementById('transactionId').closest('.form-group');

            // Show transaction ID field only for online payment methods
            if (paymentMethod === 'Cash') {
                transactionIdGroup.style.display = 'none';
            } else {
                transactionIdGroup.style.display = '';
            }
        });

        // Payment confirmation
        document.getElementById('confirmPaymentBtn').addEventListener('click', function() {
            processPayment();
        });

        // Invoice generation
        document.getElementById('confirmGenerateInvoiceBtn').addEventListener('click', function() {
            generateInvoice();
        });

        // Delivery confirmation
        document.getElementById('confirmDeliveryBtn').addEventListener('click', function() {
            confirmDelivery();
        });

        // Apply Filter button
        document.getElementById('applyFilterBtn').addEventListener('click', function() {
            applyFilters();
        });

        // Tab change event
        const vehiclesTabs = document.getElementById('vehiclesTabs');
        if (vehiclesTabs) {
            vehiclesTabs.addEventListener('shown.bs.tab', function(e) {
                // Reset search input
                document.getElementById('searchInput').value = '';

                // Update UI based on active tab
                if (e.target.id === 'under-service-tab') {
                    currentServicePage = 1;
                    updateServicePagination();
                    showVehiclesUnderServicePage(currentServicePage);
                } else if (e.target.id === 'completed-tab') {
                    currentCompletedPage = 1;
                    updateCompletedPagination();
                    showCompletedServicesPage(currentCompletedPage);
                }
            });
        }

        // Update Status button click
        document.getElementById('updateStatusBtn').addEventListener('click', function() {
            const serviceId = document.getElementById('viewServiceId').textContent.replace('REQ-', '');
            updateServiceStatus(serviceId);
        });

        // Confirm Update Status button click
        document.getElementById('confirmUpdateStatusBtn').addEventListener('click', function() {
            submitStatusUpdate();
        });
    }

    // Load vehicles under service from API
    function loadVehiclesUnderServiceFromAPI() {
        // Show loading spinner
        document.getElementById('loading-row-service').style.display = '';
        document.getElementById('empty-row-service').style.display = 'none';

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // API call to fetch vehicles under service
        fetch('/admin/api/vehicle-tracking/under-service?token=' + encodeURIComponent(token))
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                vehiclesUnderService = data;

                // Update count
                document.getElementById('underServiceCount').textContent = vehiclesUnderService.length;

                // Hide loading spinner
                document.getElementById('loading-row-service').style.display = 'none';

                // Check if there are vehicles to display
                if (vehiclesUnderService.length > 0) {
                    // Update pagination
                    updateServicePagination();

                    // Show first page
                    showVehiclesUnderServicePage(currentServicePage);
                } else {
                    // Show enhanced empty state with better visuals
                    document.getElementById('empty-row-service').style.display = '';
                    document.getElementById('empty-row-service').innerHTML = `
                <td colspan="10" class="text-center py-5">
                    <div class="my-5">
                        <i class="fas fa-car-alt fa-4x text-muted mb-4" style="opacity: 0.3;"></i>
                        <h4 class="text-wine">No Vehicles Currently Under Service</h4>
                        <p class="text-muted mt-3">
                            There are no vehicles currently undergoing service.
                            <br>Vehicles will appear here when they are received for servicing.
                        </p>
                        <button class="btn-premium primary mt-3" onclick="refreshVehicleData()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh Data
                        </button>
                    </div>
                </td>
                `;
                }
            })
            .catch(error => {
                console.error('Error fetching vehicles under service:', error);
                // Hide loading spinner and show empty state with error
                document.getElementById('loading-row-service').style.display = 'none';
                document.getElementById('empty-row-service').style.display = '';
                document.getElementById('empty-row-service').innerHTML = `
                <td colspan="10" class="text-center py-5">
                    <div class="my-5">
                        <i class="fas fa-exclamation-triangle fa-4x text-danger mb-4"></i>
                        <h4 class="text-danger">Error Loading Vehicles</h4>
                        <p class="text-muted mt-3">
                            We encountered a problem while loading vehicles under service.
                            <br>Error: ${error.message}
                        </p>
                        <button class="btn-premium primary mt-3" onclick="refreshVehicleData()">
                            <i class="fas fa-sync-alt"></i>
                            Try Again
                        </button>
                    </div>
                </td>
            `;
            });
    }

    // Load completed services from API
    function loadCompletedServicesFromAPI() {
        // Show loading spinner
        document.getElementById('loading-row-completed').style.display = '';
        document.getElementById('empty-row-completed').style.display = 'none';

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // API call to fetch completed services
        fetch('/admin/api/vehicle-tracking/completed-services?token=' + encodeURIComponent(token))
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                completedServices = data;

                // Update count
                document.getElementById('completedCount').textContent = completedServices.length;

                // Hide loading spinner
                document.getElementById('loading-row-completed').style.display = 'none';

                // Check if there are services to display
                if (completedServices.length > 0) {
                    // Update pagination
                    updateCompletedPagination();

                    // Show first page
                    showCompletedServicesPage(currentCompletedPage);
                } else {
                    // Show enhanced empty state
                    document.getElementById('empty-row-completed').style.display = '';
                    document.getElementById('empty-row-completed').innerHTML = `
                <td colspan="10" class="text-center py-5">
                    <div class="my-5">
                        <i class="fas fa-check-circle fa-4x text-muted mb-4" style="opacity: 0.3;"></i>
                        <h4 class="text-wine">No Completed Services</h4>
                        <p class="text-muted mt-3">
                            There are no completed services to display.
                            <br>Completed vehicle services will appear here once they're finished.
                        </p>
                        <button class="btn-premium primary mt-3" onclick="refreshVehicleData()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh Data
                        </button>
                    </div>
                </td>
                `;
                }
            })
            .catch(error => {
                console.error('Error fetching completed services:', error);
                // Hide loading spinner and show empty state with error
                document.getElementById('loading-row-completed').style.display = 'none';
                document.getElementById('empty-row-completed').style.display = '';
                document.getElementById('empty-row-completed').innerHTML = `
                <td colspan="10" class="text-center py-5">
                    <div class="my-5">
                        <i class="fas fa-exclamation-triangle fa-4x text-danger mb-4"></i>
                        <h4 class="text-danger">Error Loading Completed Services</h4>
                        <p class="text-muted mt-3">
                            We encountered a problem while loading completed services.
                            <br>Error: ${error.message}
                        </p>
                        <button class="btn-premium primary mt-3" onclick="refreshVehicleData()">
                            <i class="fas fa-sync-alt"></i>
                            Try Again
                        </button>
                    </div>
                </td>
            `;
            });
    }

    // Add a refresh function to reload the data
    function refreshVehicleData() {
        // Show loading state
        document.getElementById('loading-row-service').style.display = '';
        document.getElementById('empty-row-service').style.display = 'none';
        document.getElementById('loading-row-completed').style.display = '';
        document.getElementById('empty-row-completed').style.display = 'none';

        // Refresh both data tables
        loadVehiclesUnderServiceFromAPI();
        loadCompletedServicesFromAPI();

        // Show toast notification
        showToastNotification('Refreshing Data', 'Fetching the latest vehicle service information...');
    }

    // Filter vehicles under service
    function filterVehiclesUnderService(searchText) {
        if (!searchText || searchText.trim() === '') {
            // Reset to show all vehicles
            showVehiclesUnderServicePage(currentServicePage);
            updateServicePagination();
            return;
        }

        searchText = searchText.toLowerCase().trim();

        // Filter vehicles based on search text
        const filteredVehicles = vehiclesUnderService.filter(vehicle => {
            return (
                (vehicle.vehicleName && vehicle.vehicleName.toLowerCase().includes(searchText)) ||
                (vehicle.registrationNumber && vehicle.registrationNumber.toLowerCase().includes(searchText)) ||
                (vehicle.customerName && vehicle.customerName.toLowerCase().includes(searchText)) ||
                (vehicle.serviceType && vehicle.serviceType.toLowerCase().includes(searchText)) ||
                (vehicle.status && vehicle.status.toLowerCase().includes(searchText)) ||
                (vehicle.serviceAdvisorName && vehicle.serviceAdvisorName.toLowerCase().includes(searchText))
            );
        });

        // Display filtered vehicles
        displayVehiclesUnderService(filteredVehicles);

        // Update pagination
        updateServicePagination(filteredVehicles.length);
    }

    // Filter completed services
    function filterCompletedServices(searchText) {
        if (!searchText || searchText.trim() === '') {
            // Reset to show all services
            showCompletedServicesPage(currentCompletedPage);
            updateCompletedPagination();
            return;
        }

        searchText = searchText.toLowerCase().trim();

        // Filter services based on search text
        const filteredServices = completedServices.filter(service => {
            return (
                (service.vehicleName && service.vehicleName.toLowerCase().includes(searchText)) ||
                (service.registrationNumber && service.registrationNumber.toLowerCase().includes(searchText)) ||
                (service.customerName && service.customerName.toLowerCase().includes(searchText)) ||
                (service.serviceType && service.serviceType.toLowerCase().includes(searchText)) ||
                (service.paymentStatus && service.paymentStatus.toLowerCase().includes(searchText))
            );
        });

        // Display filtered services
        displayCompletedServices(filteredServices);

        // Update pagination
        updateCompletedPagination(filteredServices.length);
    }

    // Filter table rows
    function filterTableRows(searchText, tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;

        const rows = table.querySelectorAll('tbody tr');
        if (!rows.length) return;

        searchText = searchText.toLowerCase().trim();

        rows.forEach(row => {
            if (row.id.includes('loading-row') || row.id.includes('empty-row')) {
                return; // Skip loading and empty rows
            }

            const text = row.textContent.toLowerCase();
            if (text.includes(searchText) || !searchText) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Show vehicles under service page
    function showVehiclesUnderServicePage(page) {
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, vehiclesUnderService.length);
        const vehiclesToShow = vehiclesUnderService.slice(startIndex, endIndex);

        displayVehiclesUnderService(vehiclesToShow);
    }

    // Show completed services page
    function showCompletedServicesPage(page) {
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, completedServices.length);
        const servicesToShow = completedServices.slice(startIndex, endIndex);

        displayCompletedServices(servicesToShow);
    }

    // Display vehicles under service
    function displayVehiclesUnderService(vehicles) {
        const tableBody = document.getElementById('vehiclesUnderServiceTableBody');

        // Clear existing rows except loading and empty state rows
        const loadingRow = document.getElementById('loading-row-service');
        const emptyRow = document.getElementById('empty-row-service');

        tableBody.innerHTML = '';
        tableBody.appendChild(loadingRow);
        tableBody.appendChild(emptyRow);

        loadingRow.style.display = 'none';

        // Filter vehicles that have service advisors assigned
        const assignedVehicles = vehicles.filter(vehicle =>
            vehicle.serviceAdvisorName &&
            vehicle.serviceAdvisorName !== 'Not Assigned');

        if (assignedVehicles.length === 0) {
            emptyRow.style.display = '';
            // Update empty state message for clarity
            emptyRow.innerHTML = `
            <td colspan="10" class="text-center py-4">
                <div class="my-5">
                    <i class="fas fa-user-tie fa-3x text-muted mb-3"></i>
                    <h5>No vehicles with assigned service advisors</h5>
                    <p class="text-muted">There are no vehicles currently assigned to service advisors</p>
                </div>
            </td>
        `;
            return;
        }

        emptyRow.style.display = 'none';

        // Add vehicle rows
        assignedVehicles.forEach(vehicle => {
            const row = document.createElement('tr');
            row.setAttribute('data-id', vehicle.requestId);
            row.classList.add('active-page');

            // Format the date strings
            const startDate = new Date(vehicle.startDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            const estimatedCompletion = new Date(vehicle.estimatedCompletionDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            // Status badge removed as per requirements

            // Build the row HTML
            row.innerHTML = `
        <td>REQ-${vehicle.requestId}</td>
        <td>
            <div class="vehicle-info">
                <div class="vehicle-icon">
                    <i class="fas fa-${vehicle.category.toLowerCase() === 'bike' ? 'motorcycle' : 'car'}"></i>
                </div>
                <div class="vehicle-details">
                    <h5>${vehicle.vehicleName}</h5>
                    <p>${vehicle.registrationNumber}</p>
                </div>
            </div>
        </td>
        <td>
            <div class="person-info">
                <h5>${vehicle.customerName}</h5>
            </div>
        </td>
        <td>
            ${vehicle.membershipStatus === 'Premium' ?
                '<span class="membership-badge membership-premium"><i class="fas fa-crown"></i> Premium</span>' :
                '<span class="membership-badge membership-standard"><i class="fas fa-user"></i> Standard</span>'}
        </td>
        <td>${vehicle.serviceType}</td>
        <td>${vehicle.serviceAdvisorName}</td>
        <td>${startDate}</td>
        <td>${estimatedCompletion}</td>
        <td>
            <div class="table-actions-cell">
                <button class="btn-table-action" id="viewServiceBtn" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </td>
    `;

            tableBody.appendChild(row);
        });
    }

    // Display completed services
    function displayCompletedServices(services) {
        const tableBody = document.getElementById('completedServicesTableBody');

        // Clear existing rows except loading and empty state rows
        const loadingRow = document.getElementById('loading-row-completed');
        const emptyRow = document.getElementById('empty-row-completed');

        tableBody.innerHTML = '';
        tableBody.appendChild(loadingRow);
        tableBody.appendChild(emptyRow);

        loadingRow.style.display = 'none';

        if (services.length === 0) {
            emptyRow.style.display = '';
            return;
        }

        emptyRow.style.display = 'none';

        // Add service rows
        services.forEach(service => {
            const row = document.createElement('tr');
            row.setAttribute('data-id', service.serviceId || service.requestId);
            row.classList.add('active-page');

            // Format the date strings
            const completionDate = new Date(service.completedDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            // Format the amount
            const formattedAmount = new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(service.totalCost || 0);

            // Determine service workflow status
            const hasGeneratedInvoice = service.hasInvoice || false;
            const hasCompletedPayment = service.paymentStatus === 'Paid';
            const hasDelivered = service.deliveryStatus === 'Delivered' || service.paymentStatus === 'Dispatched';

            // Create invoice badge
            let invoiceBadge = '';
            if (hasGeneratedInvoice) {
                invoiceBadge = `<span class="status-badge status-completed"><i class="fas fa-file-invoice"></i> Invoice Ready</span>`;
            } else {
                invoiceBadge = `<span class="status-badge status-pending"><i class="fas fa-file-invoice"></i> Pending</span>`;
            }

            // Create membership badge
            let membershipBadge = '';
            if ((service.membershipStatus || 'Standard') === 'Premium') {
                membershipBadge = `<span class="membership-badge membership-premium"><i class="fas fa-crown"></i> Premium</span>`;
            } else {
                membershipBadge = `<span class="membership-badge membership-standard"><i class="fas fa-user"></i> Standard</span>`;
            }

            // Create appropriate action button based on workflow status
            let actionButton = '';
            if (!hasGeneratedInvoice) {
                actionButton = `
                <button class="btn-table-action warning" onclick="viewCompletedServiceDetails(${service.serviceId || service.requestId})" title="Generate Invoice">
                    <i class="fas fa-file-invoice"></i>
                </button>`;
            } else if (!hasCompletedPayment) {
                actionButton = `
                <button class="btn-table-action info" onclick="viewCompletedServiceDetails(${service.serviceId || service.requestId})" title="Process Payment">
                    <i class="fas fa-money-bill-wave"></i>
                </button>`;
            } else if (!hasDelivered) {
                actionButton = `
                <button class="btn-table-action success" onclick="viewCompletedServiceDetails(${service.serviceId || service.requestId})" title="Dispatch Vehicle">
                    <i class="fas fa-truck"></i>
                </button>`;
            } else {
                actionButton = `
                <button class="btn-table-action" onclick="viewCompletedServiceDetails(${service.serviceId || service.requestId})" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>`;
            }

            // Build the row HTML
            row.innerHTML = `
            <td>REQ-${service.serviceId || service.requestId}</td>
            <td>
                <div class="vehicle-info">
                    <div class="vehicle-icon">
                        <i class="fas fa-${(service.category || '').toLowerCase() === 'bike' ? 'motorcycle' : 'car'}"></i>
                    </div>
                    <div class="vehicle-details">
                        <h5>${service.vehicleName}</h5>
                        <p>${service.registrationNumber}</p>
                    </div>
                </div>
            </td>
            <td>
                <div class="person-info">
                    <h5>${service.customerName}</h5>
                </div>
            </td>
            <td>${membershipBadge}</td>
            <td>${service.serviceType || 'Regular Service'}</td>
            <td>${completionDate}</td>
            <td>${formattedAmount}</td>
            <td>${invoiceBadge}</td>
            <td>
                <div class="table-actions-cell">
                    ${actionButton}
                </div>
            </td>
        `;

            tableBody.appendChild(row);
        });
    }

    // Update service pagination
    function updateServicePagination(filteredCount) {
        const totalItems = filteredCount !== undefined ? filteredCount : vehiclesUnderService.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);

        // Update page numbers
        const pagination = document.getElementById('paginationService');
        const pageLinks = pagination.querySelectorAll('.page-link[data-page]');

        // Update visibility of page numbers
        pageLinks.forEach((link, index) => {
            const pageNumber = index + 1;
            const pageItem = link.parentElement;

            if (pageNumber <= totalPages) {
                pageItem.style.display = '';
                pageItem.classList.toggle('active', pageNumber === currentServicePage);
            } else {
                pageItem.style.display = 'none';
            }
        });

        // Update prev/next buttons
        const prevBtn = document.getElementById('prevBtnService');
        const nextBtn = document.getElementById('nextBtnService');

        prevBtn.parentElement.classList.toggle('disabled', currentServicePage === 1);
        nextBtn.parentElement.classList.toggle('disabled', currentServicePage === totalPages || totalPages === 0);
    }

    // Update completed pagination
    function updateCompletedPagination(filteredCount) {
        const totalItems = filteredCount !== undefined ? filteredCount : completedServices.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);

        // Update page numbers
        const pagination = document.getElementById('paginationCompleted');
        const pageLinks = pagination.querySelectorAll('.page-link[data-page]');

        // Update visibility of page numbers
        pageLinks.forEach((link, index) => {
            const pageNumber = index + 1;
            const pageItem = link.parentElement;

            if (pageNumber <= totalPages) {
                pageItem.style.display = '';
                pageItem.classList.toggle('active', pageNumber === currentCompletedPage);
            } else {
                pageItem.style.display = 'none';
            }
        });

        // Update prev/next buttons
        const prevBtn = document.getElementById('prevBtnCompleted');
        const nextBtn = document.getElementById('nextBtnCompleted');

        prevBtn.parentElement.classList.toggle('disabled', currentCompletedPage === 1);
        nextBtn.parentElement.classList.toggle('disabled', currentCompletedPage === totalPages || totalPages === 0);
    }

    // View service details for vehicles under service
    function viewServiceUnderServiceDetails(serviceId) {
        // Show spinner
        document.getElementById('spinnerOverlay').classList.add('show');

        // Store current service ID
        currentServiceId = serviceId;

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Find the vehicle in local data first for initial population
        const vehicle = vehiclesUnderService.find(v => v.requestId === parseInt(serviceId));

        // Fetch service details from API
        fetch(`/admin/api/vehicle-tracking/service-request/${serviceId}?token=${encodeURIComponent(token)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(service => {
                // Merge local data with API response for more complete information
                const mergedService = { ...vehicle, ...service };

                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');

                // Format dates with fallbacks
                const startDate = new Date(mergedService.startDate || mergedService.createdAt || Date.now()).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const estimatedCompletion = new Date(mergedService.estimatedCompletionDate || mergedService.deliveryDate || Date.now()).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Hide completed service footer and show under service footer
                document.getElementById('completedServiceFooter').style.display = 'none';
                document.getElementById('underServiceFooter').style.display = '';
                document.getElementById('workflowStepsContainer').style.display = 'none';

                // Hide materials section since it's still in progress
                document.getElementById('materialsSection').style.display = 'none';
                document.getElementById('progressSection').style.display = '';

                // Update modal content
                document.getElementById('viewServiceId').textContent = 'REQ-' + serviceId;

                // Status badge with fallback
                const status = (mergedService.status || 'Received').toLowerCase();
                let statusBadge = '';
                switch (status) {
                    case 'received':
                        statusBadge = `<span class="status-badge status-received"><i class="fas fa-clock"></i> Received</span>`;
                        break;
                    case 'diagnosis':
                        statusBadge = `<span class="status-badge status-diagnosis"><i class="fas fa-search"></i> Diagnosis</span>`;
                        break;
                    case 'repair':
                        statusBadge = `<span class="status-badge status-repair"><i class="fas fa-wrench"></i> Repair</span>`;
                        break;
                    case 'completed':
                        statusBadge = `<span class="status-badge status-completed"><i class="fas fa-check-circle"></i> Completed</span>`;
                        break;
                    default:
                        statusBadge = `<span class="status-badge status-received"><i class="fas fa-clock"></i> Received</span>`;
                }

                document.getElementById('viewStatus').innerHTML = statusBadge;
                document.getElementById('viewStartDate').textContent = startDate;
                document.getElementById('viewVehicleName').textContent = mergedService.vehicleName || mergedService.vehicleModel || 'Vehicle';
                document.getElementById('viewRegistrationNumber').textContent = mergedService.registrationNumber || 'Not specified';
                document.getElementById('viewVehicleCategory').textContent = mergedService.category || mergedService.vehicleType || 'Car';
                document.getElementById('viewCustomerName').textContent = mergedService.customerName || 'Customer';
                document.getElementById('viewCustomerContact').textContent = mergedService.customerPhone || mergedService.customerEmail || 'Not available';

                // Membership badge
                let membershipBadge = '';
                if ((mergedService.membershipStatus || '') === 'Premium') {
                    membershipBadge = '<span class="membership-badge membership-premium"><i class="fas fa-crown"></i> Premium</span>';
                } else {
                    membershipBadge = '<span class="membership-badge membership-standard"><i class="fas fa-user"></i> Standard</span>';
                }

                document.getElementById('viewMembership').innerHTML = membershipBadge;
                document.getElementById('viewServiceType').textContent = mergedService.serviceType || 'Regular Service';
                document.getElementById('viewEstimatedCompletion').textContent = estimatedCompletion;
                document.getElementById('viewServiceAdvisor').textContent = mergedService.serviceAdvisorName || 'Not Assigned';
                document.getElementById('viewServiceDescription').textContent = mergedService.additionalDescription || 'No description provided.';

                // Progress bar
                const progressBar = document.querySelector('.progress-bar');
                const progressPercentage = calculateProgressPercentage(mergedService.status);
                progressBar.style.width = progressPercentage + '%';
                progressBar.textContent = progressPercentage + '%';
                progressBar.setAttribute('aria-valuenow', progressPercentage);

                document.getElementById('viewProgressNotes').textContent = getProgressNotes(mergedService) || 'No progress notes available.';

                // Show the modal with higher z-index
                const modal = document.getElementById('viewServiceDetailsModal');
                $(modal).modal('show');
                // Force higher z-index after modal is shown
                setTimeout(() => {
                    modal.style.zIndex = "1060";
                    document.querySelector('.modal-backdrop').style.zIndex = "1050";
                }, 100);
            })
            .catch(error => {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');
                console.error('Error fetching service details:', error);
                alert('Failed to load service details: ' + error.message);
            });
    }

    // Calculate progress percentage based on status
    function calculateProgressPercentage(status) {
        switch ((status || '').toLowerCase()) {
            case 'received':
                return 10;
            case 'diagnosis':
                return 40;
            case 'repair':
                return 70;
            case 'completed':
                return 100;
            default:
                return 0;
        }
    }

    // Get progress notes based on service details
    // Get progress notes based on service details
    function getProgressNotes(service) {
        switch ((service.status || '').toLowerCase()) {
            case 'received':
                return 'Vehicle received and awaiting diagnosis. Service advisor will be assigned soon.';
            case 'diagnosis':
                return `Diagnosis in progress by ${service.serviceAdvisorName}. Checking for issues related to ${service.serviceType}.`;
            case 'repair':
                return `Repair work in progress. Estimated completion on ${new Date(service.estimatedCompletionDate || service.deliveryDate).toLocaleDateString()}.`;
            case 'completed':
                return 'Service completed. Vehicle ready for pickup.';
            default:
                return 'Status updates will appear here.';
        }
    }

    // View completed service details
    function viewCompletedServiceDetails(serviceId) {
        // Show spinner
        document.getElementById('spinnerOverlay').classList.add('show');

        // Store current service ID
        currentServiceId = serviceId;

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Fetch service details from API
        fetch(`/admin/api/vehicle-tracking/service-request/${serviceId}?token=${encodeURIComponent(token)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(service => {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');

                const completedService = completedServices.find(s => s.serviceId === parseInt(serviceId) || s.requestId === parseInt(serviceId));
                const mergedService = { ...completedService, ...service };

                // Format dates
                const completionDate = new Date(mergedService.completedDate || Date.now()).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Hide under service footer and show completed service footer
                document.getElementById('underServiceFooter').style.display = 'none';
                document.getElementById('completedServiceFooter').style.display = '';

                // Show workflow steps for completed services
                document.getElementById('workflowStepsContainer').style.display = '';
                document.getElementById('progressSection').style.display = 'none';

                // Show materials section
                document.getElementById('materialsSection').style.display = '';

                // Update modal content
                document.getElementById('viewServiceId').textContent = 'REQ-' + serviceId;

                // Status badge (always Completed for completed services)
                const statusBadge = `<span class="status-badge status-completed"><i class="fas fa-check-circle"></i> Completed</span>`;
                document.getElementById('viewStatus').innerHTML = statusBadge;

                document.getElementById('viewStartDate').textContent = completionDate;
                document.getElementById('viewVehicleName').textContent = mergedService.vehicleName || 'Unknown';
                document.getElementById('viewRegistrationNumber').textContent = mergedService.registrationNumber || 'Unknown';
                document.getElementById('viewVehicleCategory').textContent = mergedService.category || 'Unknown';
                document.getElementById('viewCustomerName').textContent = mergedService.customerName || 'Unknown';
                document.getElementById('viewCustomerContact').textContent = mergedService.customerPhone || mergedService.customerEmail || 'Unknown';

                // Membership badge with accurate status display
                let membershipBadge = '';
                const membershipStatus = mergedService.membershipStatus || 'Standard';

                if (membershipStatus.toLowerCase() === 'premium') {
                    membershipBadge = '<span class="membership-badge membership-premium"><i class="fas fa-crown"></i> Premium</span>';
                } else {
                    membershipBadge = '<span class="membership-badge membership-standard"><i class="fas fa-user"></i> Standard</span>';
                }

                document.getElementById('viewMembership').innerHTML = membershipBadge;
                document.getElementById('viewServiceType').textContent = mergedService.serviceType || 'Regular Service';
                document.getElementById('viewEstimatedCompletion').textContent = completionDate;
                document.getElementById('viewServiceAdvisor').textContent = mergedService.serviceAdvisorName || 'Not Assigned';
                document.getElementById('viewServiceDescription').textContent = mergedService.additionalDescription || 'No description provided.';

                // Populate materials table with premium discount if applicable
                populateSampleMaterialsAndCosts();

                // Update workflow steps display
                updateWorkflowSteps(mergedService);

                // Update action buttons for completed service footer
                updateCompletedServiceActions(mergedService);

                // Show the modal
                $('#viewServiceDetailsModal').modal('show');
            })
            .catch(error => {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');
                console.error('Error fetching completed service details:', error);
                alert('Failed to load service details: ' + error.message);
            });
    }

    // Update workflow steps display - new workflow process
    function updateWorkflowSteps(service) {
        // Determine service workflow status
        const hasGeneratedInvoice = service.hasInvoice || false;
        const hasCompletedPayment = service.paymentStatus === 'Paid';
        const hasDelivered = service.deliveryStatus === 'Delivered' || service.paymentStatus === 'Dispatched';

        // Reset all steps
        document.querySelectorAll('.workflow-step').forEach(step => {
            step.classList.remove('active', 'completed');
        });

        // Update steps based on service status
        if (hasDelivered) {
            // All steps completed
            document.getElementById('stepInvoice').classList.add('completed');
            document.getElementById('stepPayment').classList.add('completed');
            document.getElementById('stepDelivery').classList.add('completed');
        } else if (hasCompletedPayment) {
            // Invoice and payment completed; delivery active
            document.getElementById('stepInvoice').classList.add('completed');
            document.getElementById('stepPayment').classList.add('completed');
            document.getElementById('stepDelivery').classList.add('active');
        } else if (hasGeneratedInvoice) {
            // Invoice completed; payment active
            document.getElementById('stepInvoice').classList.add('completed');
            document.getElementById('stepPayment').classList.add('active');
        } else {
            // No steps completed; invoice active
            document.getElementById('stepInvoice').classList.add('active');
        }
    }

    // Update action buttons for completed service footer
    function updateCompletedServiceActions(service) {
        // Clear existing buttons
        const footerDiv = document.getElementById('completedServiceFooter');
        const closeButton = footerDiv.querySelector('button:first-child');

        // Remove all buttons except close
        const buttons = footerDiv.querySelectorAll('button:not(:first-child)');
        buttons.forEach(button => button.remove());

        // Determine service workflow status
        const hasGeneratedInvoice = service.hasInvoice || false;
        const hasCompletedPayment = service.paymentStatus === 'Paid';
        const hasDelivered = service.deliveryStatus === 'Delivered' || service.paymentStatus === 'Dispatched';

        // Add appropriate buttons based on service status
        if (!hasGeneratedInvoice) {
            // Add Generate Invoice button
            const generateInvoiceBtn = document.createElement('button');
            generateInvoiceBtn.className = 'btn-premium primary';
            generateInvoiceBtn.id = 'generateInvoiceBtn';
            generateInvoiceBtn.innerHTML = '<i class="fas fa-file-invoice"></i> Generate Invoice';
            generateInvoiceBtn.addEventListener('click', openGenerateInvoiceModal);
            footerDiv.appendChild(generateInvoiceBtn);
        } else if (!hasCompletedPayment) {
            // Add Payment button
            const processPaymentBtn = document.createElement('button');
            processPaymentBtn.className = 'btn-premium primary';
            processPaymentBtn.id = 'processPaymentBtn';
            processPaymentBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Process Payment';
            processPaymentBtn.addEventListener('click', openPaymentModal);
            footerDiv.appendChild(processPaymentBtn);
        } else if (!hasDelivered) {
            // Add Dispatch button
            const arrangeDeliveryBtn = document.createElement('button');
            arrangeDeliveryBtn.className = 'btn-premium success';
            arrangeDeliveryBtn.id = 'arrangeDeliveryBtn';
            arrangeDeliveryBtn.innerHTML = '<i class="fas fa-truck"></i> Dispatch Vehicle';
            arrangeDeliveryBtn.addEventListener('click', openDeliveryModal);
            footerDiv.appendChild(arrangeDeliveryBtn);
        }

        // If invoice is generated, add download button
        if (hasGeneratedInvoice) {
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn-action info';
            downloadBtn.id = 'downloadInvoiceBtn';
            downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Invoice';
            downloadBtn.addEventListener('click', downloadInvoice);
            footerDiv.insertBefore(downloadBtn, closeButton.nextSibling);
        }
    }

    // Populate sample materials and costs with premium discount
    function populateSampleMaterialsAndCosts() {
        // Get the service from completedServices array
        const serviceId = currentServiceId;
        const service = completedServices.find(s =>
            s.serviceId === parseInt(serviceId) || s.requestId === parseInt(serviceId));

        // Determine if customer is premium
        const isPremium = service && service.membershipStatus === 'Premium';

        // In a production app, this data would come from the API
        const materialsTableBody = document.getElementById('materialsTableBody');
        materialsTableBody.innerHTML = '';

        // Sample materials data
        const materials = [
            { item: 'Engine Oil', quantity: 4, unitPrice: 850, total: 3400 },
            { item: 'Oil Filter', quantity: 1, unitPrice: 350, total: 350 },
            { item: 'Air Filter', quantity: 1, unitPrice: 650, total: 650 }
        ];

        let materialsTotal = 0;

        // Add material rows
        materials.forEach(material => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${material.item}</td>
            <td>${material.quantity}</td>
            <td>${material.unitPrice.toFixed(2)}</td>
            <td>${material.total.toFixed(2)}</td>
        `;
            materialsTableBody.appendChild(row);
            materialsTotal += material.total;
        });

        // Add materials total row
        const materialsTotalRow = document.createElement('tr');
        materialsTotalRow.innerHTML = `
        <td colspan="3" class="text-end">Materials Total</td>
        <td>${materialsTotal.toFixed(2)}</td>
    `;
        materialsTableBody.appendChild(materialsTotalRow);

        // Sample labor data
        const laborTableBody = document.getElementById('laborChargesTableBody');
        laborTableBody.innerHTML = '';

        // Base labor charges
        const laborCharges = [
            { description: 'Regular Service', hours: 2, ratePerHour: 600, total: 1200 }
        ];

        let laborTotal = 0;
        const discountRate = isPremium ? 0.25 : 0; // 25% discount for premium members

        // Add labor rows
        laborCharges.forEach(labor => {
            const originalTotal = labor.total;
            const discountAmount = originalTotal * discountRate;
            const finalTotal = originalTotal - discountAmount;

            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${labor.description}</td>
            <td>${labor.hours}</td>
            <td>${labor.ratePerHour.toFixed(2)}</td>
            <td>${finalTotal.toFixed(2)}</td>
        `;
            laborTableBody.appendChild(row);
            laborTotal += finalTotal;
        });

        // Add discount row if premium
        if (isPremium) {
            const discountRow = document.createElement('tr');
            const discountAmount = laborCharges.reduce((sum, labor) => sum + (labor.total * discountRate), 0);
            discountRow.innerHTML = `
            <td colspan="3" class="text-end text-success">Premium Membership Discount (25%)</td>
            <td class="text-success">-${discountAmount.toFixed(2)}</td>
        `;
            laborTableBody.appendChild(discountRow);
        }

        // Add labor total row
        const laborTotalRow = document.createElement('tr');
        laborTotalRow.innerHTML = `
        <td colspan="3" class="text-end">Labor Total</td>
        <td>${laborTotal.toFixed(2)}</td>
    `;
        laborTableBody.appendChild(laborTotalRow);

        // Update invoice summary
        const subtotal = materialsTotal + laborTotal;
        const gst = subtotal * 0.18;
        const grandTotal = subtotal + gst;

        // Update invoice summary sections
        document.getElementById('summaryMaterialsTotal').textContent = `${materialsTotal.toFixed(2)}`;
        document.getElementById('summaryLaborTotal').textContent = `${laborTotal.toFixed(2)}`;
        document.getElementById('summarySubtotal').textContent = `${subtotal.toFixed(2)}`;
        document.getElementById('summaryGST').textContent = `${gst.toFixed(2)}`;
        document.getElementById('summaryGrandTotal').textContent = `${grandTotal.toFixed(2)}`;
    }

    // Open Generate Invoice Modal
    function openGenerateInvoiceModal() {
        // Close service details modal
        $('#viewServiceDetailsModal').modal('hide');

        // Get service details
        const serviceId = currentServiceId;
        const service = completedServices.find(s => s.serviceId === parseInt(serviceId) || s.requestId === parseInt(serviceId));

        // Determine if customer is premium
        const isPremium = service && service.membershipStatus === 'Premium';

        // Calculate costs with potential premium discount
        let materialsTotal = service.materialsCost || 7250;
        let laborTotal = service.laborCost || 3600;

        // Apply 25% discount on labor for premium customers
        if (isPremium) {
            const originalLaborTotal = laborTotal;
            laborTotal = originalLaborTotal * 0.75; // 25% off
        }

        const subtotal = materialsTotal + laborTotal;
        const gst = subtotal * 0.18;
        const grandTotal = subtotal + gst;

        // Populate invoice modal fields
        document.getElementById('invoiceServiceId').textContent = 'REQ-' + serviceId;
        document.getElementById('invoiceCustomerName').textContent = service.customerName;
        document.getElementById('invoiceCustomerFullName').textContent = service.customerName;
        document.getElementById('invoiceVehicleName').textContent = service.vehicleName;
        document.getElementById('invoiceRegistrationNumber').textContent = service.registrationNumber;
        document.getElementById('invoiceServiceType').textContent = service.serviceType || 'Regular Service';

        // Update premium badge visibility
        const premiumBadge = document.getElementById('premiumBadge');
        if (isPremium) {
            premiumBadge.style.display = '';
            document.getElementById('invoiceAlertMessage').innerHTML = `
                Service has been completed for <strong>${service.customerName}</strong> (Premium Customer).
                Please generate an official invoice with the 25% labor discount.
            `;
        } else {
            premiumBadge.style.display = 'none';
            document.getElementById('invoiceAlertMessage').innerHTML = `
                Service has been completed for <strong>${service.customerName}</strong>.
                Please generate an official invoice.
            `;
        }

        // Set completion date
        const completionDate = new Date(service.completedDate || Date.now()).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('invoiceCompletionDate').textContent = completionDate;

        // Update invoice amounts with calculated values
        document.getElementById('invoiceMaterialsTotal').textContent = `${materialsTotal.toFixed(2)}`;
        document.getElementById('invoiceLaborTotal').textContent = `${laborTotal.toFixed(2)}`;

        // Remove any existing premium discount row
        const existingDiscountRow = document.querySelector('.premium-discount-row');
        if (existingDiscountRow) {
            existingDiscountRow.remove();
        }

        // Add premium discount note if applicable
        if (isPremium) {
            const discountRow = document.createElement('div');
            discountRow.className = 'invoice-summary-row premium-discount-row';
            discountRow.innerHTML = `
                <div class="invoice-summary-label text-success">Premium Membership Discount (25% off labor)</div>
                <div class="invoice-summary-value text-success">-${(service.laborCost * 0.25 || 900).toFixed(2)}</div>
            `;

            // Insert before subtotal
            const subtotalRow = document.getElementById('invoiceSubtotal').closest('.invoice-summary-row');
            subtotalRow.parentNode.insertBefore(discountRow, subtotalRow);
        }

        document.getElementById('invoiceSubtotal').textContent = `${subtotal.toFixed(2)}`;
        document.getElementById('invoiceGST').textContent = `${gst.toFixed(2)}`;
        document.getElementById('invoiceGrandTotal').textContent = `${grandTotal.toFixed(2)}`;

        // Set default notes with premium mention if applicable
        let invoiceNotes = "Thank you for choosing Albany Motors. Your vehicle has been serviced as per requirements.";
        if (isPremium) {
            invoiceNotes += " As a Premium member, you've received a 25% discount on labor charges.";
        }
        document.getElementById('invoiceNotes').value = invoiceNotes;

        // Show invoice modal
        $('#generateInvoiceModal').modal('show');
    }

    // Function to generate the invoice
    function generateInvoice() {
        // Show spinner
        document.getElementById('spinnerOverlay').classList.add('show');

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Get service ID
        const serviceId = currentServiceId;
        const service = completedServices.find(s => s.serviceId === parseInt(serviceId) || s.requestId === parseInt(serviceId));

        // Determine if customer is premium for discount application
        const isPremium = service && service.membershipStatus === 'Premium';

        // Prepare invoice data with premium discount if applicable
        const invoiceData = {
            notes: document.getElementById('invoiceNotes').value,
            sendEmail: document.getElementById('sendInvoiceEmail').checked,
            applyPremiumDiscount: isPremium // Tell the server to apply premium discount
        };

        // API call to generate invoice
        fetch(`/admin/api/vehicle-tracking/service-request/${serviceId}/invoice?token=${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(invoiceData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');

                // Update the completedServices array to mark invoice as generated
                const serviceIndex = completedServices.findIndex(s =>
                    s.serviceId === parseInt(serviceId) || s.requestId === parseInt(serviceId));

                if (serviceIndex !== -1) {
                    completedServices[serviceIndex].hasInvoice = true;

                    // If premium discount was applied, update the total cost
                    if (isPremium && completedServices[serviceIndex].laborCost) {
                        const discountedLabor = completedServices[serviceIndex].laborCost * 0.75; // 25% off
                        const newTotal = completedServices[serviceIndex].materialsCost + discountedLabor;
                        const withGST = newTotal * 1.18; // Add 18% GST
                        completedServices[serviceIndex].totalCost = withGST;
                    }
                }

                // Hide the invoice modal
                $('#generateInvoiceModal').modal('hide');

                // Show success modal
                document.getElementById('successTitle').textContent = 'Invoice Generated!';
                document.getElementById('successMessage').textContent =
                    `The invoice for service REQ-${serviceId} has been successfully generated${invoiceData.sendEmail ? ' and sent to the customer via email' : ''}.`;
                $('#successModal').modal('show');

                // Refresh the completed services table
                showCompletedServicesPage(currentCompletedPage);
            })
            .catch(error => {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');
                console.error('Error generating invoice:', error);

                // Hide the invoice modal
                $('#generateInvoiceModal').modal('hide');

                // Show error toast
                showToastNotification('Error', 'Failed to generate invoice: ' + error.message);
            });
    }

    // Function to download invoice
    function downloadInvoice() {
        // Get service ID
        const serviceId = currentServiceId;

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Show spinner
        document.getElementById('spinnerOverlay').classList.add('show');

        // Create and set download URL
        const downloadUrl = `/admin/api/vehicle-tracking/invoice/download/${serviceId}?token=${encodeURIComponent(token)}`;

        // Create a temporary anchor element
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = downloadUrl;
        a.target = '_blank';

        // Add to document, click it, and remove it
        document.body.appendChild(a);
        a.click();

        // Hide spinner after a delay to allow download to start
        setTimeout(() => {
            document.getElementById('spinnerOverlay').classList.remove('show');

            // Show success toast
            showToastNotification(
                'Download Started',
                'The invoice is being downloaded to your device.'
            );

            // Remove temporary element
            document.body.removeChild(a);
        }, 1000);
    }

    // Open Payment modal
    function openPaymentModal() {
        // Close service details modal
        $('#viewServiceDetailsModal').modal('hide');

        // Get service details
        const serviceId = currentServiceId;
        const service = completedServices.find(s => s.serviceId === parseInt(serviceId) || s.requestId === parseInt(serviceId));

        // Populate payment modal fields
        document.getElementById('paymentServiceId').textContent = 'REQ-' + serviceId;
        document.getElementById('paymentCustomerName').textContent = service.customerName;
        document.getElementById('paymentVehicleName').textContent = service.vehicleName;
        document.getElementById('paymentAmount').textContent = new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            maximumFractionDigits: 0
        }).format(service.totalCost || 0);

        // Set the default payment amount
        document.getElementById('paidAmount').value = service.totalCost || 0;

        // Reset other fields
        document.getElementById('paymentMethod').value = '';
        document.getElementById('transactionId').value = '';
        document.getElementById('paymentNotes').value = '';

        // Hide transaction ID field initially
        const transactionIdGroup = document.getElementById('transactionId').closest('.form-group');
        transactionIdGroup.style.display = 'none';

        // Show payment modal
        $('#paymentModal').modal('show');
    }

    // Process payment
    function processPayment() {
        // Show spinner
        document.getElementById('spinnerOverlay').classList.add('show');

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Get service ID
        const serviceId = currentServiceId;

        // Validate payment method
        const paymentMethod = document.getElementById('paymentMethod').value;
        if (!paymentMethod) {
            // Hide spinner
            document.getElementById('spinnerOverlay').classList.remove('show');
            showToastNotification('Error', 'Please select a payment method');
            return;
        }

        // Validate amount
        const paidAmount = document.getElementById('paidAmount').value;
        if (!paidAmount || isNaN(parseFloat(paidAmount)) || parseFloat(paidAmount) <= 0) {
            // Hide spinner
            document.getElementById('spinnerOverlay').classList.remove('show');
            showToastNotification('Error', 'Please enter a valid payment amount');
            return;
        }

        // Prepare payment data
        const paymentData = {
            paymentMethod: paymentMethod,
            transactionId: document.getElementById('transactionId').value,
            amount: parseFloat(paidAmount),
            notes: document.getElementById('paymentNotes').value
        };

        // API call to process payment
        fetch(`/admin/api/vehicle-tracking/service-request/${serviceId}/payment?token=${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(paymentData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');

                // Update the completedServices array to mark payment as completed
                const serviceIndex = completedServices.findIndex(s =>
                    s.serviceId === parseInt(serviceId) || s.requestId === parseInt(serviceId));

                if (serviceIndex !== -1) {
                    completedServices[serviceIndex].paymentStatus = 'Paid';
                }

                // Hide the payment modal
                $('#paymentModal').modal('hide');

                // Show success modal
                document.getElementById('successTitle').textContent = 'Payment Processed!';
                document.getElementById('successMessage').textContent =
                    `Payment of ${paymentData.amount.toFixed(2)} for service REQ-${serviceId} has been successfully processed.`;
                $('#successModal').modal('show');

                // Refresh the completed services table
                showCompletedServicesPage(currentCompletedPage);
            })
            .catch(error => {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');
                console.error('Error processing payment:', error);

                // Hide the payment modal
                $('#paymentModal').modal('hide');

                // Show error toast
                showToastNotification('Error', 'Failed to process payment: ' + error.message);
            });
    }

    // Open Delivery modal
    function openDeliveryModal() {
        // Close service details modal
        $('#viewServiceDetailsModal').modal('hide');

        // Get service details
        const serviceId = currentServiceId;
        const service = completedServices.find(s => s.serviceId === parseInt(serviceId) || s.requestId === parseInt(serviceId));

        // Populate delivery modal fields
        document.getElementById('deliveryServiceId').textContent = 'REQ-' + serviceId;
        document.getElementById('deliveryVehicleName').textContent = service.vehicleName;
        document.getElementById('deliveryRegistrationNumber').textContent = service.registrationNumber;

        // Reset delivery form
        document.getElementById('customerPickup').checked = true;
        document.getElementById('homeDelivery').checked = false;
        document.getElementById('pickupFields').style.display = '';
        document.getElementById('deliveryFields').style.display = 'none';
        document.getElementById('confirmDeliveryBtnText').textContent = 'Confirm Pickup';

        document.getElementById('pickupPerson').value = '';
        document.getElementById('pickupTime').value = '';
        document.getElementById('deliveryAddress').value = '';
        document.getElementById('deliveryDate').value = '';
        document.getElementById('deliveryTimeSlot').value = '';
        document.getElementById('deliveryContact').value = '';
        document.getElementById('deliveryNotes').value = '';
        document.getElementById('confirmDeliveryCheck').checked = false;

        // Show delivery modal
        $('#deliveryModal').modal('show');
    }

    // Confirm delivery
    function confirmDelivery() {
        // Show spinner
        document.getElementById('spinnerOverlay').classList.add('show');

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Get service ID
        const serviceId = currentServiceId;

        // Check confirmation checkbox
        if (!document.getElementById('confirmDeliveryCheck').checked) {
            // Hide spinner
            document.getElementById('spinnerOverlay').classList.remove('show');
            showToastNotification('Error', 'Please confirm that all service work has been completed, invoice generated, and payment has been received');
            return;
        }

        // Determine delivery method
        const isPickup = document.getElementById('customerPickup').checked;

        // Validate required fields
        if (isPickup) {
            if (!document.getElementById('pickupPerson').value) {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');
                showToastNotification('Error', 'Please enter the name of the person collecting the vehicle');
                return;
            }
        } else {
            if (!document.getElementById('deliveryAddress').value) {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');
                showToastNotification('Error', 'Please enter the delivery address');
                return;
            }

            if (!document.getElementById('deliveryDate').value) {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');
                showToastNotification('Error', 'Please select a delivery date');
                return;
            }

            if (!document.getElementById('deliveryTimeSlot').value) {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');
                showToastNotification('Error', 'Please select a delivery time slot');
                return;
            }

            if (!document.getElementById('deliveryContact').value) {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');
                showToastNotification('Error', 'Please enter a contact number for delivery');
                return;
            }
        }

        // Prepare delivery data
        const deliveryData = {
            isPickup: isPickup,
            notes: document.getElementById('deliveryNotes').value
        };

        if (isPickup) {
            deliveryData.pickupPerson = document.getElementById('pickupPerson').value;
            deliveryData.pickupTime = document.getElementById('pickupTime').value;
        } else {
            deliveryData.deliveryAddress = document.getElementById('deliveryAddress').value;
            deliveryData.deliveryDate = document.getElementById('deliveryDate').value;
            deliveryData.deliveryTimeSlot = document.getElementById('deliveryTimeSlot').value;
            deliveryData.deliveryContact = document.getElementById('deliveryContact').value;
        }

        // API call to confirm delivery
        fetch(`/admin/api/vehicle-tracking/service-request/${serviceId}/delivery?token=${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(deliveryData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');

                // Update the completedServices array to mark delivery as completed
                const serviceIndex = completedServices.findIndex(s =>
                    s.serviceId === parseInt(serviceId) || s.requestId === parseInt(serviceId));

                if (serviceIndex !== -1) {
                    completedServices[serviceIndex].deliveryStatus = 'Delivered';
                    completedServices[serviceIndex].paymentStatus = 'Dispatched';
                }

                // Hide the delivery modal
                $('#deliveryModal').modal('hide');

                // Show success modal
                document.getElementById('successTitle').textContent = isPickup ? 'Pickup Confirmed!' : 'Delivery Arranged!';
                document.getElementById('successMessage').textContent = isPickup ?
                    `Vehicle pickup for service REQ-${serviceId} has been successfully confirmed.` :
                    `Vehicle delivery for service REQ-${serviceId} has been successfully arranged.`;
                $('#successModal').modal('show');

                // Refresh the completed services table
                showCompletedServicesPage(currentCompletedPage);
            })
            .catch(error => {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');
                console.error('Error confirming delivery:', error);

                // Hide the delivery modal
                $('#deliveryModal').modal('hide');

                // Show error toast
                showToastNotification('Error', 'Failed to confirm delivery: ' + error.message);
            });
    }

    // Update service status
    function updateServiceStatus(serviceId) {
        // Get current status text
        const currentStatusElement = document.getElementById('viewStatus');
        const currentStatusText = currentStatusElement.textContent.trim();
        let currentStatus = '';

        // Get current status value
        if (currentStatusText.includes('Received')) {
            currentStatus = 'Received';
        } else if (currentStatusText.includes('Diagnosis')) {
            currentStatus = 'Diagnosis';
        } else if (currentStatusText.includes('Repair')) {
            currentStatus = 'Repair';
        } else if (currentStatusText.includes('Completed')) {
            currentStatus = 'Completed';
        } else {
            currentStatus = 'Received'; // Default
        }

        // Store current service ID
        currentServiceId = serviceId;

        // Determine recommended next status
        let recommendedStatus = '';
        if (currentStatus === 'Received') {
            recommendedStatus = 'Diagnosis';
        } else if (currentStatus === 'Diagnosis') {
            recommendedStatus = 'Repair';
        } else if (currentStatus === 'Repair') {
            recommendedStatus = 'Completed';
        } else {
            recommendedStatus = 'Diagnosis'; // Default
        }

        // Update the confirmation modal
        document.getElementById('updateServiceId').textContent = 'REQ-' + serviceId;
        document.getElementById('currentStatusText').textContent = currentStatus;
        document.getElementById('newStatusText').textContent = recommendedStatus;

        // Update the status dropdown
        const statusSelect = document.getElementById('serviceStatusSelect');
        statusSelect.value = recommendedStatus;

        // Enable/disable options based on current status
        // Cannot go backward in status
        for (let i = 0; i < statusSelect.options.length; i++) {
            const option = statusSelect.options[i];

            // Disable completed if service is not at least in repair
            if (option.value === 'Completed' && currentStatus !== 'Repair') {
                option.disabled = true;
            }
            // Disable repair if service is not at least in diagnosis
            else if (option.value === 'Repair' && currentStatus === 'Received') {
                option.disabled = true;
            } else {
                option.disabled = false;
            }
        }

        // Update status select change handler
        statusSelect.onchange = function() {
            document.getElementById('newStatusText').textContent = this.value;
        };

        // Hide the view modal and show the update status modal
        $('#viewServiceDetailsModal').modal('hide');

        // Remove modal backdrop and reset body classes before showing new modal
        setTimeout(function() {
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open');
            $('body').css('padding-right', '');
            $('#updateStatusModal').modal('show');
        }, 100);
    }

    // Submit the status update to the server
    function submitStatusUpdate() {
        // Show spinner
        document.getElementById('spinnerOverlay').classList.add('show');

        // Get service ID
        const serviceId = currentServiceId;

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Get the new status
        const newStatus = document.getElementById('serviceStatusSelect').value;

        // Hide confirmation modal
        $('#updateStatusModal').modal('hide');

        // Remove modal backdrop and reset body classes
        setTimeout(function() {
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open');
            $('body').css('padding-right', '');
        }, 100);

        // API call to update status
        fetch(`/admin/api/vehicle-tracking/service-request/${serviceId}/status?token=${encodeURIComponent(token)}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: newStatus
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('API call failed: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');

                // If status is now Completed, move to completed services
                if (newStatus === 'Completed') {
                    // Refresh data from API
                    loadVehiclesUnderServiceFromAPI();
                    loadCompletedServicesFromAPI();
                } else {
                    // Update the status in the vehiclesUnderService array
                    const serviceIndex = vehiclesUnderService.findIndex(v => v.requestId === parseInt(serviceId));
                    if (serviceIndex !== -1) {
                        vehiclesUnderService[serviceIndex].status = newStatus;
                        showVehiclesUnderServicePage(currentServicePage);
                    }
                }

                // Show a brief success toast notification
                showToastNotification('Status Updated!', `Service REQ-${serviceId} status updated to ${newStatus}.`);
            })
            .catch(error => {
                // Hide spinner
                document.getElementById('spinnerOverlay').classList.remove('show');
                console.error('Error updating service status:', error);

                // Show error toast
                showToastNotification('Error', 'Failed to update status: ' + error.message);
            });
    }

    // Apply filters
    function applyFilters() {
        // Get filter values
        const vehicleType = document.getElementById('filterByVehicleType').value;
        const serviceType = document.getElementById('filterByServiceType').value;
        const status = document.getElementById('filterByStatus').value;
        const paymentStatus = document.getElementById('filterByPaymentStatus').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;

        // Get token
        const token = getJwtToken();
        if (!token) {
            console.error('No token found');
            return;
        }

        // Prepare filter criteria
        const filterCriteria = {
            vehicleType: vehicleType || null,
            serviceType: serviceType || null,
            status: status || null,
            paymentStatus: paymentStatus || null,
            dateFrom: dateFrom || null,
            dateTo: dateTo || null
        };

        // Filter active tab data
        const activeTab = document.querySelector('.tab-pane.active');

        if (activeTab.id === 'under-service-tab-pane') {
            // Show loading
            document.getElementById('loading-row-service').style.display = '';
            document.getElementById('empty-row-service').style.display = 'none';

            // API call to filter vehicles under service
            fetch(`/admin/api/vehicle-tracking/under-service/filter?token=${encodeURIComponent(token)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(filterCriteria)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API call failed: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    // Update filtered vehicles
                    vehiclesUnderService = data;

                    // Hide loading
                    document.getElementById('loading-row-service').style.display = 'none';

                    // Display filtered vehicles
                    if (vehiclesUnderService.length > 0) {
                        displayVehiclesUnderService(vehiclesUnderService);
                        updateServicePagination();
                    } else {
                        document.getElementById('empty-row-service').style.display = '';
                    }

                    // Hide filter modal
                    $('#filterVehiclesModal').modal('hide');
                })
                .catch(error => {
                    // Hide loading
                    document.getElementById('loading-row-service').style.display = 'none';
                    document.getElementById('empty-row-service').style.display = '';

                    console.error('Error applying filters to vehicles under service:', error);
                    showToastNotification('Error', 'Failed to apply filters: ' + error.message);
                });

        } else if (activeTab.id === 'completed-tab-pane') {
            // Show loading
            document.getElementById('loading-row-completed').style.display = '';
            document.getElementById('empty-row-completed').style.display = 'none';

            // API call to filter completed services
            fetch(`/admin/api/vehicle-tracking/completed-services/filter?token=${encodeURIComponent(token)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(filterCriteria)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API call failed: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    // Update filtered services
                    completedServices = data;

                    // Hide loading
                    document.getElementById('loading-row-completed').style.display = 'none';

                    // Display filtered services
                    if (completedServices.length > 0) {
                        displayCompletedServices(completedServices);
                        updateCompletedPagination();
                    } else {
                        document.getElementById('empty-row-completed').style.display = '';
                    }

                    // Hide filter modal
                    $('#filterVehiclesModal').modal('hide');
                })
                .catch(error => {
                    // Hide loading
                    document.getElementById('loading-row-completed').style.display = 'none';
                    document.getElementById('empty-row-completed').style.display = '';

                    console.error('Error applying filters to completed services:', error);
                    showToastNotification('Error', 'Failed to apply filters: ' + error.message);
                });
        }
    }

    // Toast notification function
    function showToastNotification(title, message) {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');

        // Create toast element
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-wine border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}</strong> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);

        // Initialize and show the toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {
            animation: true,
            autohide: true,
            delay: 3000
        });

        toast.show();

        // Remove toast after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }

    // Add click event listener to all clickable rows and buttons
    document.addEventListener('click', function(e) {
        // For view vehicle details button in the under service table
        if (e.target && e.target.id === 'viewServiceBtn' || e.target.closest('#viewServiceBtn')) {
            const row = e.target.closest('tr');
            if (row) {
                const serviceId = row.getAttribute('data-id');
                if (serviceId) {
                    // Determine which table this is from
                    const isCompleted = row.closest('#completedServicesTable') !== null;

                    if (isCompleted) {
                        viewCompletedServiceDetails(serviceId);
                    } else {
                        viewServiceUnderServiceDetails(serviceId);
                    }
                }
            }
        }

        // For clicking on a row in either table
        if (e.target && e.target.tagName !== 'BUTTON' && e.target.closest('tr') && !e.target.closest('thead')) {
            const row = e.target.closest('tr');
            if (row.id !== 'loading-row-service' && row.id !== 'empty-row-service' &&
                row.id !== 'loading-row-completed' && row.id !== 'empty-row-completed') {
                const serviceId = row.getAttribute('data-id');
                if (serviceId) {
                    // Determine which table this is from
                    const isCompleted = row.closest('#completedServicesTable') !== null;

                    // Skip if clicking on action buttons or their icons
                    if (e.target.closest('.table-actions-cell') ||
                        e.target.closest('button') ||
                        (e.target.closest('i') && e.target.closest('button'))) {
                        return;
                    }

                    // Only open modal for rows in the service table (not completed service table)
                    if (!isCompleted) {
                        viewServiceUnderServiceDetails(serviceId);
                    }
                    // For completed service table, modal will only open when clicking action buttons
                }
            }
        }
    });
</script>
</body>
</html>